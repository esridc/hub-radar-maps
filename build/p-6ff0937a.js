import{e1 as t,e2 as e,e3 as i,e4 as s,e5 as n,e6 as r,cz as a,al as o,bW as l,dK as h,an as c,ao as u,e7 as d,dc as p,ap as m,am as f,ah as g,ai as v,a as b,e8 as w,e9 as y,cI as _,ea as F,eb as I,ec as A,ed as C,ee as x,ef as M,eg as $,eh as k,ei as E,ej as T,ek as L,el as P,em as O,en as R,eo as V,ep as N,eq as S,er as B,s as j,U as z,dD as D,d3 as q,es as H,b_ as W,bV as U,et as X,eu as Y,ev as Z,aY as G,ew as Q,ex as J,ey as K,ez as tt,eA as et,eB as it,eC as st,eD as nt,eE as rt,eF as at,eG as ot,eH as lt,eI as ht,av as ct,eJ as ut,eK as dt,eL as pt,dE as mt,aW as ft,aZ as gt,di as vt,eM as bt,eN as wt,af as yt,bm as _t,eO as Ft,eP as It,c0 as At,eQ as Ct,X as xt,eR as Mt,eS as $t,eT as kt,eU as Et,eV as Tt,eW as Lt,eX as Pt,y as Ot,aw as Rt,eY as Vt,eZ as Nt,e_ as St,e$ as Bt,f0 as jt,f1 as zt,f2 as Dt,R as qt,f3 as Ht,f4 as Wt,f5 as Ut,f6 as Xt,f7 as Yt,f8 as Zt,f9 as Gt,cl as Qt,fa as Jt,fb as Kt,fc as te,fd as ee,fe as ie,ff as se,cJ as ne}from"./p-3013819f.js";import{E as re}from"./p-bc7fdef1.js";import{a as ae}from"./p-1d19bd96.js";import{s as oe}from"./p-8b19323a.js";import"./p-ad726e47.js";import"./p-3b51db5e.js";import"./p-71d25f62.js";import"./p-a71453e3.js";import"./p-94b15954.js";import"./p-1f0b604e.js";import"./p-347800d3.js";async function le(t,e,i){n(t,e,(()=>[])).push(...i)}async function he(n){const r=new Map;if(!n)return r;if("visualVariables"in n&&n.visualVariables){const e=n.visualVariables.filter((t=>"color"===t.type));for(const i of e){const e=(await t(i)??[]).map((t=>t.color));await le(r,i.field||i.valueExpression,e)}}if("heatmap"===n.type){const t=e(n).map((t=>t.color));await le(r,n.field||n.valueExpression,t)}else if("pie-chart"===n.type){for(const t of n.attributes)await le(r,t.field||t.valueExpression,[t.color]);await le(r,"default",[n?.othersCategory?.color,i(n.backgroundFillSymbol,null)])}else if("dot-density"===n.type){for(const t of n.attributes)await le(r,t.field||t.valueExpression,[t.color]);await le(r,"default",[n.backgroundColor])}else if("unique-value"===n.type)if("predominance"===n.authoringInfo?.type)for(const t of n.uniqueValueInfos??[])await le(r,t.value.toString(),[i(t.symbol,null)]);else{const t=(n.uniqueValueInfos??[]).map((t=>i(t.symbol,null))),{field:e,field2:s,field3:a,valueExpression:o}=n;(e||o)&&await le(r,e||o,t),s&&await le(r,s,t),a&&await le(r,a,t)}else if("class-breaks"===n.type){const t=n.classBreakInfos.map((t=>i(t.symbol,null))),{field:e,valueExpression:s}=n;await le(r,e??s,t)}else"simple"===n.type&&await le(r,"default",[i(n.symbol,null)]);return"defaultSymbol"in n&&n.defaultSymbol&&await le(r,"default",[i(n.defaultSymbol,null)]),r.forEach(((t,e)=>{const i=s(t.filter(Boolean),((t,e)=>JSON.stringify(t)===JSON.stringify(e)));r.set(e,i)})),r}function ce(t,e,i,s){let n=null,r=1e3;"number"==typeof e?(r=e,s=i):(n=e??null,r=i);let a,o=0;const l=()=>{o=0,t.apply(s,a)},h=(...t)=>{n&&n.apply(s,t),a=t,r?o||(o=setTimeout(l,r)):l()};return h.remove=()=>{o&&(clearTimeout(o),o=0)},h.forceUpdate=()=>{o&&(clearTimeout(o),l())},h.hasPendingUpdates=()=>!!o,h}function ue(t,e){return{type:r(e),value:t,unit:e}}function de(t,e){return{type:r(e),value:t,unit:e}}function pe(t,e,i="arithmetic"){return{type:r(e),value:t,unit:e,rotationType:i}}ue(0,"meters");de(0,"square-meters");pe(0,"radians");pe(0,"degrees");pe(0,"degrees","geographic");const me=["B","kB","MB","GB","TB"];function fe(t,e){let i=0===(e=Math.round(e))?0:Math.floor(Math.log(e)/Math.log(re.KILOBYTES));i=o(i,0,me.length-1);const s=l(e/re.KILOBYTES**i,{maximumFractionDigits:2});return a(t.units.bytes[me[i]],{fileSize:s})}const ge={editing:!1,operations:{add:!0,update:!0,delete:!0}},ve=h.ofType(ae);let be=class extends f{constructor(t){super(t),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.capabilities={...ge},this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new ve,this.fileInfos=new h,this.graphic=null,this.mode="view",this.filesEnabled=!1,this.addHandles(g((()=>this.graphic),(()=>this._graphicChanged()),v))}destroy(){this._attachmentLayer=null,this.graphic=null}castCapabilities(t){return{...ge,...t}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){const{graphic:t}=this;if(!t)return!1;const e=t.layer||t.sourceLayer;return e?.loaded&&"capabilities"in e&&e.capabilities&&"operations"in e.capabilities&&"supportsResizeAttachments"in e.capabilities.operations&&e.capabilities.operations.supportsResizeAttachments||!1}async getAttachments(){const{_attachmentLayer:t,attachmentInfos:e}=this;if(!t||"function"!=typeof t.queryAttachments)throw new b("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getObjectId(),s=new w({objectIds:[i],returnMetadata:!0}),n=[],r=t.queryAttachments(s).then((t=>t[i]||n)).catch((()=>n));this._getAttachmentsPromise=r,this.notifyChange("state");const a=await r;return e.removeAll(),a.length&&e.addMany(a),this._getAttachmentsPromise=null,this.notifyChange("state"),a}async addAttachment(t,e=this.graphic){const{_attachmentLayer:i,attachmentInfos:s,capabilities:n}=this;if(!e)throw new b("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:e});if(!t)throw new b("invalid-attachment","addAttachment(): An attachment is required.",{attachment:t});if(!n.operations?.add)throw new b("invalid-capabilities","addAttachment(): add capabilities are required.");if(!i||"function"!=typeof i.addAttachment)throw new b("invalid-layer","addAttachment(): A valid layer is required.");const r=i.addAttachment(e,t).then((t=>this._queryAttachment(t.objectId,e))),a=await r;return s.add(a),a}async deleteAttachment(t){const{_attachmentLayer:e,attachmentInfos:i,graphic:s,capabilities:n}=this;if(!t)throw new b("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!n.operations?.delete)throw new b("invalid-capabilities","deleteAttachment(): delete capabilities are required.");if(!e||"function"!=typeof e.deleteAttachments)throw new b("invalid-layer","deleteAttachment(): A valid layer is required.");if(!s)throw new b("invalid-graphic","deleteAttachment(): A graphic is required.");const r=e.deleteAttachments(s,[t.id]).then((()=>t)),a=await r;return i.remove(a),a}async updateAttachment(t,e=this.activeAttachmentInfo){const{_attachmentLayer:i,attachmentInfos:s,graphic:n,capabilities:r}=this;if(!t)throw new b("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:t});if(!e)throw new b("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!r.operations?.update)throw new b("invalid-capabilities","updateAttachment(): Update capabilities are required.");const a=s.indexOf(e);if(!i||"function"!=typeof i.updateAttachment)throw new b("invalid-layer","updateAttachment(): A valid layer is required.");if(!n)throw new b("invalid-graphic","updateAttachment(): A graphic is required.");const o=i.updateAttachment(n,e.id,t).then((t=>this._queryAttachment(t.objectId))),l=await o;return s.splice(a,1,l),l}async commitFiles(){return await Promise.all(this.fileInfos.items.map((t=>this.addAttachment(t.form)))),this.fileInfos.removeAll(),this.getAttachments()}addFile(t,e){if(!t||!e)return null;const i={file:t,form:e};return this.fileInfos.add(i),i}updateFile(t,e,i=this.activeFileInfo){if(!t||!e||!i)return null;const s=this.fileInfos.indexOf(i);return s>-1&&this.fileInfos.splice(s,1,{file:t,form:e}),this.fileInfos.items[s]}deleteFile(t){const e=this.fileInfos.find((e=>e.file===t));return e?(this.fileInfos.remove(e),e):null}async _queryAttachment(t,e){const{_attachmentLayer:i}=this;if(!t||!i?.queryAttachments)throw new b("invalid-attachment-id","Could not query attachment.");const s=this._getObjectId(e),n=new w({objectIds:[s],attachmentsWhere:`AttachmentId=${t}`,returnMetadata:!0});return i.queryAttachments(n).then((t=>t[s][0]))}_getObjectId(t=this.graphic){return t?.getObjectId()??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch((()=>{})))}_setAttachmentLayer(){const{graphic:t}=this,e=y(t);this._attachmentLayer=e?"scene"===e.type&&null!=e.associatedLayer?e.associatedLayer:e:null}};c([u()],be.prototype,"capabilities",void 0),c([d("capabilities")],be.prototype,"castCapabilities",null),c([u()],be.prototype,"activeAttachmentInfo",void 0),c([u()],be.prototype,"activeFileInfo",void 0),c([u({readOnly:!0,type:ve})],be.prototype,"attachmentInfos",void 0),c([u()],be.prototype,"fileInfos",void 0),c([u({type:p})],be.prototype,"graphic",void 0),c([u()],be.prototype,"mode",void 0),c([u({readOnly:!0})],be.prototype,"state",null),c([u()],be.prototype,"filesEnabled",void 0),c([u({readOnly:!0})],be.prototype,"supportsResizeAttachments",null),be=c([m("esri.widgets.Attachments.AttachmentsViewModel")],be);const we=be;function ye(t){const e=t.toLowerCase();return"image/bmp"===e||"image/emf"===e||"image/exif"===e||"image/gif"===e||"image/x-icon"===e||"image/jpeg"===e||"image/png"===e||"image/tiff"===e||"image/x-wmf"===e}function _e(t){const e=_("esri/themes/base/images/files/");return t?"text/plain"===t?`${e}text-32.svg`:"application/pdf"===t?`${e}pdf-32.svg`:"text/csv"===t?`${e}csv-32.svg`:"application/gpx+xml"===t?`${e}gpx-32.svg`:"application/x-dwf"===t?`${e}cad-32.svg`:"application/postscript"===t||"application/json"===t||"text/xml"===t||"model/vrml"===t?`${e}code-32.svg`:"application/x-zip-compressed"===t||"application/x-7z-compressed"===t||"application/x-gzip"===t||"application/x-tar"===t||"application/x-gtar"===t||"application/x-bzip2"===t||"application/gzip"===t||"application/x-compress"===t||"application/x-apple-diskimage"===t||"application/x-rar-compressed"===t||"application/zip"===t?`${e}zip-32.svg`:t.includes("image/")?`${e}image-32.svg`:t.includes("audio/")?`${e}sound-32.svg`:t.includes("video/")?`${e}video-32.svg`:t.includes("msexcel")||t.includes("ms-excel")||t.includes("spreadsheetml")?`${e}excel-32.svg`:t.includes("msword")||t.includes("ms-word")||t.includes("wordprocessingml")?`${e}word-32.svg`:t.includes("powerpoint")||t.includes("presentationml")?`${e}report-32.svg`:`${e}generic-32.svg`:`${e}generic-32.svg`}const Fe={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},Ie="esri-attachments",Ae={base:Ie,loaderContainer:`${Ie}__loader-container`,loader:`${Ie}__loader`,fadeIn:`${Ie}--fade-in`,container:`${Ie}__container`,containerList:`${Ie}__container--list`,containerPreview:`${Ie}__container--preview`,actions:`${Ie}__actions`,deleteButton:`${Ie}__delete-button`,addAttachmentButton:`${Ie}__add-attachment-button`,errorMessage:`${Ie}__error-message`,items:`${Ie}__items`,item:`${Ie}__item`,itemButton:`${Ie}__item-button`,itemMask:`${Ie}__item-mask`,itemMaskIcon:`${Ie}__item-mask--icon`,itemImage:`${Ie}__image`,itemImageResizable:`${Ie}__image--resizable`,itemLabel:`${Ie}__label`,itemFilename:`${Ie}__filename`,itemChevronIcon:`${Ie}__item-chevron-icon`,itemLink:`${Ie}__item-link`,itemLinkOverlay:`${Ie}__item-link-overlay`,itemLinkOverlayIcon:`${Ie}__item-link-overlay-icon`,itemEditIcon:`${Ie}__item-edit-icon`,itemAddIcon:`${Ie}__item-add-icon`,itemAddButton:`${Ie}__item-add-button`,formNode:`${Ie}__form-node`,fileFieldset:`${Ie}__file-fieldset`,fileLabel:`${Ie}__file-label`,fileName:`${Ie}__file-name`,fileInput:`${Ie}__file-input`,metadata:`${Ie}__metadata`,metadataFieldset:`${Ie}__metadata-fieldset`,progressBar:`${Ie}__progress-bar`},Ce=window.CSS;let xe=class extends I{constructor(t,e){super(t,e),this.displayType="auto",this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=null,this.visibleElements={...Fe},this._supportsImageOrientation=Ce&&Ce.supports&&Ce.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}normalizeCtorArgs(t){return t?.viewModel||(t={viewModel:new we,...t}),t}initialize(){this.addHandles([A((()=>this.viewModel?.attachmentInfos),"change",(()=>this.scheduleRender())),A((()=>this.viewModel?.fileInfos),"change",(()=>this.scheduleRender())),g((()=>this.viewModel?.mode),(()=>this._modeChanged()),v)])}loadDependencies(){return C({icon:()=>import("./p-659ef4de.js")})}get capabilities(){return this.viewModel.capabilities}set capabilities(t){this.viewModel.capabilities=t}get effectiveDisplayType(){const{displayType:t}=this;return t&&"auto"!==t?t:this.viewModel.supportsResizeAttachments?"preview":"list"}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}castVisibleElements(t){return{...Fe,...t}}addAttachment(){const{_addAttachmentForm:t,viewModel:e}=this;return this._set("submitting",!0),this._set("error",null),e.addAttachment(t).then((t=>(this._set("submitting",!1),this._set("error",null),e.mode="view",t))).catch((t=>{throw this._set("submitting",!1),this._set("error",new b("attachments:add-attachment",this.messages.addErrorMessage,t)),t}))}deleteAttachment(t){const{viewModel:e}=this;return this._set("submitting",!0),this._set("error",null),e.deleteAttachment(t).then((t=>(this._set("submitting",!1),this._set("error",null),e.mode="view",t))).catch((t=>{throw this._set("submitting",!1),this._set("error",new b("attachments:delete-attachment",this.messages.deleteErrorMessage,t)),t}))}updateAttachment(){const{viewModel:t}=this,{_updateAttachmentForm:e}=this;return this._set("submitting",!0),this._set("error",null),t.updateAttachment(e).then((e=>(this._set("submitting",!1),this._set("error",null),t.mode="view",e))).catch((t=>{throw this._set("submitting",!1),this._set("error",new b("attachments:update-attachment",this.messages.updateErrorMessage,t)),t}))}addFile(){const t=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",t}updateFile(){const{viewModel:t}=this,e=t.updateFile(this.selectedFile,this._updateAttachmentForm,t.activeFileInfo);return t.mode="view",e}deleteFile(t){const e=this.viewModel.deleteFile(t||this.viewModel.activeFileInfo?.file);return this.viewModel.mode="view",e}render(){const{submitting:t,viewModel:e}=this,{state:i}=e;return x("div",{class:this.classes(Ae.base,M.widget)},t?this._renderProgressBar():null,"loading"===i?this._renderLoading():this._renderAttachments(),this._renderErrorMessage())}_renderErrorMessage(){const{error:t,visibleElements:e}=this;return t&&e.errorMessage?x("div",{class:Ae.errorMessage,key:"error-message"},t.message):null}_renderAttachments(){const{activeFileInfo:t,mode:e,activeAttachmentInfo:i}=this.viewModel;return"add"===e?this._renderAddForm():"edit"===e?this._renderDetailsForm(i||t):this._renderAttachmentContainer()}_renderLoading(){return x("div",{class:Ae.loaderContainer,key:"loader"},x("div",{class:Ae.loader}))}_renderProgressBar(){return this.visibleElements.progressBar?x("div",{class:Ae.progressBar,key:"progress-bar"}):null}_renderAddForm(){const{submitting:t,selectedFile:e}=this,i=t||!e,s=this.visibleElements.cancelAddButton?x("button",{bind:this,class:this.classes(M.button,M.buttonTertiary,M.buttonSmall,M.buttonHalf,t&&M.buttonDisabled),disabled:t,onclick:this._cancelForm,type:"button"},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?x("button",{class:this.classes(M.button,M.buttonSecondary,M.buttonSmall,M.buttonHalf,{[M.buttonDisabled]:i}),disabled:i,type:"submit"},this.messages.add):null,r=e?x("span",{class:Ae.fileName,key:"file-name"},e.name):null,a=x("form",{afterCreate:$,afterRemoved:k,bind:this,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},x("fieldset",{class:Ae.fileFieldset},r,x("label",{class:this.classes(Ae.fileLabel,M.button,M.buttonSecondary)},e?this.messages.changeFile:this.messages.selectFile,x("input",{bind:this,class:Ae.fileInput,name:"attachment",onchange:this._handleFileInputChange,type:"file"}))),n,s);return x("div",{class:Ae.formNode,key:"add-form-container"},a)}_renderDetailsForm(t){const{visibleElements:e,viewModel:i,selectedFile:s,submitting:n}=this,{capabilities:r}=i,a=n||!s;let o,l,h,c;s?(o=s.type,l=s.name,h=s.size):t&&"file"in t?(o=t.file.type,l=t.file.name,h=t.file.size):t&&"contentType"in t&&(o=t.contentType,l=t.name,h=t.size,c=t.url);const u=r.editing&&r.operations?.delete&&e.deleteButton?x("button",{bind:this,class:this.classes(M.button,M.buttonSmall,M.buttonTertiary,Ae.deleteButton,{[M.buttonDisabled]:n}),disabled:n,key:"delete-button",onclick:e=>this._submitDeleteAttachment(e,t),type:"button"},this.messages.delete):void 0,d=r.editing&&r.operations?.update&&e.updateButton?x("button",{class:this.classes(M.button,M.buttonSmall,M.buttonThird,{[M.buttonDisabled]:a}),disabled:a,key:"update-button",type:"submit"},this.messages.update):void 0,p=this.visibleElements.cancelUpdateButton?x("button",{bind:this,class:this.classes(M.button,M.buttonSmall,M.buttonTertiary,M.buttonThird,{[M.buttonDisabled]:n}),disabled:n,key:"cancel-button",onclick:this._cancelForm,type:"button"},this.messages.cancel):void 0,m=r.editing&&r.operations?.update?x("fieldset",{class:Ae.fileFieldset,key:"file"},x("span",{class:Ae.fileName,key:"file-name"},l),x("label",{class:this.classes(Ae.fileLabel,M.button,M.buttonSecondary)},this.messages.changeFile,x("input",{bind:this,class:Ae.fileInput,name:"attachment",onchange:this._handleFileInputChange,type:"file"}))):void 0,f=x("fieldset",{class:Ae.metadataFieldset,key:"size"},x("label",null,fe(this.messagesUnits,h??0))),g=x("fieldset",{class:Ae.metadataFieldset,key:"content-type"},x("label",null,o)),v=null!=c?x("a",{class:Ae.itemLink,href:c,rel:"noreferrer",target:"_blank"},this._renderImageMask(t,400),x("div",{class:Ae.itemLinkOverlay},x("span",{class:Ae.itemLinkOverlayIcon},x("calcite-icon",{icon:"launch"})))):this._renderImageMask(t,400),b=x("form",{afterCreate:$,afterRemoved:k,bind:this,"data-node-ref":"_updateAttachmentForm",onsubmit:e=>this._submitUpdateAttachment(e,t)},x("div",{class:Ae.metadata},f,g),m,x("div",{class:Ae.actions},u,p,d));return x("div",{class:Ae.formNode,key:"edit-form-container"},v,b)}_renderImageMask(t,e){return t?"file"in t?this._renderGenericImageMask(t.file.name,t.file.type):this._renderImageMaskForAttachment(t,e):null}_renderGenericImageMask(t,e){const{supportsResizeAttachments:i}=this.viewModel,s=_e(e),n={[Ae.itemImageResizable]:i};return x("div",{class:this.classes(Ae.itemMaskIcon,Ae.itemMask),key:s},x("img",{alt:t,class:this.classes(n,Ae.itemImage),src:s,title:t}))}_renderImageMaskForAttachment(t,e){const{supportsResizeAttachments:i}=this.viewModel;if(!t)return null;const{contentType:s,name:n,url:r}=t;if(!i||!ye(s))return this._renderGenericImageMask(n,s);const a=this._getCSSTransform(t),o=a?{transform:a,"image-orientation":"none"}:{},l=`${r}${r?.includes("?")?"&":"?"}w=${e}`,h={[Ae.itemImageResizable]:i};return x("div",{class:this.classes(Ae.itemMask),key:l},x("img",{alt:n,class:this.classes(h,Ae.itemImage),src:l,styles:o,title:n}))}_renderFile(t){const{file:e}=t;return x("li",{class:Ae.item,key:e},x("button",{"aria-label":this.messages.attachmentDetails,bind:this,class:Ae.itemButton,key:"details-button",onclick:()=>this._startEditFile(t),title:this.messages.attachmentDetails,type:"button"},this._renderImageMask(t),x("label",{class:Ae.itemLabel},x("span",{class:Ae.itemFilename},e.name||this.messages.noTitle),x("span",{"aria-hidden":"true",class:this.classes(Ae.itemChevronIcon,E(this.container)?T.left:T.right)}))))}_renderAttachmentInfo({attachmentInfo:t,displayType:e}){const{viewModel:i,effectiveDisplayType:s}=this,{capabilities:n,supportsResizeAttachments:r}=i,{contentType:a,name:o,url:l}=t,h=this._renderImageMask(t,"list"===e?48:400),c=n.editing?x("span",{"aria-hidden":"true",class:this.classes(Ae.itemChevronIcon,E(this.container)?T.left:T.right)}):null,u=[h,"preview"===s&&r&&ye(a)?null:x("label",{class:Ae.itemLabel},x("span",{class:Ae.itemFilename},o||this.messages.noTitle),c)],d=n.editing?x("button",{"aria-label":this.messages.attachmentDetails,bind:this,class:Ae.itemButton,"data-attachment-info-id":t.id,key:"details-button",onclick:()=>this._startEditAttachment(t),title:this.messages.attachmentDetails,type:"button"},u):x("a",{class:Ae.itemButton,href:l??void 0,key:"details-link",target:"_blank"},u);return x("li",{class:Ae.item,key:t},d)}_renderAttachmentContainer(){const{effectiveDisplayType:t,viewModel:e,visibleElements:i}=this,{attachmentInfos:s,capabilities:n,fileInfos:r}=e,a=!!s?.length,o=!!r?.length,l={[Ae.containerList]:"preview"!==t,[Ae.containerPreview]:"preview"===t},h=n.editing&&n.operations?.add&&i.addButton?x("button",{bind:this,class:this.classes(M.button,M.buttonTertiary,Ae.addAttachmentButton),onclick:()=>this._startAddAttachment(),type:"button"},x("span",{"aria-hidden":"true",class:this.classes(Ae.itemAddIcon,T.plus)}),this.messages.add):void 0,c=a?x("ul",{class:Ae.items,key:"attachments-list"},s.toArray().map((e=>this._renderAttachmentInfo({attachmentInfo:e,displayType:t})))):void 0,u=o?x("ul",{class:Ae.items,key:"file-list"},r.toArray().map((t=>this._renderFile(t)))):void 0,d=o||a?void 0:x("div",{class:M.empty},this.messages.noAttachments);return x("div",{class:this.classes(Ae.container,l),key:"attachments-container"},c,u,d,h)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(t){const e=t.target,i=e.files?.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(t,e){t.preventDefault(),e&&("file"in e?this.deleteFile(e.file):e&&this.deleteAttachment(e))}_submitAddAttachment(t){t.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()}_submitUpdateAttachment(t,e){t.preventDefault(),e&&"file"in e?this.updateFile():this.updateAttachment()}_startEditAttachment(t){const{viewModel:e}=this;e.activeFileInfo=null,e.activeAttachmentInfo=t,e.mode="edit"}_startEditFile(t){const{viewModel:e}=this;e.activeAttachmentInfo=null,e.activeFileInfo=t,e.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(t){t.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(t){const{orientationInfo:e}=t;return!this._supportsImageOrientation&&e?[e.rotation?`rotate(${e.rotation}deg)`:"",e.mirrored?"scaleX(-1)":""].join(" "):""}};c([u()],xe.prototype,"capabilities",null),c([u()],xe.prototype,"displayType",void 0),c([u({readOnly:!0})],xe.prototype,"effectiveDisplayType",null),c([u()],xe.prototype,"graphic",null),c([u()],xe.prototype,"label",null),c([u(),F("esri/widgets/Attachments/t9n/Attachments")],xe.prototype,"messages",void 0),c([u(),F("esri/core/t9n/Units")],xe.prototype,"messagesUnits",void 0),c([u({readOnly:!0})],xe.prototype,"selectedFile",void 0),c([u({readOnly:!0})],xe.prototype,"submitting",void 0),c([u({readOnly:!0})],xe.prototype,"error",void 0),c([u({type:we})],xe.prototype,"viewModel",void 0),c([u()],xe.prototype,"visibleElements",void 0),c([d("visibleElements")],xe.prototype,"castVisibleElements",null),xe=c([m("esri.widgets.Attachments")],xe);const Me=xe;let $e=class extends we{constructor(t){super(t),this.description=null,this.title=null}};c([u()],$e.prototype,"description",void 0),c([u()],$e.prototype,"title",void 0),$e=c([m("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],$e);const ke=$e;const Ee="esri-feature-element-info",Te={base:Ee,title:`${Ee}__title`,description:`${Ee}__description`};let Le=class extends I{constructor(t,e){super(t,e),this.description=null,this.headingLevel=2,this.title=null}render(){return x("div",{class:Te.base},this._renderTitle(),this._renderDescription())}_renderTitle(){const{title:t}=this;return t?x(L,{class:Te.title,level:this.headingLevel},t):null}_renderDescription(){const{description:t}=this;return t?x("div",{class:Te.description,key:"description"},t):null}};c([u()],Le.prototype,"description",void 0),c([u()],Le.prototype,"headingLevel",void 0),c([u()],Le.prototype,"title",void 0),Le=c([m("esri.widgets.Feature.support.FeatureElementInfo")],Le);const Pe=Le;const Oe={base:"esri-feature-attachments"};let Re=class extends I{constructor(t,e){super(t,e),this._featureElementInfo=null,this.attachmentsWidget=new Me,this.headingLevel=2,this.viewModel=new ke}initialize(){this._featureElementInfo=new Pe,this.addHandles([g((()=>[this.viewModel?.description,this.viewModel?.title,this.headingLevel]),(()=>this._setupFeatureElementInfo()),v),g((()=>this.viewModel),(t=>this.attachmentsWidget.viewModel=t),v)])}destroy(){this.attachmentsWidget.viewModel=null,this.attachmentsWidget.destroy(),this._featureElementInfo?.destroy()}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get displayType(){return this.attachmentsWidget.displayType}set displayType(t){this.attachmentsWidget.displayType=t}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}render(){const{attachmentsWidget:t}=this;return x("div",{class:Oe.base},this._featureElementInfo?.render(),t?.render())}_setupFeatureElementInfo(){const{description:t,title:e,headingLevel:i}=this;this._featureElementInfo?.set({description:t,title:e,headingLevel:i})}};c([u({readOnly:!0})],Re.prototype,"attachmentsWidget",void 0),c([u()],Re.prototype,"description",null),c([u()],Re.prototype,"displayType",null),c([u()],Re.prototype,"graphic",null),c([u()],Re.prototype,"headingLevel",void 0),c([u()],Re.prototype,"title",null),c([u({type:ke})],Re.prototype,"viewModel",void 0),Re=c([m("esri.widgets.Feature.FeatureAttachments")],Re);const Ve=Re;let Ne=class extends f{constructor(t){super(t),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.addHandles(g((()=>this.creator),(t=>{this._destroyContent(),this._createContent(t)}),v))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:t,graphic:e,destroyer:i}=this;t&&e&&(P(i,{graphic:e}).catch((()=>null)),this._set("created",null))}async _createContent(t){const e=this.graphic;if(!e||!t)return;const i=P(t,{graphic:e}).catch((()=>null));this._loadingPromise=i,this.notifyChange("state");const s=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",s))}};c([u({readOnly:!0})],Ne.prototype,"created",void 0),c([u()],Ne.prototype,"creator",void 0),c([u()],Ne.prototype,"destroyer",void 0),c([u({type:p})],Ne.prototype,"graphic",void 0),c([u({readOnly:!0})],Ne.prototype,"state",null),Ne=c([m("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],Ne);const Se=Ne;const Be="esri-feature-content",je={base:Be,loaderContainer:`${Be}__loader-container`,loader:`${Be}__loader`};let ze=class extends I{constructor(t,e){super(t,e),this.viewModel=null,this._addTargetToAnchors=t=>{Array.from(t.querySelectorAll("a")).forEach((t=>{O(t.href)&&!t.hasAttribute("target")&&t.setAttribute("target","_blank")}))}}get creator(){return this.viewModel?.creator}set creator(t){this.viewModel&&(this.viewModel.creator=t)}get graphic(){return this.viewModel?.graphic}set graphic(t){this.viewModel&&(this.viewModel.graphic=t)}render(){const t=this.viewModel?.state;return x("div",{class:je.base},"loading"===t?this._renderLoading():this._renderCreated())}_renderLoading(){return x("div",{class:je.loaderContainer,key:"loader"},x("div",{class:je.loader}))}_renderCreated(){const t=this.viewModel?.created;return t?t instanceof HTMLElement?x("div",{afterCreate:this._attachToNode,bind:t,key:t}):R(t)?x("div",{key:t},!t.destroyed&&t.render()):x("div",{afterCreate:this._addTargetToAnchors,innerHTML:t,key:t}):null}_attachToNode(t){const e=this;t.appendChild(e)}};c([u()],ze.prototype,"creator",null),c([u()],ze.prototype,"graphic",null),c([u({type:Se})],ze.prototype,"viewModel",void 0),ze=c([m("esri.widgets.Feature.FeatureContent")],ze);const De=ze;let qe=class extends f{constructor(t){super(t),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:t,fieldInfos:e}=this,i=[];return e?.forEach((e=>{if(!(!e.hasOwnProperty("visible")||e.visible))return;const s=e.clone();s.label=S(s,t),i.push(s)})),i}};c([u()],qe.prototype,"attributes",void 0),c([u({type:[V]})],qe.prototype,"expressionInfos",void 0),c([u()],qe.prototype,"description",void 0),c([u({type:[N]})],qe.prototype,"fieldInfos",void 0),c([u({readOnly:!0})],qe.prototype,"formattedFieldInfos",null),c([u()],qe.prototype,"title",void 0),qe=c([m("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],qe);const He=qe;const We="esri-feature-fields",Ue={base:We,fieldHeader:`${We}__field-header`,fieldData:`${We}__field-data`,fieldDataDate:`${We}__field-data--date`};let Xe=class extends I{constructor(t,e){super(t,e),this._featureElementInfo=null,this.viewModel=new He,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new Pe,this.addHandles(g((()=>[this.viewModel?.description,this.viewModel?.title]),(()=>this._setupFeatureElementInfo()),v))}destroy(){this._featureElementInfo?.destroy()}get attributes(){return this.viewModel.attributes}set attributes(t){this.viewModel.attributes=t}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get expressionInfos(){return this.viewModel.expressionInfos}set expressionInfos(t){this.viewModel.expressionInfos=t}get fieldInfos(){return this.viewModel.fieldInfos}set fieldInfos(t){this.viewModel.fieldInfos=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}render(){return x("div",{class:Ue.base},this._featureElementInfo?.render(),this._renderFields())}_renderFieldInfo(t,e){const{attributes:i}=this.viewModel,s=t.fieldName,n=t.label||s,r=i?null==i[s]?"":i[s]:"",a=!(!t.format||!t.format.dateFormat),o="number"==typeof r&&!a?this._forceLTR(r):B(this.messagesURIUtils,r),l={[Ue.fieldDataDate]:a};return x("tr",{key:`fields-element-info-row-${s}-${e}`},x("th",{class:Ue.fieldHeader,innerHTML:n,key:`fields-element-info-row-header-${s}-${e}`}),x("td",{class:this.classes(Ue.fieldData,l),innerHTML:o,key:`fields-element-info-row-data-${s}-${e}`}))}_renderFields(){const{formattedFieldInfos:t}=this.viewModel;return t?.length?x("table",{class:M.table,summary:this.messages.fieldsSummary},x("tbody",null,t.map(((t,e)=>this._renderFieldInfo(t,e))))):null}_setupFeatureElementInfo(){const{description:t,title:e}=this;this._featureElementInfo?.set({description:t,title:e})}_forceLTR(t){return`&lrm;${t}`}};c([u()],Xe.prototype,"attributes",null),c([u()],Xe.prototype,"description",null),c([u()],Xe.prototype,"expressionInfos",null),c([u()],Xe.prototype,"fieldInfos",null),c([u()],Xe.prototype,"title",null),c([u({type:He,nonNullable:!0})],Xe.prototype,"viewModel",void 0),c([u(),F("esri/widgets/Feature/t9n/Feature")],Xe.prototype,"messages",void 0),c([u(),F("esri/widgets/support/t9n/uriUtils")],Xe.prototype,"messagesURIUtils",void 0),Xe=c([m("esri.widgets.Feature.FeatureFields")],Xe);const Ye=Xe;const Ze=()=>window.matchMedia("(prefers-reduced-motion: reduce)").matches;const Ge="esri.widgets.Feature.support.relatedFeatureUtils",Qe=()=>j.getLogger(Ge),Je=new Map;function Ke(t){if(!H(t))return null;const[e,i]=t.split("/").slice(1);return{layerId:e,fieldName:i}}function ti(t,e){if(!e.relationships)return null;let i=null;const{relationships:s}=e;return s.some((e=>e.id===parseInt(t,10)&&(i=e,!0))),i}function ei({originRelationship:t,relationships:e,layerId:i}){return e.find((({relatedTableId:e,id:s})=>`${e}`===i&&s===t?.id))??null}function ii(t,e){const i=e.toLowerCase();for(const e in t)if(e.toLowerCase()===i)return t[e];return null}function si(t,e){const i=ti(t,e);if(!i)return;return{url:`${e.url}/${i.relatedTableId}`,sourceSpatialReference:e.spatialReference,relation:i,relatedFields:[],outStatistics:[]}}function ni(t,e){if(!e)return;if(!t)return;const{features:i,statsFeatures:s}=t,n=i?.value;e.relatedFeatures=n?n.features:[];const r=s?.value;e.relatedStatsFeatures=r?r.features:[]}function ri(t,e,i,s){const n=new Y;return n.outFields=["*"],n.relationshipId="number"==typeof e.id?e.id:parseInt(e.id,10),n.objectIds=[t.attributes[i.objectIdField]],i.queryRelatedFeatures?.(n,s)??Promise.resolve({})}function ai(t,e,i){let s=0;const n=[];for(;s<e.length;)n.push(`${t} IN (${e.slice(s,i+s)})`),s+=i;return n.join(" OR ")}function oi(t){return t?s(t):void 0}function li(t){return t?s(t,((t,e)=>JSON.stringify(t.toJSON())===JSON.stringify(e.toJSON()))):void 0}async function hi(t,e,i,s){const n=i.layerId.toString(),{layerInfo:r,relation:a,relatedFields:o,outStatistics:l,url:h,sourceSpatialReference:c}=e,u=oi(o),d=li(l);if(!r||!a)return null;const p=ei({originRelationship:a,relationships:r.relationships,layerId:n});if(p?.relationshipTableId&&p.keyFieldInRelationshipTable){const e=(await ri(t,p,i,s))[t.attributes[i.objectIdField]];if(!e)return null;const n=e.features.map((t=>t.attributes[r.objectIdField]));if(d?.length&&r.supportsStatistics){const t=new W;t.where=ai(r.objectIdField,n,1e3),t.outFields=u,t.outStatistics=d,t.sourceSpatialReference=c;const i={features:Promise.resolve(e),statsFeatures:oe(h,t)};return q(i)}}const m=p?.keyField;if(m){const e=U(mi(r.fields,m)),i=ii(t.attributes,a.keyField),n=e?`${m}=${i}`:`${m}='${i}'`,o=oe(h,new W({where:n,outFields:u,sourceSpatialReference:c}),s),l=!!d?.length&&r.supportsStatistics?oe(h,new W({where:n,outFields:u,outStatistics:d,sourceSpatialReference:c}),s):null,p={features:o};return l&&(p.statsFeatures=l),q(p)}return null}function ci(t,e){return z(t,{query:{f:"json"},signal:e?.signal})}function ui({relatedInfos:t,layer:e},i){const s={};return t.forEach(((t,i)=>{const{relation:n}=t;if(!n){const t=new b("relation-required","A relation is required on a layer to retrieve related records.");throw Qe().error(t),t}const{relatedTableId:r}=n;if("number"!=typeof r){const t=new b("A related table ID is required on a layer to retrieve related records.");throw Qe().error(t),t}const a=`${e.url}/${r}`,o=Je.get(a),l=o??ci(a);o||Je.set(a,l),s[i]=l})),D(q(s),i)}function di({graphic:t,relatedInfos:e,layer:i},s){const n={};return e.forEach(((e,r)=>{e.layerInfo&&(n[r]=hi(t,e,i,s))})),q(n)}function pi({relatedInfo:t,fieldName:e,fieldInfo:i}){if(t.relatedFields?.push(e),i.statisticType){const s=new X({statisticType:i.statisticType,onStatisticField:e,outStatisticFieldName:e});t.outStatistics?.push(s)}}function mi(t,e){if(null!=t){e=e.toLowerCase();for(const i of t)if(i&&i.name.toLowerCase()===e)return i}return null}const fi={chartAnimation:!0};let gi=class extends f{constructor(t){super(t),this.abilities={...fi},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(t){return{...fi,...t}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,i=(t+e)%e;this.activeMediaInfoIndex=i}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,i=e+t;this._setContentElementMedia(i)}_formatMediaInfos(){const{mediaInfos:t,layer:e}=this,i=this.attributes??{},s=this.formattedAttributes??{},n=this.expressionAttributes??{},r=this.fieldInfoMap??new Map;return t?.map((t=>{const a=t?.clone();if(!a)return null;if(a.title=Z({attributes:i,fieldInfoMap:r,globalAttributes:s,expressionAttributes:n,layer:e,text:a.title}),a.caption=Z({attributes:i,fieldInfoMap:r,globalAttributes:s,expressionAttributes:n,layer:e,text:a.caption}),a.altText=Z({attributes:i,fieldInfoMap:r,globalAttributes:s,expressionAttributes:n,layer:e,text:a.altText}),"image"===a.type){const{value:t}=a;return this._setImageValue({value:t,formattedAttributes:s,layer:e}),a.value.sourceURL?a:void 0}if("pie-chart"===a.type||"line-chart"===a.type||"column-chart"===a.type||"bar-chart"===a.type){const{value:t}=a;return this._setChartValue({value:t,chartType:a.type,attributes:i,formattedAttributes:s,layer:e,expressionAttributes:n}),a}return null})).filter(G)??[]}_setImageValue(t){const e=this.fieldInfoMap??new Map,{value:i,formattedAttributes:s,layer:n}=t,{linkURL:r,sourceURL:a}=i;if(a){const t=Q(a,n);i.sourceURL=J({formattedAttributes:s,template:t,fieldInfoMap:e})}if(r){const t=Q(r,n);i.linkURL=J({formattedAttributes:s,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:i,formattedAttributes:s,chartType:n,layer:r,expressionAttributes:a}=t,{popupTemplate:o,relatedInfos:l}=this,{fields:h,normalizeField:c}=e,u=r;e.fields=K(h,u),c&&(e.normalizeField=tt(c,u));if(!h.some((t=>!!(null!=s[t]||H(t)&&l?.size))))return;const d=o?.fieldInfos??[];h.forEach(((t,r)=>{const o=e.colors?.[r];if(H(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:d,fieldName:t,formattedAttributes:s,chartType:n,value:e,color:o})]);const l=this._getChartOption({value:e,attributes:i,chartType:n,formattedAttributes:s,expressionAttributes:a,fieldName:t,fieldInfos:d,color:o});e.series.push(l)}))}_getRelatedChartInfos(t){const{fieldInfos:e,fieldName:i,formattedAttributes:s,chartType:n,value:r,color:a}=t,o=[],l=Ke(i),h=l&&this.relatedInfos?.get(l.layerId.toString());if(!h)return o;const{relatedFeatures:c,relation:u}=h;if(!u||!c)return o;const{cardinality:d}=u;c.forEach((t=>{const{attributes:h}=t;h&&Object.keys(h).forEach((t=>{t===l.fieldName&&o.push(this._getChartOption({value:r,attributes:h,formattedAttributes:s,fieldName:i,chartType:n,relatedFieldName:t,hasMultipleRelatedFeatures:c?.length>1,fieldInfos:e,color:a}))}))}));return"one-to-many"===d||"many-to-many"===d?o:[o[0]]}_getTooltip({label:t,value:e,chartType:i}){return"pie-chart"===i?`${t}`:`${t}: ${e}`}_getChartOption(t){const{value:e,attributes:i,formattedAttributes:s,expressionAttributes:n,fieldName:r,relatedFieldName:a,fieldInfos:o,chartType:l,hasMultipleRelatedFeatures:h,color:c}=t,u=this.layer,d=this.fieldInfoMap??new Map,{normalizeField:p,tooltipField:m}=e,f=p?H(p)?i[Ke(p).fieldName]:i[p]:null,g=et(r)&&n&&void 0!==n[r]?n[r]:a&&void 0!==i[a]?i[a]:void 0!==i[r]?i[r]:s[r],v=new it({fieldName:r,color:c,value:void 0===g?null:g&&f?g/f:g});if(H(r)){const t=d.get(r.toLowerCase()),e=m&&d.get(m.toLowerCase()),n=t?.fieldName??r,o=h&&m?Ke(m).fieldName:e?.fieldName??m,c=h&&o?i[o]:s[o]??t?.label??t?.fieldName??a,u=h&&a?i[a]:s[n];return v.tooltip=this._getTooltip({label:c,value:u,chartType:l}),v}const b=st(o,r),w=tt(r,u),y=m&&void 0!==s[m]?s[m]:S(b||new N({fieldName:w}),this.popupTemplate?.expressionInfos),_=s[w];return v.tooltip=this._getTooltip({label:y,value:_,chartType:l}),v}};c([u()],gi.prototype,"abilities",void 0),c([d("abilities")],gi.prototype,"castAbilities",null),c([u()],gi.prototype,"activeMediaInfoIndex",void 0),c([u({readOnly:!0})],gi.prototype,"activeMediaInfo",null),c([u()],gi.prototype,"attributes",void 0),c([u()],gi.prototype,"description",void 0),c([u()],gi.prototype,"fieldInfoMap",void 0),c([u()],gi.prototype,"formattedAttributes",void 0),c([u()],gi.prototype,"expressionAttributes",void 0),c([u({readOnly:!0})],gi.prototype,"formattedMediaInfos",null),c([u()],gi.prototype,"isAggregate",void 0),c([u()],gi.prototype,"layer",void 0),c([u({readOnly:!0})],gi.prototype,"formattedMediaInfoCount",null),c([u()],gi.prototype,"mediaInfos",void 0),c([u()],gi.prototype,"popupTemplate",void 0),c([u()],gi.prototype,"relatedInfos",void 0),c([u()],gi.prototype,"title",void 0),gi=c([m("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],gi);const vi=gi;const bi="esri-feature-media",wi={base:bi,mediaContainer:`${bi}__container`,mediaItemContainer:`${bi}__item-container`,mediaItem:`${bi}__item`,mediaItemText:`${bi}__item-text`,mediaItemTitle:`${bi}__item-title`,mediaItemCaption:`${bi}__item-caption`,mediaNavigation:`${bi}__item-navigation`,mediaPagination:`${bi}__pagination`,mediaPaginationText:`${bi}__pagination-text`,mediaPrevious:`${bi}__previous`,mediaPreviousIconLTR:`${bi}__previous-icon`,mediaPreviousIconRTL:`${bi}__previous-icon--rtl`,mediaNext:`${bi}__next`,mediaNextIconLTR:`${bi}__next-icon`,mediaNextIconRTL:`${bi}__next-icon--rtl`,mediaChart:`${bi}__chart`,mediaPaginationButton:`${bi}__pagination-button`,mediaPaginationIcon:`${bi}__pagination-icon`,mediaChartRendered:`${bi}__chart--rendered`},yi=15,_i="category",Fi="value",Ii="rgba(50, 50, 50, 1)",Ai=250,Ci=500,xi=200;let Mi=class extends I{constructor(t,e){super(t,e),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this._chartRootMap=new WeakMap,this.viewModel=new vi,this.messages=null,this._disposeChart=t=>{this._chartRootMap.get(t)?.dispose(),this._chartRootMap.delete(t)},this._createChart=async t=>{const{destroyed:e,viewModel:i}=this;if(e||!i||!t)return;const{createRoot:s}=await import("./p-9aa2283b.js"),n=await s(t);this._chartRootMap.set(t,n),this._renderChart({mediaInfo:i.activeMediaInfo,root:n})}}initialize(){this._featureElementInfo=new Pe,this.addHandles([g((()=>[this.viewModel?.activeMediaInfo,this.viewModel?.activeMediaInfoIndex]),(()=>this._setupMediaRefreshTimer()),v),g((()=>[this.viewModel?.description,this.viewModel?.title]),(()=>this._setupFeatureElementInfo()),v)])}loadDependencies(){return C({icon:()=>import("./p-659ef4de.js")})}destroy(){this._clearMediaRefreshTimer(),this._featureElementInfo?.destroy()}get attributes(){return this.viewModel.attributes}set attributes(t){this.viewModel.attributes=t}get activeMediaInfoIndex(){return this.viewModel.activeMediaInfoIndex}set activeMediaInfoIndex(t){this.viewModel.activeMediaInfoIndex=t}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get fieldInfoMap(){return this.viewModel.fieldInfoMap}set fieldInfoMap(t){this.viewModel.fieldInfoMap=t}get layer(){return this.viewModel.layer}set layer(t){this.viewModel.layer=t}get mediaInfos(){return this.viewModel.mediaInfos}set mediaInfos(t){this.viewModel.mediaInfos=t}get popupTemplate(){return this.viewModel.popupTemplate}set popupTemplate(t){this.viewModel.popupTemplate=t}get relatedInfos(){return this.viewModel.relatedInfos}set relatedInfos(t){this.viewModel.relatedInfos=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}render(){return x("div",{bind:this,class:wi.base,onkeyup:this._handleMediaKeyup},this._featureElementInfo?.render(),this._renderMedia())}_renderMedia(){const{formattedMediaInfoCount:t,activeMediaInfoIndex:e}=this.viewModel,i=this._renderMediaText();return t?x("div",{class:wi.mediaContainer,key:"media-element-container"},this._renderMediaInfo(),x("div",{class:wi.mediaNavigation},i,t>1?x("div",{class:wi.mediaPagination},this._renderMediaPageButton("previous"),x("span",{class:wi.mediaPaginationText},nt(this.messages.pageText,{index:e+1,total:t})),this._renderMediaPageButton("next")):null)):null}_renderMediaText(){const{activeMediaInfo:t}=this.viewModel;if(!t)return null;const e=t&&t.title?x("div",{class:wi.mediaItemTitle,innerHTML:t.title,key:"media-title"}):null,i=t&&t.caption?x("div",{class:wi.mediaItemCaption,innerHTML:t.caption,key:"media-caption"}):null;return e||i?x("div",{class:wi.mediaItemText,key:"media-text"},e,i):null}_renderImageMediaInfo(t){const{_refreshIntervalInfo:e}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:s}=this.viewModel,{value:n,refreshInterval:r,altText:a,title:o,type:l}=t,{sourceURL:h,linkURL:c}=n,u=O(c??void 0)?"_blank":"_self",d="_blank"===u?"noreferrer":"",p=r?e:null,m=p?p.timestamp:0,f=p?p.sourceURL:h,g=x("img",{alt:a||o,key:`media-${l}-${i}-${s}-${m}`,src:f??void 0});return(c?x("a",{href:c,rel:d,target:u,title:o},g):null)??g}_renderChartMediaInfo(t){const{activeMediaInfoIndex:e,formattedMediaInfoCount:i}=this.viewModel;return x("div",{afterCreate:this._createChart,afterRemoved:this._disposeChart,bind:this,class:wi.mediaChart,key:`media-${t.type}-${e}-${i}`})}_renderMediaInfoType(){const{activeMediaInfo:t}=this.viewModel;return t?"image"===t.type?this._renderImageMediaInfo(t):t.type.includes("chart")?this._renderChartMediaInfo(t):null:null}_renderMediaInfo(){const{activeMediaInfo:t}=this.viewModel;return t?x("div",{class:wi.mediaItemContainer,key:"media-container"},x("div",{class:wi.mediaItem,key:"media-item-container"},this._renderMediaInfoType())):null}_renderMediaPageButton(t){if(this.viewModel.formattedMediaInfoCount<2)return null;const e="previous"===t,i=e?this.messages.previous:this.messages.next,s=e?"chevron-left":"chevron-right",n=e?"media-previous":"media-next",r=e?this._previous:this._next;return x("button",{"aria-label":i,bind:this,class:wi.mediaPaginationButton,key:n,onclick:r,tabIndex:0,title:i,type:"button"},x("calcite-icon",{class:wi.mediaPaginationIcon,icon:s,scale:"s"}))}_setupFeatureElementInfo(){const{description:t,title:e}=this;this._featureElementInfo?.set({description:t,title:e})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_getRenderer(){if(!this.viewModel)return;const{isAggregate:t,layer:e}=this.viewModel;return t&&e?.featureReduction&&"renderer"in e.featureReduction?e.featureReduction.renderer:e?.renderer}async _getSeriesColors(t){const{colorAm5:e}=await import("./p-a7102482.js"),i=new Map;return t.forEach((t=>{t.color&&i.set(t,e(t.color.toCss(!0)))})),i}async _getRendererColors(){const{colorAm5:t}=await import("./p-a7102482.js"),e=new Map,i=this._getRenderer(),s="default";if(!i)return e;const n=await he(i);n.delete(s);return Array.from(n.values()).every((t=>1===t?.length))?(Array.from(n.keys()).forEach((i=>{const s=n.get(i)?.[0]?.toCss(!0);s&&e.set(i,t(s))})),e):e}_handleMediaKeyup(t){const{key:e}=t;"ArrowLeft"===e&&(t.stopPropagation(),this.viewModel.previous()),"ArrowRight"===e&&(t.stopPropagation(),this.viewModel.next())}_canAnimateChart(){return!!this.viewModel&&(!!this.viewModel.abilities.chartAnimation&&!Ze())}_getChartAnimationMS(){return this._canAnimateChart()?Ai:0}_getChartSeriesAnimationMS(){return this._canAnimateChart()?Ci:0}async _renderChart(t){const{root:e,mediaInfo:i}=t,{value:s,type:n}=i,{ResponsiveThemeAm5:r,DarkThemeAm5:a,AnimatedThemeAm5:o,ColorSetAm5:l,ThemeAm5:h,esriChartColorSet:c}=await import("./p-a7102482.js"),u=h.new(e);u.rule("ColorSet").set("colors",c),u.rule("ColorSet").set("reuse",!0);const d=[r.new(e),u];rt()&&d.push(a.new(e)),this._canAnimateChart()&&d.push(o.new(e)),e.setThemes(d);const p=await this._getRendererColors(),m=await this._getSeriesColors(s.series),f=l.new(e,{}),g=m.get(s.series[0]),v=g?{lineSettings:{stroke:g}}:void 0,b=s.series.map(((t,e)=>{const i=m.get(t)||p.get(t.fieldName)||f.getIndex(e);return{[_i]:t.tooltip,[Fi]:t.value,columnSettings:{fill:i,stroke:i},...v}})).filter((t=>"pie-chart"!==n||null!=t.value&&t.value>0));"pie-chart"===n?this._createPieChart(t,b):this._createXYChart(t,b)}_getDirection(){return E(this.container)?"rtl":"ltr"}_isInversed(){return!!E(this.container)}async _customizeChartTooltip(t,e="horizontal"){const{colorAm5:i}=await import("./p-a7102482.js");t.setAll({pointerOrientation:e}),t.get("background")?.setAll({stroke:i(Ii)}),t.label.setAll({direction:this._getDirection(),oversizedBehavior:"wrap",maxWidth:xi})}async _createPieChart(t,e){const{TooltipAm5:i}=await import("./p-a7102482.js"),{PieChartAm5:s,PieSeriesAm5:n}=await import("./p-008a8589.js"),{mediaInfo:r,root:a}=t,{title:o}=r,l=5,h=r?.altText||r?.title||"",c=a.container.children.push(s.new(a,{ariaLabel:h,focusable:!0,paddingBottom:l,paddingTop:l,paddingLeft:l,paddingRight:l})),u="{category}: {valuePercentTotal.formatNumber('0.00')}%\n ({value})",d=i.new(a,{labelText:u}),p=c.series.push(n.new(a,{name:o,valueField:Fi,categoryField:_i,tooltip:d}));p.ticks.template.set("forceHidden",!0),p.labels.template.set("forceHidden",!0),p.slices.template.states.create("active",{shiftRadius:l}),this._customizeChartTooltip(d),p.slices.template.setAll({ariaLabel:u,focusable:!0,templateField:"columnSettings"}),p.data.setAll(e),p.appear(this._getChartSeriesAnimationMS()),c.appear(this._getChartAnimationMS()),c.root.dom.classList.toggle(wi.mediaChartRendered,!0)}_getMinSeriesValue(t){let e=0;return t.forEach((t=>e=Math.min(t.value,e))),e}async _createColumnChart(t,e,i){const{TooltipAm5:s,ScrollbarAm5:n}=await import("./p-a7102482.js"),{CategoryAxisAm5:r,AxisRendererXAm5:a,ValueAxisAm5:o,AxisRendererYAm5:l,ColumnSeriesAm5:h}=await import("./p-06376f98.js"),{mediaInfo:c,root:u}=e,{value:d,title:p}=c;t.setAll({wheelX:"panX",wheelY:"zoomX"});const m=t.xAxes.push(r.new(u,{renderer:a.new(u,{inversed:this._isInversed()}),categoryField:_i}));m.get("renderer").labels.template.setAll({forceHidden:!0});const f=t.yAxes.push(o.new(u,{renderer:l.new(u,{inside:!1}),min:this._getMinSeriesValue(d.series)}));f.get("renderer").labels.template.setAll({direction:this._getDirection()});const g="{categoryX}",v=s.new(u,{labelText:g}),b=t.series.push(h.new(u,{name:p,xAxis:m,yAxis:f,valueYField:Fi,categoryXField:_i,tooltip:v}));this._customizeChartTooltip(v),b.columns.template.setAll({ariaLabel:g,focusable:!0,templateField:"columnSettings"}),d.series.length>yi&&t.set("scrollbarX",n.new(u,{orientation:"horizontal"})),m.data.setAll(i),b.data.setAll(i),b.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())}async _createBarChart(t,e,i){const{TooltipAm5:s,ScrollbarAm5:n}=await import("./p-a7102482.js"),{CategoryAxisAm5:r,AxisRendererXAm5:a,ValueAxisAm5:o,AxisRendererYAm5:l,ColumnSeriesAm5:h}=await import("./p-06376f98.js"),{mediaInfo:c,root:u}=e,{value:d,title:p}=c;t.setAll({wheelX:"panY",wheelY:"zoomY"});const m=t.yAxes.push(r.new(u,{renderer:l.new(u,{inversed:!0}),categoryField:_i}));m.get("renderer").labels.template.setAll({forceHidden:!0});const f=t.xAxes.push(o.new(u,{renderer:a.new(u,{inside:!1,inversed:this._isInversed()}),min:this._getMinSeriesValue(d.series)}));f.get("renderer").labels.template.setAll({direction:this._getDirection()});const g="{categoryY}",v=s.new(u,{labelText:g}),b=t.series.push(h.new(u,{name:p,xAxis:f,yAxis:m,valueXField:Fi,categoryYField:_i,tooltip:v}));this._customizeChartTooltip(v,"vertical"),b.columns.template.setAll({ariaLabel:g,focusable:!0,templateField:"columnSettings"}),d.series.length>yi&&t.set("scrollbarY",n.new(u,{orientation:"vertical"})),m.data.setAll(i),b.data.setAll(i),b.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())}async _createLineChart(t,e,i){const{TooltipAm5:s,ScrollbarAm5:n}=await import("./p-a7102482.js"),{CategoryAxisAm5:r,AxisRendererXAm5:a,ValueAxisAm5:o,AxisRendererYAm5:l,LineSeriesAm5:h}=await import("./p-06376f98.js"),{root:c,mediaInfo:u}=e,{value:d,title:p}=u;t.setAll({wheelX:"panX",wheelY:"zoomX"});const m=t.xAxes.push(r.new(c,{renderer:a.new(c,{inversed:this._isInversed()}),categoryField:_i}));m.get("renderer").labels.template.setAll({forceHidden:!0});const f=t.yAxes.push(o.new(c,{renderer:l.new(c,{inside:!1}),min:this._getMinSeriesValue(d.series)}));f.get("renderer").labels.template.setAll({direction:this._getDirection()});const g="{categoryX}",v=i[0]?.lineSettings?.stroke,b=s.new(c,{getFillFromSprite:!v,labelText:g});v&&b.get("background")?.setAll({fill:v});const w=t.series.push(h.new(c,{name:p,xAxis:m,yAxis:f,valueYField:Fi,categoryXField:_i,tooltip:b}));w.strokes.template.setAll({templateField:"lineSettings"}),this._customizeChartTooltip(b,"vertical"),d.series.length>yi&&t.set("scrollbarX",n.new(c,{orientation:"horizontal"})),m.data.setAll(i),w.data.setAll(i),w.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())}async _createXYChart(t,e){const{XYChartAm5:i,XYCursorAm5:s}=await import("./p-06376f98.js"),{root:n,mediaInfo:r}=t,{type:a}=r,o=r?.altText||r?.title||"",l=n.container.children.push(i.new(n,{ariaLabel:o,focusable:!0,panX:!0,panY:!0}));l.set("cursor",s.new(n,{})),"column-chart"===a&&await this._createColumnChart(l,t,e),"bar-chart"===a&&await this._createBarChart(l,t,e),"line-chart"===a&&await this._createLineChart(l,t,e),l.root.dom.classList.toggle(wi.mediaChartRendered,!0)}_clearMediaRefreshTimer(){const{_refreshTimer:t}=this;t&&(clearTimeout(t),this._refreshTimer=null)}_updateMediaInfoTimestamp(t){const e=Date.now();this._refreshIntervalInfo={timestamp:e,sourceURL:t&&this._getImageSource(t,e)}}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:t}=this.viewModel;t&&"image"===t.type&&t.refreshInterval&&this._setRefreshTimeout(t)}_setRefreshTimeout(t){const{refreshInterval:e,value:i}=t;if(!e)return;const s=6e4*e;this._updateMediaInfoTimestamp(i.sourceURL);const n=setInterval((()=>{this._updateMediaInfoTimestamp(i.sourceURL)}),s);this._refreshTimer=n}_getImageSource(t,e){const i=t.includes("?")?"&":"?",[s,n=""]=t.split("#");return`${s}${i}timestamp=${e}${n?"#":""}${n}`}};c([u()],Mi.prototype,"_refreshIntervalInfo",void 0),c([u()],Mi.prototype,"attributes",null),c([u()],Mi.prototype,"activeMediaInfoIndex",null),c([u()],Mi.prototype,"description",null),c([u()],Mi.prototype,"fieldInfoMap",null),c([u()],Mi.prototype,"layer",null),c([u()],Mi.prototype,"mediaInfos",null),c([u()],Mi.prototype,"popupTemplate",null),c([u()],Mi.prototype,"relatedInfos",null),c([u()],Mi.prototype,"title",null),c([u({type:vi})],Mi.prototype,"viewModel",void 0),c([u(),F("esri/widgets/Feature/t9n/Feature")],Mi.prototype,"messages",void 0),Mi=c([m("esri.widgets.Feature.FeatureMedia")],Mi);const $i=Mi;const ki="esri.widgets.Feature.support.arcadeFeatureUtils",Ei=()=>j.getLogger(ki);function Ti(t){return"string"==typeof t?at(ot(t)):Array.isArray(t)?Li(t):"esri.arcade.Dictionary"===t?.declaredClass?Pi(t):t}function Li(t){return`<ul class="esri-widget__list">${t.map((t=>`<li>${"string"==typeof t?at(ot(t)):t}</li>`)).join("")}</ul>`}function Pi(t){const e=t.keys().map((e=>{const i=t.field(e);return`<tr><th>${e}</th><td>${"string"==typeof i?at(ot(i)):i}</td></tr>`})).join("");return`<table class="${M.table}">${e}</table>`}function Oi(){return import("./p-bfafdc90.js")}function Ri(t){return"createQuery"in t&&"queryFeatures"in t}async function Vi({graphic:t,view:e,options:i}){const{isAggregate:s,layer:n}=t;if(!s||!n||"2d"!==e?.type)return[];const r=await e.whenLayerView(n);if(!Ri(r))return[];const a=r.createQuery(),o=t.getObjectId();a.aggregateIds=null!=o?[o]:[];const{features:l}=await r.queryFeatures(a,i);return l}function Ni({layer:t,aggregatedFeatures:e,interceptor:i}){const{fields:s,objectIdField:n,geometryType:r,spatialReference:a,displayField:o}=t;return new lt({fields:s,objectIdField:n,geometryType:r,spatialReference:a,displayField:o,interceptor:i,..."feature"===t.type?{templates:t.templates,typeIdField:t.typeIdField,types:t.types}:null,source:e})}async function Si({expressionInfo:t,arcade:e,interceptor:i,spatialReference:s,map:n,graphic:r,location:a,view:o,options:l}){if(!t?.expression)return null;const{isAggregate:h}=r,c=(r.sourceLayer||r.layer)??void 0,u=h?"feature-reduction-popup":"popup",d=e.createArcadeProfile(u),p=e.createArcadeExecutor(t.expression,d).catch((e=>Ei().error("arcade-executor-error",{error:e,expressionInfo:t}))),[m,f]=await Promise.all([Vi({graphic:r,view:o,options:l}),p]);if(!f)return null;const g="feature-reduction-popup"===u?Ni({layer:c,aggregatedFeatures:m,interceptor:i}):void 0,v={..."feature-reduction-popup"===u?{$aggregatedFeatures:g}:{$datastore:c?.url,$layer:"feature"===c?.type||"subtype-sublayer"===c?.type?c:"scene"===c?.type&&null!=c.associatedLayer?c.associatedLayer:void 0,$map:n,$userInput:a,$graph:"knowledge-graph-sublayer"===c?.type?c?.parentCompositeLayer?.knowledgeGraph:void 0},$feature:r},b={abortSignal:l?.signal??void 0,interceptor:i??void 0,rawOutput:!0,spatialReference:s??void 0,timeZone:o?.timeZone};return await f.executeAsync(v,b).catch((e=>Ei().error("arcade-execution-error",{error:e,graphic:r,expressionInfo:t}))).finally((()=>g?.destroy()))}async function Bi({expressionInfos:t,spatialReference:e,graphic:i,interceptor:s,map:n,view:r,location:a,options:o}){if(!t?.length)return{};const l=await Oi(),h={};for(const c of t)h[`expression/${c.name}`]=Si({expressionInfo:c,arcade:l,interceptor:s,spatialReference:e,map:n,graphic:i,location:a,view:r,options:o});const c=await q(h),u={};for(const t in c)u[t]=Ti(c[t].value);return u}const ji=1;let zi=class extends f{constructor(t){super(t),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{const t=this.contentElement?.type;this.contentElementViewModel?.destroy();const e="fields"===t?new He:"media"===t?new vi:"text"===t?new Se:null;this._set("contentElementViewModel",e)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=ce(this._compile,ji,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:e,interceptor:i,spatialReference:s,map:n,location:r,view:a,_abortController:o}=this;if(!t||!e)return void this._set("contentElement",null);const l=await Oi();if(o!==this._abortController)return;const h=await Si({arcade:l,expressionInfo:t,graphic:e,location:r,interceptor:i,map:n,spatialReference:s,view:a});if(!h||"esri.arcade.Dictionary"!==h.declaredClass)return void this._set("contentElement",null);const c=await h.castAsJsonAsync(o?.signal),u=c?.type,d="media"===u?ut.fromJSON(c):"text"===u?dt.fromJSON(c):"fields"===u?pt.fromJSON(c):null;this._set("contentElement",d)},this.addHandles([g((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),v),g((()=>[this.contentElement]),(()=>this._createVM()),v)])}initialize(){this.addHandles(this._compileThrottled)}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get state(){const{_abortController:t,contentElement:e,contentElementViewModel:i}=this;return t?"loading":e||i?"ready":"disabled"}get map(){return this.view?.map??null}set map(t){this._override("map",t)}};c([u()],zi.prototype,"_abortController",void 0),c([u({type:ht})],zi.prototype,"expressionInfo",void 0),c([u({type:p})],zi.prototype,"graphic",void 0),c([u({readOnly:!0})],zi.prototype,"contentElement",void 0),c([u({readOnly:!0})],zi.prototype,"contentElementViewModel",void 0),c([u()],zi.prototype,"interceptor",void 0),c([u({type:ct})],zi.prototype,"location",void 0),c([u()],zi.prototype,"spatialReference",null),c([u({readOnly:!0})],zi.prototype,"state",null),c([u()],zi.prototype,"map",null),c([u()],zi.prototype,"view",void 0),zi=c([m("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],zi);const Di=zi;const qi="esri-feature",Hi={base:`${qi}-expression`,loadingSpinnerContainer:`${qi}__loading-container`,spinner:`${qi}__loading-spinner`};let Wi=class extends I{constructor(t,e){super(t,e),this._contentWidget=null,this.viewModel=new Di}initialize(){this.addHandles(g((()=>this.viewModel?.contentElementViewModel),(()=>this._setupExpressionWidget()),v))}destroy(){this._destroyContentWidget()}render(){const{state:t}=this.viewModel;return x("div",{class:Hi.base},"loading"===t?this._renderLoading():"disabled"===t?null:this._contentWidget?.render())}_renderLoading(){return x("div",{class:Hi.loadingSpinnerContainer,key:"loading-container"},x("span",{class:this.classes(T.loadingIndicator,M.rotating,Hi.spinner)}))}_destroyContentWidget(){const{_contentWidget:t}=this;t&&(t.viewModel=null,t.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:t,contentElement:e}=this.viewModel,i=e?.type;this._destroyContentWidget();const s=t?"fields"===i?new Ye({viewModel:t}):"media"===i?new $i({viewModel:t}):"text"===i?new De({viewModel:t}):null:null;this._contentWidget=s,this.scheduleRender()}};c([u({type:Di})],Wi.prototype,"viewModel",void 0),Wi=c([m("esri.widgets.Feature.FeatureExpression")],Wi);const Ui=Wi;const Xi=100;let Yi=class extends(mt(ft(f))){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:t}=this;t&&t.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const t=new AbortController;this._queryAbortController=t,await gt(this._query()),this._queryAbortController===t&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await gt(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const t=new AbortController;this._queryPageAbortController=t,await gt(this._queryPage()),this._queryPageAbortController===t&&(this._queryPageAbortController=null)},this._queryDebounced=vt(this._queryController,Xi),this._queryFeatureCountDebounced=vt(this._queryFeatureCountController,Xi),this._queryPageDebounced=vt(this._queryPageController,Xi),this._query=async()=>{const{_queryAbortController:t,relatedFeatures:e}=this;this.featureCount&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,e.removeAll(),this.destroyed||e.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:t?.signal}))))},this.addHandles([g((()=>[this.displayCount,this.graphic,this.layer,this.layer?.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount]),(()=>this._queryDebounced()),v),g((()=>[this.featurePage,this.showAllEnabled]),(()=>this._queryPageDebounced())),g((()=>[this.layer,this.relationshipId,this.objectId,this.canQuery]),(()=>this._queryFeatureCountDebounced()))])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.removeAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(t){const{featuresPerPage:e,featureCount:i}=this,s=1,n=Math.ceil(i/e)||1;this._set("featurePage",Math.min(Math.max(t,s),n))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:t,relatedLayer:e}=this;return t&&e?.loaded?t.map((t=>{const i=t.clone();return i.field=tt(t.field,e),i})):t??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canLoad(){return!!this.map&&"number"==typeof this.relationshipId&&"number"==typeof this.objectId}get canQuery(){const t=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&"number"==typeof this.relationshipId&&"number"==typeof this.objectId&&t?.supportsCount&&t?.supportsPagination)}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}set displayCount(t){const e=0,i=10;this._set("displayCount",Math.min(Math.max(t,e),i))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new h}get relatedLayer(){const{layer:t,map:e,relationship:i}=this;return t?.loaded&&e&&i?bt(e,t,i)??null:null}get relationship(){const{relationshipId:t,layer:e}=this;return"number"==typeof t?e?.relationships?.find((({id:e})=>e===t))??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new h}get state(){const{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:i,canQuery:s,_loaded:n,canLoad:r}=this;return e||r&&!n?"loading":t||i?"querying":s?"ready":"disabled"}getRelatedFeatureByObjectId(t){return this.relatedFeatures.find((e=>e.getObjectId()===t))}refresh(){this._queryFeatureCountDebounced()}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.forEach((t=>!t.destroyed&&t.destroy())),this.relatedFeatureViewModels.removeAll()}async _queryFeatureCount(){const{layer:t,relatedLayer:e,relationshipId:i,objectId:s,_queryFeatureCountAbortController:n,canQuery:r,supportsCacheHint:a}=this;if(await(t?.load()),await(e?.load()),!r||!t||!e)return void this._set("featureCount",0);const o=e.createQuery(),l=new Y({cacheHint:a,relationshipId:i,returnGeometry:!1,objectIds:[s],where:o.where??void 0}),h=await t.queryRelatedFeaturesCount(l,{signal:n?.signal});this._set("featureCount",h[s]||0)}_sliceFeatures(t){const{showAllEnabled:e,displayCount:i}=this;return e?t:i?t.slice(0,i):[]}async _queryPage(){const{relatedFeatures:t,featurePage:e,showAllEnabled:i,_queryPageAbortController:s,featureCount:n}=this;!i||e<2||!n||t.addMany(await this._queryRelatedFeatures({signal:s?.signal}))}async _queryRelatedFeatures(t){const{orderByFieldsFixedCasing:e,showAllEnabled:i,featuresPerPage:s,displayCount:n,layer:r,relationshipId:a,featurePage:o,featureCount:l,relatedLayer:h,supportsCacheHint:c}=this,{canQuery:u,objectId:d}=this;if(!u||!r||!h)return[];const p=i?((o-1)*s+l)%l:0,m=i?s:n,f=h.objectIdField,g=[...e.map((t=>t.field)),...wt(h),f].filter(G),v=e.map((t=>`${t.field} ${t.order}`)),b=h.createQuery(),w=new Y({orderByFields:v,start:p,num:m,outFields:g,cacheHint:c,relationshipId:a,returnGeometry:!1,objectIds:[d],where:b.where??void 0}),y=await r.queryRelatedFeatures(w,{signal:t?.signal}),_=y[d]?.features||[];return _.forEach((t=>{t.sourceLayer=h,t.layer=h})),_}};c([u()],Yi.prototype,"_loaded",void 0),c([u()],Yi.prototype,"_queryAbortController",void 0),c([u()],Yi.prototype,"_queryPageAbortController",void 0),c([u()],Yi.prototype,"_queryFeatureCountAbortController",void 0),c([u({value:1})],Yi.prototype,"featurePage",null),c([u()],Yi.prototype,"featuresPerPage",void 0),c([u({readOnly:!0})],Yi.prototype,"orderByFieldsFixedCasing",null),c([u({readOnly:!0})],Yi.prototype,"supportsCacheHint",null),c([u({readOnly:!0})],Yi.prototype,"canLoad",null),c([u({readOnly:!0})],Yi.prototype,"canQuery",null),c([u()],Yi.prototype,"description",void 0),c([u({readOnly:!0})],Yi.prototype,"itemDescriptionFieldName",null),c([u({value:3})],Yi.prototype,"displayCount",null),c([u({type:p})],Yi.prototype,"graphic",void 0),c([u()],Yi.prototype,"layer",void 0),c([u()],Yi.prototype,"map",void 0),c([u({readOnly:!0})],Yi.prototype,"objectId",null),c([u({readOnly:!0})],Yi.prototype,"objectIdField",null),c([u()],Yi.prototype,"orderByFields",void 0),c([u({readOnly:!0})],Yi.prototype,"relatedFeatures",null),c([u({readOnly:!0})],Yi.prototype,"relatedLayer",null),c([u({readOnly:!0})],Yi.prototype,"relationship",null),c([u()],Yi.prototype,"featureCount",void 0),c([u({readOnly:!0})],Yi.prototype,"relatedFeatureViewModels",null),c([u()],Yi.prototype,"relationshipId",void 0),c([u()],Yi.prototype,"showAllEnabled",void 0),c([u()],Yi.prototype,"state",null),c([u()],Yi.prototype,"title",void 0),Yi=c([m("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],Yi);const Zi=Yi;const Gi="esri-feature",Qi=`${Gi}-relationship`,Ji={base:Qi,listContainer:`${Qi}__list`,listItem:`${Qi}__list-item`,listItemHidden:`${Qi}__list-item--hidden`,listContainerQuerying:`${Qi}__list--querying`,featureObserver:`${Gi}__feature-observer`,stickySpinnerContainer:`${Gi}__sticky-loading-container`,loadingSpinnerContainer:`${Gi}__loading-container`,spinner:`${Gi}__loading-spinner`},Ki={title:!0,description:!0};let ts=class extends I{constructor(t,e){super(t,e),this._featureElementInfo=null,this._relatedFeatureIntersectionObserverNode=null,this._relatedFeatureIntersectionObserver=new IntersectionObserver((([t])=>{t?.isIntersecting&&this._increaseFeaturePage()}),{root:window.document}),this.headingLevel=2,this.viewModel=new Zi,this.messages=null,this.messagesCommon=null,this.visibleElements={...Ki},this._increaseFeaturePage=()=>{const{state:t,showAllEnabled:e,relatedFeatures:i,featuresPerPage:s,featurePage:n}=this.viewModel;"ready"===t&&e&&i.length>=s*n&&this.viewModel.featurePage++}}initialize(){this._featureElementInfo=new Pe,this.addHandles([g((()=>[this.viewModel.description,this.viewModel.title,this.headingLevel]),(()=>this._setupFeatureElementInfo()),v),g((()=>[this.viewModel.state,this.viewModel.showAllEnabled,this._relatedFeatureIntersectionObserverNode]),(()=>this._handleRelatedFeatureObserverChange())),A((()=>this.viewModel.relatedFeatureViewModels),"change",(()=>this._setupRelatedFeatureViewModels()))])}loadDependencies(){return C({icon:()=>import("./p-659ef4de.js"),list:()=>import("./p-25a5a898.js"),"list-item":()=>import("./p-ef7720e4.js"),notice:()=>import("./p-3a3e80ff.js")})}destroy(){this._unobserveRelatedFeatureObserver(),this._featureElementInfo=yt(this._featureElementInfo)}get displayShowAllButton(){const{showAllEnabled:t,featureCount:e,displayCount:i,state:s}=this.viewModel;return!t&&!!e&&"ready"===s&&(e>i||0===i)}get displayListItems(){return this.displayShowAllButton||this.viewModel.relatedFeatureViewModels.length>0}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get featureCountDescription(){const{messages:t}=this,{featureCount:e}=this.viewModel;return nt(t?.numberRecords,{number:e})}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}castVisibleElements(t){return{...Ki,...t}}render(){const{state:t}=this.viewModel;return x("div",{class:this.classes(Ji.base,M.widget)},this._featureElementInfo?.render(),"loading"===t?this._renderLoading():"disabled"===t?this._renderRelationshipNotFound():this._renderRelatedFeatures())}_renderStickyLoading(){return"querying"===this.viewModel.state?x("div",{class:Ji.stickySpinnerContainer,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoadingIcon(){return x("span",{class:this.classes(T.loadingIndicator,M.rotating,Ji.spinner)})}_renderLoading(){return x("div",{class:Ji.loadingSpinnerContainer,key:"loading-container"},this._renderLoadingIcon())}_renderShowAllIconNode(){return x("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})}_renderChevronIconNode(){const t=E(this.container)?"chevron-left":"chevron-right";return x("calcite-icon",{icon:t,scale:"s",slot:"content-end"})}_renderRelatedFeature(t){const{itemDescriptionFieldName:e}=this.viewModel,i=t.title;t.description=e&&t.formattedAttributes?.global[e];const s="loading"===t.state;return x("calcite-list-item",{class:this.classes(Ji.listItem,{[Ji.listItemHidden]:s}),description:t.description??"",key:t.uid,label:i,onCalciteListItemSelect:()=>this.emit("select-record",{featureViewModel:t})},this._renderChevronIconNode())}_renderShowAllListItem(){return this.displayShowAllButton?x("calcite-list-item",{description:this.featureCountDescription,key:"show-all-item",label:this.messages?.showAll,onCalciteListItemSelect:()=>this.emit("show-all-records")},this._renderShowAllIconNode()):null}_renderNoRelatedFeaturesMessage(){return x("calcite-notice",{icon:"information",key:"no-related-features-message",kind:"brand",open:!0,scale:"s",width:"full"},x("div",{slot:"message"},this.messages?.noRelatedFeatures))}_renderFeatureObserver(){return x("div",{afterCreate:this._relatedFeatureIntersectionObserverCreated,bind:this,class:Ji.featureObserver,key:"feature-observer"})}_renderList(){const{relatedFeatureViewModels:t}=this.viewModel;return x("calcite-list",null,t.toArray().map((t=>this._renderRelatedFeature(t))),this._renderShowAllListItem())}_renderRelatedFeatures(){const{displayListItems:t}=this,{state:e}=this.viewModel;return x("div",{class:this.classes(Ji.listContainer,{[Ji.listContainerQuerying]:"querying"===e}),key:"list-container"},t?this._renderList():"ready"===e?this._renderNoRelatedFeaturesMessage():null,this._renderStickyLoading(),this._renderFeatureObserver())}_renderRelationshipNotFound(){return x("calcite-notice",{icon:"exclamation-mark-triangle",key:"relationship-not-found",kind:"danger",open:!0,scale:"s",width:"full"},x("div",{slot:"message"},this.messages?.relationshipNotFound))}_setupRelatedFeatureViewModels(){const{relatedFeatureViewModels:t}=this.viewModel,e="related-feature-viewmodels";this.removeHandles(e),t?.forEach((t=>{this.addHandles(g((()=>[t.title,t.state]),(()=>this.scheduleRender()),v),e)})),this.scheduleRender()}_setupFeatureElementInfo(){const{headingLevel:t,visibleElements:e}=this,i=e.description&&this.description,s=e.title&&this.title;this._featureElementInfo?.set({description:i,title:s,headingLevel:t})}async _handleRelatedFeatureObserverChange(){this._unobserveRelatedFeatureObserver();const{state:t,showAllEnabled:e}=this.viewModel;await _t(0),this._relatedFeatureIntersectionObserverNode&&"ready"===t&&e&&this._relatedFeatureIntersectionObserver.observe(this._relatedFeatureIntersectionObserverNode)}_relatedFeatureIntersectionObserverCreated(t){this._relatedFeatureIntersectionObserverNode=t}_unobserveRelatedFeatureObserver(){this._relatedFeatureIntersectionObserverNode&&this._relatedFeatureIntersectionObserver.unobserve(this._relatedFeatureIntersectionObserverNode)}};c([u()],ts.prototype,"_relatedFeatureIntersectionObserverNode",void 0),c([u({readOnly:!0})],ts.prototype,"displayShowAllButton",null),c([u({readOnly:!0})],ts.prototype,"displayListItems",null),c([u()],ts.prototype,"description",null),c([u({readOnly:!0})],ts.prototype,"featureCountDescription",null),c([u()],ts.prototype,"headingLevel",void 0),c([u()],ts.prototype,"title",null),c([u({type:Zi})],ts.prototype,"viewModel",void 0),c([u(),F("esri/widgets/Feature/t9n/Feature")],ts.prototype,"messages",void 0),c([u(),F("esri/t9n/common")],ts.prototype,"messagesCommon",void 0),c([u()],ts.prototype,"visibleElements",void 0),c([d("visibleElements")],ts.prototype,"castVisibleElements",null),ts=c([m("esri.widgets.Feature.FeatureRelationship")],ts);const es=ts;class is{constructor(t,e){this.preLayerQueryCallback=t,this.preRequestCallback=e,this.preLayerQueryCallback||(this.preLayerQueryCallback=t=>{}),this.preRequestCallback||(this.preLayerQueryCallback=t=>{})}}var ss;const ns=1,rs="content-view-models",as="relationship-view-models",os={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0};let ls=ss=class extends(ft(f)){constructor(t){super(t),this._error=null,this._featureAbortController=null,this._graphicChangedThrottled=ce(this._graphicChanged,ns,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...os},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.location=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=t=>{const{abilities:e}=this;return"attachments"===t.type&&!!e.attachmentsContent||"custom"===t.type&&!!e.customContent||"fields"===t.type&&!!e.fieldsContent||"media"===t.type&&!!e.mediaContent||"text"===t.type&&!!e.textContent||"expression"===t.type&&!!e.expressionContent||"relationship"===t.type&&!!e.relationshipContent},this.addHandles(g((()=>[this.graphic,this._effectivePopupTemplate,this.abilities,this.timeZone]),(()=>this._graphicChangedThrottled()),v))}initialize(){this.addHandles(this._graphicChangedThrottled)}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return null!=this.graphic?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return Ft(It(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return y(this.graphic)}castAbilities(t){return{...os,...t}}get isTable(){return this._sourceLayer?.isTable||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(t){this._set("graphic",t?.clone()??null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get timeZone(){return this.view?.timeZone??At}set timeZone(t){this._overrideIfSome("timeZone",t)}get map(){return this.view?.map||null}set map(t){this._override("map",t)}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(t,e){const i=this.contentViewModels[t];i instanceof vi&&i.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof vi&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof vi&&e.previous()}async updateGeometry(){const{graphic:t,spatialReference:e,_sourceLayer:i}=this;await(i?.load());const s=i?.objectIdField;if(!s||!t||!i)return;const n=t?.attributes?.[s];if(null==n)return;const r=[n];if(!t.geometry){const s=await Ct({layer:i,graphic:t,outFields:[],objectIds:r,returnGeometry:!0,spatialReference:e}),n=s?.geometry;n&&(t.geometry=n)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:t}=this;if(!t)return;const e=new AbortController;this._featureAbortController=e;try{await this._queryFeature({signal:e.signal})}catch(e){xt(e)||(this._error=e,j.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:e,graphic:t,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===e&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:t}=this;t&&t.abort(),this._featureAbortController=null}_compileContentElement(t,e){return"attachments"===t.type?this._compileAttachments(t,e):"custom"===t.type?this._compileCustom(t,e):"fields"===t.type?this._compileFields(t,e):"media"===t.type?this._compileMedia(t,e):"text"===t.type?this._compileText(t,e):"expression"===t.type?this._compileExpression(t,e):"relationship"===t.type?this._compileRelationship(t,e):void 0}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.filter(this._isAllowedContentType).map(((t,e)=>this._compileContentElement(t,e))).filter(G):"string"==typeof t?this._compileText(new dt({text:t}),0).text:t}_destroyContentViewModels(){this.removeHandles(as),this.removeHandles(rs),this.contentViewModels.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("contentViewModels",[])}_matchesFeature(t,e){const i=t?.graphic?.getObjectId(),s=e?.getObjectId();return null!=i&&null!=s&&i===s}_setRelatedFeaturesViewModels({relatedFeatureViewModels:t,relatedFeatures:e,map:i}){const{view:s,spatialReference:n}=this;e?.filter(Boolean).forEach((e=>{t.some((t=>this._matchesFeature(t,e)))||t.add(new ss({abilities:{relationshipContent:!1},map:i,view:s,spatialReference:n,graphic:e}))})),t.forEach((i=>{const s=e?.find((t=>this._matchesFeature(i,t)));s||t.remove(i)}))}_setExpressionContentVM(t,e){const i=this.formattedAttributes,{contentElement:s,contentElementViewModel:n}=t,r=s?.type;n&&r&&("fields"===r&&(this._createFieldsFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:i}),n.set(this._createFieldsVMParams(s,e))),"media"===r&&(this._createMediaFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:i}),n.set(this._createMediaVMParams(s,e))),"text"===r&&n.set(this._createTextVMParams(s)))}_compileRelationship(t,e){const{displayCount:i,orderByFields:s,relationshipId:n,title:r,description:a}=t,{_sourceLayer:o,graphic:l,map:h}=this;if(!Mt(o))return;const c=new Zi({displayCount:i,graphic:l,orderByFields:s,relationshipId:n,layer:o,map:h,...this._compileTitleAndDesc({title:r,description:a})});return this.contentViewModels[e]=c,this.addHandles(A((()=>c.relatedFeatures),"change",(()=>this._setRelatedFeaturesViewModels(c))),as),t}_compileExpression(t,e){const{expressionInfo:i}=t,{graphic:s,map:n,spatialReference:r,view:a,location:o}=this,l=new Di({expressionInfo:i,graphic:s,interceptor:ss.interceptor,map:n,spatialReference:r,view:a,location:o});return this.contentViewModels[e]=l,this.addHandles(g((()=>l.contentElementViewModel),(()=>this._setExpressionContentVM(l,e)),v),rs),t}_compileAttachments(t,e){const{graphic:i}=this,{description:s,title:n}=t;return this.contentViewModels[e]=new ke({graphic:i,...this._compileTitleAndDesc({title:n,description:s})}),t}_compileCustom(t,e){const{graphic:i}=this,{creator:s,destroyer:n}=t;return this.contentViewModels[e]=new Se({graphic:i,creator:s,destroyer:n}),t}_compileTitleAndDesc({title:t,description:e}){const{_fieldInfoMap:i,_sourceLayer:s,graphic:n,formattedAttributes:r}=this,a=n?.attributes,o=this._expressionAttributes,l=r.global;return{title:Z({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:s,text:t}),description:Z({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:s,text:e})}}_createFieldsVMParams(t,e){const i=this._effectivePopupTemplate,s=this.formattedAttributes,n={...s?.global,...s?.content[e]},r=t?.fieldInfos||i?.fieldInfos,a=r?.filter((({fieldName:t})=>et(t)||H(t)||n.hasOwnProperty(t))),o=i?.expressionInfos,{description:l,title:h}=t;return{attributes:n,expressionInfos:o,fieldInfos:a,...this._compileTitleAndDesc({title:h,description:l})}}_compileFields(t,e){const i=t.clone(),s=new He(this._createFieldsVMParams(t,e));return this.contentViewModels[e]=s,i.fieldInfos=s.formattedFieldInfos.slice(0),i}_createMediaVMParams(t,e){const{abilities:i,graphic:s,_fieldInfoMap:n,_effectivePopupTemplate:r,relatedInfos:a,_sourceLayer:o,_expressionAttributes:l}=this,h=this.formattedAttributes,c=s?.attributes??{},{description:u,mediaInfos:d,title:p}=t;return{abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:t.activeMediaInfoIndex||0,attributes:c,isAggregate:s?.isAggregate,layer:o,fieldInfoMap:n,formattedAttributes:{...h?.global,...h?.content[e]},expressionAttributes:l,mediaInfos:d,popupTemplate:r,relatedInfos:a,...this._compileTitleAndDesc({title:p,description:u})}}_compileMedia(t,e){const i=t.clone(),s=new vi(this._createMediaVMParams(t,e));return i.mediaInfos=s.formattedMediaInfos.slice(0),this.contentViewModels[e]=s,i}_createTextVMParams(t){const{graphic:e,_fieldInfoMap:i,_sourceLayer:s,_expressionAttributes:n}=this;if(t&&t.text){const r=e?.attributes??{},a=this.formattedAttributes?.global??{};t.text=Z({attributes:r,fieldInfoMap:i,globalAttributes:a,expressionAttributes:n,layer:s,text:t.text})}return{graphic:e,creator:t.text}}_compileText(t,e){const i=t.clone();return this.contentViewModels[e]=new Se(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:i,timeZone:s}=this;if(!t)return;const{lastEditInfoEnabled:n}=t,r=e?.editFieldsInfo;return n&&r?$t(r,i?.attributes,s,e):void 0}_compileTitle(t){const{_fieldInfoMap:e,_sourceLayer:i,graphic:s,_expressionAttributes:n}=this,r=s?.attributes??{},a=this.formattedAttributes?.global??{};return Z({attributes:r,fieldInfoMap:e,globalAttributes:a,expressionAttributes:n,layer:i,text:t})}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this;if(!e)return null;const i=t?.title;return P(i,{graphic:e})}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this;if(!e)return null;const i=t?.content;return P(i,{graphic:e})}async _queryFeature(t){const{_featureAbortController:e,_sourceLayer:i,graphic:s,_effectivePopupTemplate:n}=this,r=this.map,a=this.view,o=this.spatialReference,l=this.location;if(e!==this._featureAbortController||!s)return;await kt({graphic:s,popupTemplate:n,layer:i,spatialReference:o},t);const{content:{value:h},title:{value:c}}=await q({content:this._getContent(),title:this._getTitle()}),{expressionAttributes:{value:u}}=await q({checkForRelatedFeatures:this._checkForRelatedFeatures(t),expressionAttributes:Bi({expressionInfos:n?.expressionInfos,spatialReference:o,graphic:s,map:r,interceptor:ss.interceptor,view:a,options:t,location:l})});e===this._featureAbortController&&s&&(this._expressionAttributes=u,this._graphicExpressionAttributes={...s.attributes,...u},this._set("formattedAttributes",this._createFormattedAttributes(h)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(h)||null))}_createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:i}){const{_effectivePopupTemplate:s,graphic:n,relatedInfos:r,_sourceLayer:a,_fieldInfoMap:o,_graphicExpressionAttributes:l,timeZone:h}=this;i.content[e]=Et({fieldInfos:s?.fieldInfos,graphic:n,attributes:{...l,...t.attributes},layer:a,fieldInfoMap:o,relatedInfos:r,timeZone:h})}_createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:i}){if(t.fieldInfos){const{graphic:s,relatedInfos:n,_sourceLayer:r,_fieldInfoMap:a,_graphicExpressionAttributes:o,timeZone:l}=this;i.content[e]=Et({fieldInfos:t.fieldInfos,graphic:s,attributes:{...o,...t.attributes},layer:r,fieldInfoMap:a,relatedInfos:n,timeZone:l})}}_createFormattedAttributes(t){const{_effectivePopupTemplate:e,graphic:i,relatedInfos:s,_sourceLayer:n,_fieldInfoMap:r,_graphicExpressionAttributes:a,timeZone:o}=this,l=e?.fieldInfos,h={global:Et({fieldInfos:l,graphic:i,attributes:a,layer:n,fieldInfoMap:r,relatedInfos:s,timeZone:o}),content:[]};return Array.isArray(t)&&t.forEach(((t,e)=>{"fields"===t.type&&this._createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:h}),"media"===t.type&&this._createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:h})})),h}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(e,It(i),t)}async _queryRelatedInfos(t,e,i){const{relatedInfos:s,_sourceLayer:n}=this;s.clear();const r=null!=n?.associatedLayer?await(n?.associatedLayer.load(i)):n;if(!r||!t)return;const a=e.filter((t=>t&&H(t.fieldName)));if(!a?.length)return;e.forEach((t=>this._configureRelatedInfo(t,r)));const o=await ui({relatedInfos:s,layer:r},i);Object.keys(o).forEach((t=>{const e=s.get(t.toString()),i=o[t]?.value;e&&i&&(e.layerInfo=i.data)}));const l=await di({graphic:t,relatedInfos:s,layer:r},i);Object.keys(l).forEach((t=>{ni(l[t]?.value,s.get(t.toString()))}))}_configureRelatedInfo(t,e){const{relatedInfos:i}=this,s=Ke(t.fieldName);if(!s)return;const{layerId:n,fieldName:r}=s;if(!n)return;const a=i.get(n.toString())||si(n,e);a&&(pi({relatedInfo:a,fieldName:r,fieldInfo:t}),this.relatedInfos.set(n,a))}};ls.interceptor=new is(Tt,Lt),c([u()],ls.prototype,"_error",void 0),c([u()],ls.prototype,"_featureAbortController",void 0),c([u({readOnly:!0})],ls.prototype,"_effectivePopupTemplate",null),c([u({readOnly:!0})],ls.prototype,"_fieldInfoMap",null),c([u({readOnly:!0})],ls.prototype,"_sourceLayer",null),c([u()],ls.prototype,"abilities",void 0),c([d("abilities")],ls.prototype,"castAbilities",null),c([u({readOnly:!0})],ls.prototype,"content",void 0),c([u({readOnly:!0})],ls.prototype,"contentViewModels",void 0),c([u()],ls.prototype,"description",void 0),c([u({type:Boolean})],ls.prototype,"defaultPopupTemplateEnabled",void 0),c([u({readOnly:!0})],ls.prototype,"isTable",null),c([u({readOnly:!0})],ls.prototype,"state",null),c([u({readOnly:!0})],ls.prototype,"formattedAttributes",void 0),c([u({type:p,value:null})],ls.prototype,"graphic",null),c([u({readOnly:!0})],ls.prototype,"lastEditInfo",void 0),c([u({type:ct})],ls.prototype,"location",void 0),c([u({readOnly:!0})],ls.prototype,"relatedInfos",void 0),c([u()],ls.prototype,"spatialReference",null),c([u()],ls.prototype,"timeZone",null),c([u({readOnly:!0})],ls.prototype,"title",void 0),c([u()],ls.prototype,"map",null),c([u({readOnly:!0})],ls.prototype,"waitingForContent",null),c([u()],ls.prototype,"view",void 0),ls=ss=c([m("esri.widgets.Feature.FeatureViewModel")],ls);const hs=ls;const cs="esri-feature",us={base:cs,container:`${cs}__size-container`,title:`${cs}__title`,main:`${cs}__main-container`,btn:`${cs}__button`,icon:`${cs}__icon`,content:`${cs}__content`,contentNode:`${cs}__content-node`,contentNodeText:`${cs}__content-node--text`,contentElement:`${cs}__content-element`,text:`${cs}__text`,lastEditedInfo:`${cs}__last-edited-info`,fields:`${cs}__fields`,fieldHeader:`${cs}__field-header`,fieldData:`${cs}__field-data`,fieldDataDate:`${cs}__field-data--date`,loadingSpinnerContainer:`${cs}__loading-container`,spinner:`${cs}__loading-spinner`};const ds=t=>{let e=class extends t{constructor(){super(...arguments),this.renderNodeContent=t=>R(t)&&!t.destroyed?x("div",{class:us.contentNode,key:t},t.render()):t instanceof HTMLElement?x("div",{afterCreate:this._attachToNode,bind:t,class:us.contentNode,key:t}):Pt(t)?x("div",{afterCreate:this._attachToNode,bind:t.domNode,class:us.contentNode,key:t}):null}_attachToNode(t){const e=this;t.appendChild(e)}};return e=c([m("esri.widgets.Feature.ContentMixin")],e),e};var ps;const ms={title:!0,content:!0,lastEditedInfo:!0},fs="relationship-handles";let gs=ps=class extends(ds(I)){constructor(t,e){super(t,e),this._contentWidgets=[],this.flowItems=null,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.visibleElements={...ms},this.viewModel=new hs}initialize(){this.addHandles(g((()=>this.viewModel?.contentViewModels),(()=>this._setupContentWidgets()),v))}loadDependencies(){return C({notice:()=>import("./p-3a3e80ff.js")})}destroy(){this._destroyContentWidgets()}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(t){this.viewModel.defaultPopupTemplateEnabled=t}get isTable(){return this.viewModel.isTable}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(t){this.viewModel.spatialReference=t}get timeZone(){return this.viewModel.timeZone}set timeZone(t){this.viewModel.timeZone=t}get title(){return this.viewModel.title}castVisibleElements(t){return{...ms,...t}}get map(){return this.viewModel.map}set map(t){this.viewModel.map=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}setActiveMedia(t,e){return this.viewModel.setActiveMedia(t,e)}nextMedia(t){return this.viewModel.nextMedia(t)}previousMedia(t){return this.viewModel.previousMedia(t)}render(){const{state:t}=this.viewModel,e=x("div",{class:us.container,key:"container"},this._renderTitle(),"error"===t?this._renderError():"loading"===t?this._renderLoading():this._renderContentContainer());return x("div",{class:this.classes(us.base,M.widget)},e)}_renderError(){const{messagesCommon:t,messages:e,visibleElements:i}=this;return x("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:!0,scale:"s"},i.title?x("div",{key:"error-title",slot:"title"},t.errorMessage):null,x("div",{key:"error-message",slot:"message"},e.loadingError))}_renderLoading(){return x("div",{class:us.loadingSpinnerContainer,key:"loading-container"},x("span",{class:this.classes(T.loadingIndicator,M.rotating,us.spinner)}))}_renderContentContainer(){const{visibleElements:t}=this;return t.content?x("div",{class:us.main},[this._renderContent(),this._renderLastEditInfo()]):null}_renderTitle(){const{visibleElements:t,title:e}=this;return t.title?x(L,{class:us.title,innerHTML:e,level:this.headingLevel}):null}_renderContent(){const t=this.viewModel.content,e="content";if(!t)return null;if(Array.isArray(t))return t.length?x("div",{class:us.contentNode,key:`${e}-content-elements`},t.map(this._renderContentElement,this)):null;if("string"==typeof t){const t=this._contentWidgets[0];return!t||t.destroyed?null:x("div",{class:this.classes(us.contentNode,us.contentNodeText),key:`${e}-content`},t.render())}return this.renderNodeContent(t)}_renderContentElement(t,e){const{visibleElements:i}=this;if("boolean"!=typeof i.content&&!i.content?.[t.type])return null;switch(t.type){case"attachments":return this._renderAttachments(e);case"custom":return this._renderCustom(t,e);case"fields":return this._renderFields(e);case"media":return this._renderMedia(e);case"text":return this._renderText(t,e);case"expression":return this._renderExpression(e);case"relationship":return this._renderRelationship(e);default:return null}}_renderAttachments(t){const e=this._contentWidgets[t];if(!e||e.destroyed)return null;const{state:i,attachmentInfos:s}=e.viewModel;return"loading"===i||s.length>0?x("div",{class:this.classes(us.contentElement),key:this._buildKey("attachments-element",t)},e.render()):null}_renderRelationship(t){const e=this._contentWidgets[t];return e&&!e.destroyed&&this.flowItems?x("div",{class:us.contentElement,key:this._buildKey("relationship-element",t)},e.render()):null}_renderExpression(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:x("div",{class:us.contentElement,key:this._buildKey("expression-element",t)},e.render())}_renderCustom(t,e){const{creator:i}=t,s=this._contentWidgets[e];return!s||s.destroyed?null:i?x("div",{class:us.contentElement,key:this._buildKey("custom-element",e)},s.render()):null}_renderFields(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:x("div",{class:us.contentElement,key:this._buildKey("fields-element",t)},e.render())}_renderMedia(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:x("div",{class:us.contentElement,key:this._buildKey("media-element",t)},e.render())}_renderLastEditInfo(){const{visibleElements:t,messages:e}=this,{lastEditInfo:i}=this.viewModel;if(!i||!t.lastEditedInfo)return null;const{date:s,user:n}=i,r="edit"===i.type?n?e.lastEditedByUser:e.lastEdited:n?e.lastCreatedByUser:e.lastCreated,a=nt(r,{date:s,user:n});return x("div",{class:this.classes(us.lastEditedInfo,us.contentElement),key:"edit-info-element"},a)}_renderText(t,e){const i=t.text,s=this._contentWidgets[e];return!s||s.destroyed?null:i?x("div",{class:this.classes(us.contentElement,us.text),key:this._buildKey("text-element",e)},s.render()):null}_buildKey(t,...e){return`${t}__${this.viewModel?.graphic?.uid||"0"}-${e.join("-")}`}_destroyContentWidget(t){t&&(t.viewModel=null,!t.destroyed&&t.destroy())}_destroyContentWidgets(){this.removeHandles(fs),this._contentWidgets.forEach((t=>this._destroyContentWidget(t))),this._contentWidgets=[]}_addFeatureRelationshipHandles(t){const{flowItems:e,visibleElements:i}=this;this.addHandles([A((()=>t),"select-record",(({featureViewModel:t})=>{e&&(t.abilities={relationshipContent:!0},e.push(new ps({flowItems:e,viewModel:t,visibleElements:i})))})),A((()=>t),"show-all-records",(()=>{if(!e)return;const{viewModel:i}=t;i.showAllEnabled=!0;const s=new es({visibleElements:{title:!1,description:!1},viewModel:i});this._addFeatureRelationshipHandles(s),e.push(s)}))],fs)}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:t,visibleElements:e}=this,i=this.viewModel?.content,{contentViewModels:s}=this.viewModel;if(Array.isArray(i))i.forEach(((i,n)=>{if("attachments"===i.type&&(this._contentWidgets[n]=new Ve({displayType:i.displayType,headingLevel:e.title?t+1:t,viewModel:s[n]})),"fields"===i.type&&(this._contentWidgets[n]=new Ye({viewModel:s[n]})),"media"===i.type&&(this._contentWidgets[n]=new $i({viewModel:s[n]})),"text"===i.type&&(this._contentWidgets[n]=new De({viewModel:s[n]})),"custom"===i.type&&(this._contentWidgets[n]=new De({viewModel:s[n]})),"expression"===i.type&&(this._contentWidgets[n]=new Ui({viewModel:s[n]})),"relationship"===i.type){const t=new es({viewModel:s[n]});this._addFeatureRelationshipHandles(t),this._contentWidgets[n]=t}}),this);else{const t=s[0];t&&!t.destroyed&&(this._contentWidgets[0]=new De({viewModel:t}))}this.scheduleRender()}};c([u()],gs.prototype,"graphic",null),c([u()],gs.prototype,"defaultPopupTemplateEnabled",null),c([u()],gs.prototype,"flowItems",void 0),c([u()],gs.prototype,"headingLevel",void 0),c([u({readOnly:!0})],gs.prototype,"isTable",null),c([u()],gs.prototype,"label",null),c([u(),F("esri/widgets/Feature/t9n/Feature")],gs.prototype,"messages",void 0),c([u(),F("esri/t9n/common")],gs.prototype,"messagesCommon",void 0),c([u()],gs.prototype,"spatialReference",null),c([u()],gs.prototype,"timeZone",null),c([u({readOnly:!0})],gs.prototype,"title",null),c([u()],gs.prototype,"visibleElements",void 0),c([d("visibleElements")],gs.prototype,"castVisibleElements",null),c([u()],gs.prototype,"map",null),c([u()],gs.prototype,"view",null),c([u({type:hs})],gs.prototype,"viewModel",void 0),gs=ps=c([m("esri.widgets.Feature")],gs);const vs=gs;let bs=class extends Ot.EventedAccessor{constructor(t){super(t),this.location=null,this.screenLocationEnabled=!1,this.view=null,this.addHandles([Rt((()=>{const t=this.screenLocationEnabled?this.view:null;return t?[t.size,"3d"===t.type?t.camera:t.viewpoint]:null}),(()=>this.notifyChange("screenLocation"))),g((()=>this.screenLocation),((t,e)=>{null!=t&&null!=e&&this.emit("view-change")}))])}destroy(){this.view=null}get screenLocation(){const{location:t,view:e,screenLocationEnabled:i}=this,s=e?.spatialReference,n=s?Vt(t,s).geometry:null;return i&&n&&e?.ready?e.toScreen(n):null}};c([u()],bs.prototype,"location",void 0),c([u()],bs.prototype,"screenLocation",null),c([u()],bs.prototype,"screenLocationEnabled",void 0),c([u()],bs.prototype,"view",void 0),bs=c([m("esri.widgets.support.AnchorElementViewModel")],bs);const ws=bs;const ys="esri.widgets.CompassViewModel";let _s=class extends ws{constructor(t){super(t),this.visible=!1}};c([u()],_s.prototype,"visible",void 0),_s=c([m(ys)],_s);const Fs=_s;const Is="esri-spinner",As={base:Is,spinnerStart:`${Is}--start`,spinnerFinish:`${Is}--finish`};let Cs=class extends I{constructor(t,e){super(t,e),this._animationDelay=500,this._animationPromise=null,this.viewModel=new Fs}initialize(){this.addHandles(g((()=>this.visible),(t=>this._visibleChange(t))))}destroy(){this._animationPromise=null}get location(){return this.viewModel.location}set location(t){this.viewModel.location=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}get visible(){return this.viewModel.visible}set visible(t){this.viewModel.visible=t}show(t){const{location:e,promise:i}=t??{};e&&(this.viewModel.location=e),this.visible=!0;const s=()=>this.hide();i&&i.catch((()=>{})).then(s)}hide(){this.visible=!1}render(){const{visible:t}=this,{screenLocation:e}=this.viewModel,i=!!e,s=t&&i,n=!t&&i,r={[As.spinnerStart]:s,[As.spinnerFinish]:n},a=this._getPositionStyles();return x("div",{class:this.classes(As.base,r),styles:a})}_visibleChange(t){if(t)return void(this.viewModel.screenLocationEnabled=!0);const e=_t(this._animationDelay);this._animationPromise=e,e.catch((()=>{})).then((()=>{this._animationPromise===e&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)}))}_getPositionStyles(){const{screenLocation:t,view:e}=this.viewModel;if(null==e||null==t)return{};const{padding:i}=e;return{left:t.x-i.left+"px",top:t.y-i.top+"px"}}};c([u()],Cs.prototype,"location",null),c([u()],Cs.prototype,"view",null),c([u({type:Fs})],Cs.prototype,"viewModel",void 0),c([u()],Cs.prototype,"visible",null),Cs=c([m("esri.widgets.Spinner")],Cs);const xs=Cs;const Ms="esri-features",$s={icon:`${Ms}__icon`,actionImage:`${Ms}__action-image`,base:Ms,container:`${Ms}__container`,contentContainer:`${Ms}__content-container`,contentFeature:`${Ms}__content-feature`,flowItemCollapsed:`${Ms}__flow-item--collapsed`,header:`${Ms}__header`,footer:`${Ms}__footer`,featureMenuObserver:`${Ms}__feature-menu-observer`,actionExit:`${Ms}__action--exit`,loader:`${Ms}__loader`,featuresHeading:`${Ms}__heading`,paginationActionBar:`${Ms}__pagination-action-bar`,paginationPrevious:`${Ms}__pagination-previous`,paginationNext:`${Ms}__pagination-next`};let ks=class extends I{constructor(t,e){super(t,e),this.messages=null,this.closed=!1,this.closable=!0,this._handleOpenRelatedFeature=t=>{this.emit("open-related-feature",{feature:t})}}loadDependencies(){return C({action:()=>import("./p-a5d4307d.js"),"flow-item":()=>import("./p-a0b64368.js")})}render(){const{flowItems:t}=this,e=t?.toArray();return x(Nt,null,e?.map((t=>this._renderRelatedRecordsFlowItem(t))))}_handleCloseClick(){this.emit("close")}_handleExitClick(){this.emit("exit")}_handleRelatedRecordsBackClick(){const t=this.flowItems?.pop();t&&("showAllEnabled"in t.viewModel&&(t.viewModel.showAllEnabled=!1),t&&(t.viewModel=null,t.destroy()))}_renderRelatedRecordsFlowItem(t){const{messages:e,closable:i,closed:s}=this,n="graphic"in t&&!t.isTable;return x("calcite-flow-item",{bind:this,closable:i,closed:s,description:this._getRelatedRecordsFlowItemDescription(t),heading:t.title??"",key:`flow-item-${t.viewModel.uid}`,onCalciteFlowItemBack:t=>{t.preventDefault(),this._handleRelatedRecordsBackClick()},onCalciteFlowItemClose:this._handleCloseClick},x("calcite-action",{appearance:"transparent",bind:this,class:$s.actionExit,icon:"move-up",key:"exit-related-records-action",label:e.exitRelatedRecords,onclick:this._handleExitClick,scale:"m",slot:"header-actions-start",text:e.exitRelatedRecords,title:e.exitRelatedRecords}),n?x("calcite-action",{appearance:"transparent",bind:this,icon:"zoom-to-object",key:"open-related-feature-action",label:e.selectFeature,onclick:()=>this._handleOpenRelatedFeature(t),scale:"m",slot:"header-actions-end",text:e.selectFeature,title:e.selectFeature}):null,x("div",{class:$s.container},t.render()))}_getRelatedRecordsFlowItemDescription(t){return"featureCountDescription"in t?t.featureCountDescription:t.viewModel.description??""}};c([u()],ks.prototype,"flowItems",void 0),c([u(),F("esri/widgets/Features/t9n/Features")],ks.prototype,"messages",void 0),c([u()],ks.prototype,"closed",void 0),c([u()],ks.prototype,"closable",void 0),ks=c([m("esri.widgets.Features.FeaturesRelatedRecords")],ks);const Es=ks;class Ts{constructor(t){this._observable=new St,this._set=new Set(t)}get size(){return Bt(this._observable),this._set.size}add(t){const e=this._set.size;return this._set.add(t),this._set.size!==e&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(t){const e=this._set.delete(t);return e&&this._observable.notify(),e}entries(){return Bt(this._observable),this._set.entries()}forEach(t,e){Bt(this._observable),this._set.forEach(((i,s)=>t.call(e,i,s,this)),e)}has(t){return Bt(this._observable),this._set.has(t)}keys(){return Bt(this._observable),this._set.keys()}values(){return Bt(this._observable),this._set.values()}[Symbol.iterator](){return Bt(this._observable),this._set[Symbol.iterator]()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}}const Ls="OBJECTID";const Ps=h.ofType({key:"type",defaultKeyValue:"button",base:jt,typeMap:{button:zt,toggle:Dt}}),Os=new zt({icon:"magnifying-glass-plus",id:"zoom-to-feature",title:"{messages.zoom}",className:T.zoomInMagnifyingGlass}),Rs=new zt({icon:"trash",id:"remove-selected-feature",title:"{messages.remove}",className:T.trash}),Vs=new zt({icon:"magnifying-glass-plus",id:"zoom-to-clustered-features",title:"{messages.zoom}",className:T.zoomInMagnifyingGlass}),Ns=new Dt({icon:"table",id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:T.table,value:!1});const Ss="esri.widgets.Popup.PopupViewModel",Bs=()=>j.getLogger(Ss),js=t=>{const{event:e,view:i,viewModel:s}=t,{action:n}=e;if(!n)return Promise.reject(new b("trigger-action:missing-arguments","Event has no action"));const{disabled:r,id:a}=n;if(!a)return Promise.reject(new b("trigger-action:invalid-action","action.id is missing"));if(r)return Promise.reject(new b("trigger-action:invalid-action","Action is disabled"));if(a===Os.id)return Hs(s).catch(qt);if(a===Vs.id)return Ws(s);if(a===Ns.id)return s.browseClusterEnabled=!s.browseClusterEnabled,s.featureMenuOpen=s.browseClusterEnabled,Promise.resolve();if(a===Rs.id){s.visible=!1;const{selectedFeature:t}=s;if(!t)return Promise.reject(new b(`trigger-action:${Rs.id}`,"selectedFeature is required",{selectedFeature:t}));const{sourceLayer:e}=t;return e?e.remove(t):i?.graphics.remove(t),Promise.resolve()}return Promise.resolve()};function zs(t){const{selectedFeature:e,location:i,view:s}=t;return s?e??i??null:null}function Ds(t){return!!t&&t.isAggregate&&"cluster"===t.sourceLayer?.featureReduction?.type}async function qs(t,e){if("3d"!==e?.type||!t||"esri.Graphic"!==t.declaredClass)return!0;const i=e.getViewForGraphic(t);if(i&&"whenGraphicBounds"in i){let e=null;try{e=await i.whenGraphicBounds(t,{useViewElevation:!0})}catch(t){}return!e||!e.boundingBox||e.boundingBox[0]===e.boundingBox[3]&&e.boundingBox[1]===e.boundingBox[4]&&e.boundingBox[2]===e.boundingBox[5]}return!0}async function Hs(t){const{location:e,selectedFeature:i,view:s,zoomFactor:n}=t,r=zs(t);if(!s||!r){const t=new b("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:r,view:s});throw Bs().error(t),t}const a=s.scale/n,o=t.selectedFeature?.geometry,l=o??e,h=null!=l&&"point"===l.type&&await qs(i,s);Os.active=!0,Os.disabled=!0;try{await t.zoomTo({target:{target:r,scale:h?a:void 0}})}catch(t){const e=new b("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:i});Bs().error(e)}finally{Os.active=!1,Os.disabled=!1,t.zoomToLocation=null,h&&(t.location=l)}}async function Ws(t){const{selectedFeature:e,view:i}=t;if("2d"!==i?.type){const t=new b("zoomToCluster:invalid-view","View must be 2d MapView.",{view:i});throw Bs().error(t),t}if(!e||!Ds(e)){const t=new b("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:e});throw Bs().error(t),t}const[s,n]=await Ys(i,e);Vs.active=!0,Vs.disabled=!0;const{extent:r}=await s.queryExtent(n);r&&await t.zoomTo({target:r}),Vs.active=!1,Vs.disabled=!1}async function Us(t){const{view:e,selectedFeature:i}=t;if(!e||!i)return;const[s,n]=await Ys(e,i),{extent:r}=await s.queryExtent(n);t.selectedClusterBoundaryFeature.geometry=r,e.graphics.add(t.selectedClusterBoundaryFeature)}async function Xs(t){const{selectedFeature:e,view:i}=t;if(!i||!e)return;const[s,n]=await Ys(i,e);Ns.active=!0,Ns.disabled=!0;const{features:r}=await s.queryFeatures(n);Ns.active=!1,Ns.disabled=!1,Ns.value=!0,t?.open({features:[e].concat(r),featureMenuOpen:!0})}async function Ys(t,e){const i=await t.whenLayerView(e.sourceLayer),s=i.createQuery(),n=e.getObjectId();return s.aggregateIds=null!=n?[n]:[],[i,s]}function Zs(t){Ns.value=!1;const e=t.features.filter((t=>Ds(t)));e.length&&(t.features=e)}const Gs=()=>[Os.clone()],Qs=()=>[Vs.clone(),Ns.clone()];let Js=null;function Ks(t,e){return"building-scene"===t||"2d"===e&&("map-image"===t||"tile"===t||"imagery"===t||"imagery-tile"===t)}let tn=class extends(Ht(ws)){constructor(t){super(t),this._pendingPromises=new Ts,this._fetchFeaturesController=null,this._highlightSelectedFeaturePromise=null,this._highlightActiveFeaturePromise=null,this._selectedClusterFeature=null,this._locationScaleHandle=null,this.actions=new Ps,this.activeFeature=null,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.browseClusterEnabled=!1,this.content=null,this.defaultPopupTemplateEnabled=!1,this.featurePage=null,this.featuresPerPage=20,this.featureMenuOpen=!1,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new p({symbol:new Wt({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null,this._debouncedLocationUpdate=vt((async t=>{const{view:e}=this,i=this.selectedFeature?.geometry?.type,s=this.location??t;if("mesh"!==i&&e&&s&&this.selectedFeature)if("point"!==i)try{const{pendingFeatures:t}=await this._fetchFeaturesWithController({mapPoint:s}),i=(await Promise.all(t)).flat().filter(Boolean);if(!i.length)return;if(i.length!==this.features.length){const t=this._getHighlightLayer(this.selectedFeature),e="imagery"===t?.type?void 0:t&&"objectIdField"in t?t.objectIdField||Ls:null;if(e){const s=this.selectedFeature.getObjectId(),n=i.findIndex((i=>{const n=this._getHighlightLayer(i);return n?.uid===t?.uid&&i.attributes[e]===s}));this.features=i,this.selectedFeatureIndex=n}}const n=i[this.selectedFeatureIndex]?.geometry,r=("mesh"!==n?.type?n:null)??this.selectedFeature.geometry,a=r?Ut(r,e.spatialReference):null;if(!a)return;Js||(Js=await import("./p-bc6b9750.js")),await Js.intersects(a,s)||(this.location=(await Js.nearestCoordinate(a,s)).coordinate??s)}catch(t){xt(t)||j.getLogger(this).error(t)}else this.location=Xt(this.selectedFeature.geometry)??s}))}initialize(){this.addHandles([this.on("view-change",(()=>this._autoClose())),g((()=>[this.highlightEnabled,this.selectedFeature,this.visible,this.view]),(()=>this._highlightSelectedFeature())),g((()=>[this.highlightEnabled,this.activeFeature,this.visible,this.view]),(()=>this._highlightActiveFeature())),g((()=>this.view?.animation?.state),(t=>this._animationStateChange(t))),g((()=>this.location),(t=>this._locationChange(t))),g((()=>this.selectedFeature),(t=>this._selectedFeatureChange(t))),g((()=>[this.selectedFeatureIndex,this.featureCount,this.featuresPerPage]),(()=>this._selectedFeatureIndexChange())),g((()=>[this.featurePage,this.selectedFeatureIndex,this.featureCount,this.featuresPerPage,this.featureViewModels]),(()=>this._setGraphicOnFeatureViewModels())),g((()=>this.featureViewModels),(()=>this._featureViewModelsChange())),this.on("trigger-action",(t=>js({event:t,viewModel:this,view:this.view}))),Rt((()=>!this.waitingForResult),(()=>this._waitingForResultChange()),Yt),g((()=>[this.features,this.view?.map,this.view?.spatialReference,this.view?.timeZone]),(()=>this._updateFeatureVMs())),g((()=>this.view?.scale),(()=>this._viewScaleChange())),Rt((()=>!this.visible),(()=>this.browseClusterEnabled=!1)),g((()=>this.browseClusterEnabled),(t=>t?this.enableClusterBrowsing():this.disableClusterBrowsing()))])}destroy(){this._cancelFetchingFeatures(),this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null,this._locationScaleHandle?.remove(),this._locationScaleHandle=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const t=this._get("allActions")||new Ps;t.removeAll();const{actions:e,defaultActions:i,defaultPopupTemplateEnabled:s,includeDefaultActions:n,selectedFeature:r}=this,a=n?i.concat(e):e,o=r&&("function"==typeof r.getEffectivePopupTemplate&&r.getEffectivePopupTemplate(s)||r.popupTemplate),l=o?.actions,h=o?.overwriteActions?l:l?.concat(a)??a;return h?.filter(Boolean).forEach((e=>t.add(e))),t}get defaultActions(){const t=this._get("defaultActions")||new Ps;return t.removeAll(),t.addMany(Ds(this.selectedFeature)?Qs():Gs()),t}get featureCount(){return this.features.length}set features(t){const e=t||[];this._set("features",e);const{pendingPromisesCount:i,promiseCount:s,selectedFeatureIndex:n}=this,r=s&&e.length;r&&i&&-1===n?this.selectedFeatureIndex=0:r&&-1!==n||(this.selectedFeatureIndex=e.length?0:-1)}set location(t){let e=t;const i=this.view?.spatialReference?.isWebMercator,s=t?.spatialReference?.isWGS84;s&&i&&(e=Zt(t)),this._set("location",e)}get pendingPromisesCount(){return this._pendingPromises.size}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(t){this._pendingPromises.clear(),this.features=[],Array.isArray(t)&&t.length?(this._set("promises",t),(t=t.slice(0)).forEach((t=>this._pendingPromises.add(t))),t.reduce(((t,e)=>t.finally((()=>e.then((t=>{this._pendingPromises.has(e)&&this._updateFeatures(t)})).finally((()=>this._pendingPromises.delete(e))).catch((()=>{}))))),Promise.resolve())):this._set("promises",[])}get selectedFeature(){const{features:t,selectedFeatureIndex:e}=this;if(-1===e)return null;return t[e]||null}get selectedFeatureIndex(){const t=this._get("selectedFeatureIndex");return"number"==typeof t?t:-1}set selectedFeatureIndex(t){const{featureCount:e}=this;t=isNaN(t)||t<-1||!e?-1:(t+e)%e,this.activeFeature=null,this._set("selectedFeatureIndex",t)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.view?.ready?"ready":"disabled"}get waitingForContents(){return this.featureViewModels.some((t=>t.waitingForContent))}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||0!==this.featureCount)}centerAtLocation(){const{view:t}=this,e=zs(this);return e&&t?this.callGoTo({target:{target:e,scale:t.scale}}):Promise.reject(new b("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:e,view:t}))}zoomTo(t){return this.callGoTo(t)}clear(){this.set({promises:[],features:[],content:null,title:null,location:null,activeFeature:null})}fetchFeatures(t,e){const{view:i}=this;if(!i||!t)throw new b("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:t,view:i});return i.fetchPopupFeatures(t,{pointerType:e?.event?.pointerType,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:e?.signal})}open(t){const e={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...t,visible:!0},{fetchFeatures:i}=e;delete e.fetchFeatures,i&&this._setFetchFeaturesPromises(e.location);const s=["actionsMenuOpen","collapsed"];for(const t of s)delete e[t];this.set(e)}triggerAction(t){const e=this.allActions.at(t);e&&!e.disabled&&this.emit("trigger-action",{action:e})}next(){return this.selectedFeatureIndex++,this}previous(){return this.selectedFeatureIndex--,this}disableClusterBrowsing(){Zs(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){const{view:t,selectedFeature:e}=this;"2d"===t?.type?Ds(e)?(await Us(this),await Xs(this)):j.getLogger(this).warn("enableClusterBrowsing:invalid-selectedFeature: Selected feature must represent an aggregate/cluster graphic.",e):j.getLogger(this).warn("enableClusterBrowsing:invalid-view: View must be 2d MapView.",e)}handleViewClick(t){this.autoOpenEnabled&&this._fetchFeaturesAndOpen(t)}_animationStateChange(t){this.zoomToLocation||(Os.disabled="waiting-for-target"===t)}_clearBrowsedClusterGraphics(){const t=[this.selectedClusterBoundaryFeature,this._selectedClusterFeature].filter(G);this.view?.graphics?.removeMany(t),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){if(Ds(this.selectedFeature))return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.features=this.selectedFeature?[this.selectedFeature]:[])}_locationChange(t){const{selectedFeature:e,updateLocationEnabled:i}=this;i&&t&&(!e||e.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:t,featureCount:e,featurePage:i,featuresPerPage:s,featureViewModels:n}=this;if(null===i)return;const r=((i-1)*s+e)%e,a=r+s;n.slice(r,a).forEach(((e,i)=>{e&&(e.graphic??=t[r+i])}))}async _selectedFeatureChange(t){const{location:e,updateLocationEnabled:i,view:s}=this;if(t&&s){if(this.browseClusterEnabled){if(this._selectedClusterFeature&&(s.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),Ds(t))return;return t.symbol=await Gt(t),this._selectedClusterFeature=t,void s.graphics.add(this._selectedClusterFeature)}if(t.symbol=await Gt(t),!i&&e||!t.geometry){if(i&&!t.geometry){await this.centerAtLocation();const t=s.center?.clone();t&&(this.location=t)}}else this.location=Xt(t.geometry)}}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}async _setFetchFeaturesPromises(t){const{pendingFeatures:e}=await this._fetchFeaturesWithController({mapPoint:t});this.promises=e}_destroyFeatureVMs(){this.featureViewModels.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:t,features:e,featureViewModels:i,view:s}=this;if(Ds(t)||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!e?.length)return;const n=i.slice(0),r=[];e.forEach(((e,i)=>{if(!e)return;let a=null;if(n.some(((t,i)=>(t&&t.graphic===e&&(a=t,n.splice(i,1)),!!a))),a)r[i]=a;else{const n=new hs({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:s?.spatialReference,graphic:e===t?e:null,location:this.location,map:s?.map,view:s});r[i]=n}})),n.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("featureViewModels",r)}async _getScreenPoint(t,e){const{view:i}=this;await(i?.when());const s=t?.spatialReference,n=i?.spatialReference;return s&&n?(await Qt(s,n,null,e),i.toScreen(t)):null}_cancelFetchingFeatures(){const t=this._fetchFeaturesController;t&&t.abort(),this._fetchFeaturesController=null}async _projectScreenPointAndFetchFeatures({mapPoint:t,screenPoint:e,event:i,signal:s}){return this.fetchFeatures(e??await this._getScreenPoint(t??this.location,{signal:s}),{signal:s,event:i})}_fetchFeaturesWithController({mapPoint:t,screenPoint:e,event:i}){this._cancelFetchingFeatures();const s=new AbortController,{signal:n}=s;this._fetchFeaturesController=s;const r=this._projectScreenPointAndFetchFeatures({mapPoint:t,screenPoint:e,signal:n,event:i});return r.catch((()=>{})).then((()=>{this._fetchFeaturesController=null})),r}async _fetchFeaturesAndOpen(t){const{mapPoint:e,screenPoint:i}=t,{view:s}=this;this._locationScaleHandle?.remove(),this._locationScaleHandle=g((()=>this.view?.scale),(()=>this._debouncedLocationUpdate(e).catch((t=>{xt(t)||j.getLogger(this).error(t)}))));const{pendingFeatures:n}=await this._fetchFeaturesWithController({mapPoint:e,screenPoint:i,event:t});s?.popup&&"open"in s.popup&&s.popup.open({location:e??void 0,promises:n})}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}async _getLayerView(t,e){return await t.when(),t.whenLayerView(e)}_getHighlightLayer(t){const{layer:e,sourceLayer:i}=t;return i&&"layer"in i&&i.layer?i.layer:"map-notes"===i?.type||"subtype-group"===i?.type?i:e}_getHighlightTarget(t,e,i){if(Ks(e.type,i))return t;const s=t.getObjectId();if(null!=s)return s;const n="imagery"===e.type?void 0:"objectIdField"in e?e.objectIdField||Ls:null,r=t.attributes;return r&&n&&r[n]||t}_mapIncludesLayer(t){return!!this.view?.map?.allLayers?.includes(t)}async _highlightActiveFeature(){const t="highlight-active-feature";this.removeHandles(t);const{highlightEnabled:e,view:i,activeFeature:s,visible:n}=this;if(!(s&&i&&e&&n))return;const r=this._getHighlightLayer(s);if(!(r&&r instanceof Jt&&this._mapIncludesLayer(r)))return;const a=this._getLayerView(i,r);this._highlightActiveFeaturePromise=a;const o=await a;if(!(o&&Kt(o)&&this._highlightActiveFeaturePromise===a&&this.activeFeature&&this.highlightEnabled))return;const l=o.highlight(this._getHighlightTarget(s,r,i.type));this.addHandles(l,t)}async _highlightSelectedFeature(){const t="highlight-selected-feature";this.removeHandles(t);const{selectedFeature:e,highlightEnabled:i,view:s,visible:n}=this;if(!(e&&s&&i&&n))return;const r=this._getHighlightLayer(e);if(!(r&&r instanceof Jt&&this._mapIncludesLayer(r)))return;const a=this._getLayerView(s,r);this._highlightSelectedFeaturePromise=a;const o=await a;if(!(o&&Kt(o)&&this._highlightSelectedFeaturePromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const l=o.highlight(this._getHighlightTarget(e,r,s.type));this.addHandles(l,t)}_updateFeatures(t){const{features:e}=this,i=t.filter((t=>!e.includes(t)));i?.length&&(this.features=e.concat(i))}};c([u()],tn.prototype,"_fetchFeaturesController",void 0),c([u({type:Ps})],tn.prototype,"actions",void 0),c([u({readOnly:!0})],tn.prototype,"active",null),c([u()],tn.prototype,"activeFeature",void 0),c([u({readOnly:!0})],tn.prototype,"allActions",null),c([u()],tn.prototype,"autoCloseEnabled",void 0),c([u()],tn.prototype,"autoOpenEnabled",void 0),c([u()],tn.prototype,"browseClusterEnabled",void 0),c([u()],tn.prototype,"content",void 0),c([u({type:Ps,readOnly:!0})],tn.prototype,"defaultActions",null),c([u({type:Boolean})],tn.prototype,"defaultPopupTemplateEnabled",void 0),c([u({readOnly:!0})],tn.prototype,"featureCount",null),c([u()],tn.prototype,"featurePage",void 0),c([u({value:[]})],tn.prototype,"features",null),c([u()],tn.prototype,"featuresPerPage",void 0),c([u()],tn.prototype,"featureMenuOpen",void 0),c([u()],tn.prototype,"featureViewModelAbilities",void 0),c([u({readOnly:!0})],tn.prototype,"featureViewModels",void 0),c([u()],tn.prototype,"highlightEnabled",void 0),c([u()],tn.prototype,"includeDefaultActions",void 0),c([u({type:ct})],tn.prototype,"location",null),c([u({readOnly:!0})],tn.prototype,"pendingPromisesCount",null),c([u({readOnly:!0})],tn.prototype,"promiseCount",null),c([u()],tn.prototype,"promises",null),c([u({readOnly:!0})],tn.prototype,"selectedClusterBoundaryFeature",void 0),c([u({value:null,readOnly:!0})],tn.prototype,"selectedFeature",null),c([u({value:-1})],tn.prototype,"selectedFeatureIndex",null),c([u({readOnly:!0})],tn.prototype,"selectedFeatureViewModel",null),c([u({readOnly:!0})],tn.prototype,"state",null),c([u()],tn.prototype,"title",void 0),c([u()],tn.prototype,"updateLocationEnabled",void 0),c([u()],tn.prototype,"view",void 0),c([u()],tn.prototype,"visible",void 0),c([u({readOnly:!0})],tn.prototype,"waitingForContents",null),c([u({readOnly:!0})],tn.prototype,"waitingForResult",null),c([u()],tn.prototype,"zoomFactor",void 0),c([u()],tn.prototype,"zoomToLocation",void 0),c([u()],tn.prototype,"centerAtLocation",null),tn=c([m("esri.widgets.Features.FeaturesViewModel")],tn);const en=tn;let sn=class extends f{constructor(){super(...arguments),this.actionBar=!0,this.closeButton=!0,this.collapseButton=!1,this.featureNavigation=!0,this.flow=!0,this.heading=!0,this.spinner=!0}};c([u({type:Boolean,nonNullable:!0})],sn.prototype,"actionBar",void 0),c([u({type:Boolean,nonNullable:!0})],sn.prototype,"closeButton",void 0),c([u({type:Boolean,nonNullable:!0})],sn.prototype,"collapseButton",void 0),c([u({type:Boolean,nonNullable:!0})],sn.prototype,"featureNavigation",void 0),c([u({type:Boolean,nonNullable:!0})],sn.prototype,"flow",void 0),c([u({type:Boolean,nonNullable:!0})],sn.prototype,"heading",void 0),c([u({type:Boolean,nonNullable:!0})],sn.prototype,"spinner",void 0),sn=c([m("esri.widgets.Features.FeaturesVisibleElements")],sn);const nn=sn;const rn="selected-index",an=0,on="features-spinner",ln=50;let hn=class extends(ds(I)){constructor(t,e){super(t,e),this._featureMenuIntersectionObserverCallback=([t])=>{t?.isIntersecting&&null!=this.viewModel.featurePage&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._featureMenuIntersectionObserverNode=null,this._focusOn=null,this._spinner=null,this._feature=null,this._relatedRecordsFlowItems=new h,this._relatedRecordsWidget=new Es({flowItems:this._relatedRecordsFlowItems}),this._rootFlowItemNode=null,this._featureMenuViewportNode=null,this._actionBarMenuNode=null,this.collapsed=!1,this.icon=null,this.featureNavigationTop=!1,this.headerActions=new Ps,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.responsiveActionsEnabled=!1,this.viewModel=new en,this.visibleElements=new nn,this._renderAction=(t,e)=>{const i=this._getActionTitle(t),{type:s,active:n,uid:r,disabled:a,indicator:o}=t;return t.visible?x("calcite-action",{active:"toggle"===s&&t.value,appearance:"solid",bind:this,"data-action-uid":r,disabled:a,icon:this._getActionIcon(t),indicator:o,key:`action-${e}`,loading:n,onclick:this._triggerAction,scale:"s",text:i,title:this._hideActionText?i:void 0},this._getFallbackIcon(t)):null},this._openFeatureMenu=()=>{this.featureMenuOpen=!0,this._focusOn="menu-flow-item"},this._previousFeature=()=>{this.viewModel.selectedFeatureIndex--},this._nextFeature=()=>{this.viewModel.selectedFeatureIndex++},this._handleFeatureMenuBack=()=>{this.featureMenuOpen&&(this._focusOn="root-flow-item",this.featureMenuOpen=!1)},this._focusFlowItemNode=t=>{this._focusOn===t&&requestAnimationFrame((async()=>{switch(t){case"menu-flow-item":await(this._featureMenuViewportNode?.setFocus());break;case"root-flow-item":await(this._rootFlowItemNode?.setFocus())}this._focusOn=null}))},this._focusFlowItemNodeThrottled=ce(this._focusFlowItemNode,ln),this._displaySpinnerThrottled=ce((()=>this._displaySpinner()),an),this._addSelectedFeatureIndexHandle(),this.addHandles([this._displaySpinnerThrottled,this._focusFlowItemNodeThrottled,g((()=>this.viewModel?.active),(()=>this._toggleScreenLocationEnabled())),g((()=>this.viewModel?.active),(t=>this._relatedRecordsWidget.closed=!t)),g((()=>this.visibleElements?.closeButton),(t=>this._relatedRecordsWidget.closable=t)),g((()=>this.visibleElements?.spinner),(t=>this._spinnerEnabledChange(t))),g((()=>this.viewModel?.view),((t,e)=>this._viewChange(t,e))),g((()=>this.viewModel?.view?.ready),((t,e)=>this._viewReadyChange(t??!1,e??!1))),g((()=>[this.viewModel?.waitingForResult,this.viewModel?.location]),(()=>{this._hideSpinner(),this._displaySpinnerThrottled()})),g((()=>this.viewModel?.screenLocation),(()=>this._closeOpenActionMenu())),g((()=>this.selectedFeatureWidget),(()=>this._destroyRelatedRecordsFlowItemWidgets())),g((()=>{const t=this.selectedFeatureWidget?.viewModel;return[t?.title,t?.state]}),(()=>this._setTitleFromFeatureWidget())),g((()=>{const t=this.selectedFeatureWidget?.viewModel;return[t?.content,t?.state]}),(()=>this._setContentFromFeatureWidget())),g((()=>this.viewModel?.featureViewModels),(()=>this._featureMenuViewportScrollTop())),this._relatedRecordsWidget.on("close",(()=>this.close())),this._relatedRecordsWidget.on("exit",(()=>this._destroyRelatedRecordsFlowItemWidgets())),this._relatedRecordsWidget.on("open-related-feature",(({feature:t})=>this._openRelatedFeature(t)))])}loadDependencies(){return C({action:()=>import("./p-a5d4307d.js"),"action-bar":()=>import("./p-584ca164.js"),"action-group":()=>import("./p-7dc73e8d.js"),button:()=>import("./p-370a85c2.js"),flow:()=>import("./p-ae790646.js"),"flow-item":()=>import("./p-a0b64368.js"),list:()=>import("./p-25a5a898.js"),"list-item":()=>import("./p-ef7720e4.js"),"list-item-group":()=>import("./p-b5be6ed9.js"),loader:()=>import("./p-aff53eee.js")})}destroy(){this._destroyRelatedRecordsFlowItemWidgets(),this._destroySelectedFeatureWidget(),this._destroySpinner(),this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver?.disconnect(),this._relatedRecordsWidget?.destroy()}get _hideActionText(){if(!this.responsiveActionsEnabled)return!1;const t=this.view?.widthBreakpoint;return"xsmall"===t||"small"===t||"medium"===t}get _featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}get _isCollapsed(){return this._collapseEnabled&&this.collapsed}get _collapseEnabled(){return this.visibleElements.collapseButton&&!!this.title&&!!this.content}get content(){return this.viewModel.content}set content(t){this.viewModel.content=t}get featureMenuOpen(){return this.viewModel.featureMenuOpen}set featureMenuOpen(t){this.viewModel.featureMenuOpen=t}get features(){return this.viewModel.features}set features(t){this.viewModel.features=t}get location(){return this.viewModel.location}set location(t){this.viewModel.location=t}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}get promises(){return this.viewModel.promises}set promises(t){this.viewModel.promises=t}get selectedFeature(){return this.viewModel.selectedFeature}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(t){this.viewModel.selectedFeatureIndex=t}get selectedFeatureWidget(){const{_feature:t,headingLevel:e,_relatedRecordsFlowItems:i}=this,{selectedFeatureViewModel:s}=this.viewModel,n={title:!1};return s?(t?(t.viewModel=s,t.visibleElements=n):this._feature=new vs({flowItems:i,headingLevel:e+1,viewModel:s,visibleElements:n}),this._feature):null}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(t){this.viewModel.updateLocationEnabled=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}get visible(){return this.viewModel.visible}set visible(t){this.viewModel.visible=t}blur(){const{active:t}=this.viewModel;t?this._rootFlowItemNode?.blur():j.getLogger(this).warn("Features can only be blurred when currently active.")}clear(){return this.viewModel.clear()}close(){this.viewModel.visible=!1}fetchFeatures(t,e){return this.viewModel.fetchFeatures(t,e)}focus(){const{active:t}=this.viewModel;t?this._setFocusOn():j.getLogger(this).warn("Features can only be focused when currently active.")}next(){return this.viewModel.next()}open(t){this.removeHandles(rn);const e={collapsed:t?.collapsed??!1};this.set(e),this.viewModel.open(t),this.addHandles(Rt((()=>!this.viewModel.waitingForResult),(()=>this._addSelectedFeatureIndexHandle()),{once:!0}))}previous(){return this.viewModel.previous()}triggerAction(t){return this.viewModel.triggerAction(t)}render(){return x("div",{bind:this,class:this.classes($s.base,M.widget,M.panel),onkeydown:this._onMainKeydown},this._renderHeader(),this._renderContentContainer())}_renderFeatureNavigation(){return[this._renderPagination(),this._renderFeatureMenuButton()]}_renderHeader(){return!this.featureMenuOpen&&this.featureNavigationTop&&this._featureNavigationVisible?x("div",{class:$s.header,key:"header-actions"},this._renderFeatureNavigation()):null}_renderFooter(){return this.featureMenuOpen||this.featureNavigationTop||!this._featureNavigationVisible?null:x("div",{class:$s.footer,key:"footer-actions",slot:"footer"},this._renderFeatureNavigation())}_renderFeatureMenuButton(){const{messages:t,viewModel:e}=this,{featureCount:i,selectedFeatureIndex:s,pendingPromisesCount:n}=e;return x("calcite-action",{appearance:"solid",bind:this,icon:"list",key:"feature-menu-button",label:t.selectFeature,loading:n>0,onclick:this._openFeatureMenu,scale:"s",text:nt(t.pageText,{index:l(s+1),total:l(i)}),textEnabled:!0,title:t.selectFeature})}_renderPagination(){const{previous:t,next:e}=this.messagesCommon.pagination;return x("calcite-action-bar",{class:$s.paginationActionBar,expandDisabled:!0,key:"pagination-action-bar",layout:"horizontal",overflowActionsDisabled:!0,scale:"s"},x("calcite-action-group",{scale:"s"},x("calcite-action",{appearance:"solid",class:$s.paginationPrevious,icon:"chevron-left",iconFlipRtl:!0,label:t,onclick:this._previousFeature,scale:"s",text:t,title:t}),x("calcite-action",{appearance:"solid",icon:"chevron-right",iconFlipRtl:!0,label:e,onclick:this._nextFeature,scale:"s",text:e,title:e})))}_renderFeatureMenuItem(t){const{selectedFeatureViewModel:e,featureViewModels:i}=this.viewModel,s=t===e,n=i.indexOf(t);return x("calcite-list-item",{bind:this,"data-feature-index":n,key:`feature-menu-item-${t.uid}`,onblur:this._removeActiveFeature,onfocus:this._setActiveFeature,onmouseleave:this._removeActiveFeature,onmouseover:this._setActiveFeature,selected:s,onCalciteListItemSelect:this._selectFeature},x("span",{innerHTML:t.title||this.messagesCommon.untitled,slot:"content"}))}_groupResultsByLayer(){const{featureViewModels:t}=this.viewModel,e=new Map;return t.forEach((t=>{const i=t?.graphic;if(!i)return;const s=i.sourceLayer??i.layer,n=e.get(s)??[];e.set(s,[...n,t])})),e}_renderFeatureMenu(){const{featureViewModels:t}=this.viewModel,e=this._groupResultsByLayer();return t.length?x("calcite-list",{selectionAppearance:"icon",selectionMode:"single"},Array.from(e.keys()).map((t=>x("calcite-list-item-group",{heading:t?.title??this.messagesCommon.untitled,key:t?.uid||"untitled"},e.get(t)?.map((t=>this._renderFeatureMenuItem(t))))))):null}_renderHeaderAction(t,e){return t.visible?x("calcite-action",{active:"toggle"===t.type&&t.value,appearance:"solid",bind:this,"data-action-uid":t.uid,disabled:t.disabled,icon:t.icon||"",indicator:t.indicator,key:`header-action-${e}`,loading:t.active,onclick:this._triggerHeaderAction,scale:"m",slot:"header-actions-end",text:t.title||"",title:t.title||""}):null}_renderHeaderActions(){return this.headerActions.map(((t,e)=>this._renderHeaderAction(t,e))).toArray()}_renderContentFeature(){const{headingLevel:t,visibleElements:e,_isCollapsed:i,_collapseEnabled:s,featureNavigationTop:n}=this,{title:r,active:a}=this.viewModel,o=e.heading&&r?r:"";return x("calcite-flow-item",{afterCreate:this._storeRootFlowItemNode,afterUpdate:this._focusRootFlowItemNode,bind:this,class:this.classes({[$s.contentFeature]:!0,[$s.flowItemCollapsed]:i}),closable:e.closeButton,closed:!a,collapsed:i,collapseDirection:n?"down":"up",collapsible:s,headingLevel:t,key:"root-flow-item",onCalciteFlowItemClose:this.close,onCalciteFlowItemToggle:this._handleCollapseToggle},o?x(L,{class:this.classes($s.featuresHeading,M.heading),innerHTML:o,key:"header-content",level:this.headingLevel,slot:"header-content"}):null,this._renderHeaderActions(),this._renderActionBar(),i?null:x("div",{class:this.classes($s.container,$s.contentContainer)},this._renderContent()),this._renderFooter())}_renderFeatureMenuContainer(){const{viewModel:t,featureMenuOpen:e,messages:i,messagesCommon:s}=this,{active:n,featureViewModels:r,pendingPromisesCount:a}=t;return e?x("calcite-flow-item",{afterCreate:this._storeFeatureMenuFlowItemNode,afterUpdate:this._focusFeatureMenuFlowItemNode,bind:this,closable:!1,closed:!n,description:nt(i.total,{total:r.length}),heading:i.selectFeature,key:"feature-menu",loading:t.waitingForContents,onCalciteFlowItemBack:t=>{t.preventDefault(),this._handleFeatureMenuBack()}},a>0?x("calcite-loader",{class:$s.loader,inline:!0,key:"feature-menu-loader",label:s.loading,scale:"m",slot:"header-actions-end"}):null,x("div",{class:$s.container},this._renderFeatureMenu()),x("div",{afterCreate:this._featureMenuIntersectionObserverCreated,bind:this,class:$s.featureMenuObserver}),x("calcite-button",{appearance:"transparent",onclick:this._handleFeatureMenuBack,slot:"footer-actions",width:"full"},s.back)):null}_renderContentContainer(){const t=[this._renderContentFeature(),this._renderFeatureMenuContainer(),this._relatedRecordsWidget.render()];return this.visibleElements.flow?x("calcite-flow",{key:"content-container"},t):t}_getFallbackIcon(t){const{className:e,icon:i}=t;if(i)return null;const s=te({action:t,feature:this.selectedFeature}),n={[$s.icon]:!!e,[$s.actionImage]:!!s};return e&&(n[e]=!0),s||e?x("span",{"aria-hidden":"true",class:this.classes($s.icon,n),key:"icon",styles:ee(s)}):null}_renderActionBar(){return!this._isCollapsed&&this.visibleElements.actionBar&&this.viewModel.allActions?.length?x("calcite-action-bar",{expandDisabled:!0,expanded:!this._hideActionText,key:"header-action-bar",scale:"s",slot:"action-bar"},x("calcite-action-group",{afterCreate:t=>this._actionBarMenuNode=t,overlayPositioning:"fixed",scale:"s"},this._renderActions())):null}_renderActions(){return this.viewModel.allActions.toArray().map(this._renderAction)}_renderContent(){const t=this.viewModel?.content;return t?"string"==typeof t?x("div",{class:us.contentNode,innerHTML:t,key:t}):this.renderNodeContent(t):null}_setFocusOn(){this.renderNow(),requestAnimationFrame((()=>{this._focusOn=this.featureMenuOpen?"menu-flow-item":"root-flow-item"}))}_handleCollapseToggle(){this.collapsed=!this.collapsed}async _openRelatedFeature(t){await t.viewModel.updateGeometry();const e=t.graphic,i=e?.geometry;if(null==i||null==e)return;this._destroyRelatedRecordsFlowItemWidgets(),await this.viewModel.zoomTo({target:i});const s=Xt(i);this.open({features:[e],location:null!=s?s:void 0})}_focusRootFlowItemNode(){this._focusFlowItemNodeThrottled("root-flow-item")}_focusFeatureMenuFlowItemNode(){this._focusFlowItemNodeThrottled("menu-flow-item")}_storeRootFlowItemNode(t){this._rootFlowItemNode=t,this._focusFlowItemNodeThrottled("root-flow-item")}_storeFeatureMenuFlowItemNode(t){this._featureMenuViewportNode=t,this._focusFlowItemNodeThrottled("menu-flow-item")}_setActiveFeature(t){const{viewModel:e}=this,i=t.currentTarget["data-feature-index"];e.activeFeature=e.features?.[i]||null}_removeActiveFeature(){this.viewModel.activeFeature=null}_selectFeature(t){const e=t.currentTarget["data-feature-index"];isNaN(e)||(this.viewModel.selectedFeatureIndex=e),this._handleFeatureMenuBack()}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(t){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(t),this._featureMenuIntersectionObserverNode=t}_getActionIcon(t){return t.icon?t.icon:t.image||t.className?void 0:"question"}_getActionTitle(t){const{messages:e,selectedFeature:i,messagesCommon:s}=this,{id:n}=t,r=i?.attributes,a=t.title??"",o="zoom-to-feature"===n?nt(a,{messages:e}):"remove-selected-feature"===n?nt(a,{messages:s}):"zoom-to-clustered-features"===n||"browse-clustered-features"===n?nt(a,{messages:e}):t.title;return o&&r?nt(o,r):o??""}_onMainKeydown(t){const{key:e}=t;"ArrowLeft"===e&&(t.stopPropagation(),this._handleFeatureMenuBack(),this.previous()),"ArrowRight"===e&&(t.stopPropagation(),this._handleFeatureMenuBack(),this.next())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&this._featureMenuViewportNode.scrollContentTo({top:0})}_setContentFromFeatureWidget(){const{selectedFeatureWidget:t}=this;t&&(this.viewModel.content=t)}_setTitleFromFeatureWidget(){const{selectedFeatureWidget:t,messagesCommon:e}=this,i=t?.viewModel;t&&(this.viewModel.title="error"===i?.state?e?.errorMessage:i?.title||"")}_addSelectedFeatureIndexHandle(){const t=g((()=>this.viewModel?.selectedFeatureIndex),((t,e)=>this._selectedFeatureIndexUpdated(t,e)));this.addHandles(t,rn)}_selectedFeatureIndexUpdated(t,e){const{featureCount:i}=this.viewModel;i&&t!==e&&-1!==t&&(this._destroyRelatedRecordsFlowItemWidgets(),this._rootFlowItemNode&&this._rootFlowItemNode.scrollContentTo({top:0}))}_triggerHeaderAction(t){const e=t.currentTarget;if(e.disabled)return;const i=e.dataset.actionUid,s=this.headerActions.find((({uid:t})=>t===i));s&&!s.disabled&&("toggle"===s?.type&&(s.value=!s.value),this.emit("trigger-header-action",{action:s}))}_triggerAction(t){const e=t.currentTarget;if(e.disabled)return;const i=e.dataset.actionUid,{allActions:s}=this.viewModel,n=s.findIndex((t=>t.uid===i)),r=s.at(n);r&&"toggle"===r.type&&(r.value=!r.value),this.viewModel.triggerAction(n)}_createSpinner(t){t&&(this._spinner=new xs({view:t}),t.ui.add(this._spinner,{key:on,position:"manual",internal:!0}))}_wireUpView(t){this._destroySpinner(),t&&this.visibleElements?.spinner&&this._createSpinner(t)}_hideSpinner(){const{_spinner:t}=this;t&&(t.location=null,t.hide())}_viewReadyChange(t,e){t?this._wireUpView(this.viewModel?.view):e&&this.viewModel.clear()}_viewChange(t,e){t&&e&&this.viewModel.clear()}_destroySelectedFeatureWidget(){const{_feature:t}=this;t&&(t.viewModel=null,!t.destroyed&&t.destroy()),this._feature=null}_closeOpenActionMenu(){const{_actionBarMenuNode:t}=this;t&&(t.menuOpen=!1)}_destroyRelatedRecordsFlowItemWidgets(){this._relatedRecordsFlowItems.removeAll().forEach((t=>{"showAllEnabled"in t.viewModel&&(t.viewModel.showAllEnabled=!1),t.viewModel=null,t.destroy()}))}_toggleScreenLocationEnabled(){const{viewModel:t}=this;t&&(t.screenLocationEnabled=t.active)}_displaySpinner(){const{_spinner:t}=this;if(!t)return;const{location:e,waitingForResult:i}=this.viewModel;i&&e?t.show({location:e}):t.hide()}_destroySpinner(){const{_spinner:t,view:e}=this;t&&(e?.ui?.remove(t,on),t.destroy(),this._spinner=null)}_spinnerEnabledChange(t){this._destroySpinner(),t&&this._createSpinner(this.viewModel?.view)}};c([u()],hn.prototype,"_focusOn",void 0),c([u()],hn.prototype,"_relatedRecordsFlowItems",void 0),c([u()],hn.prototype,"_hideActionText",null),c([u()],hn.prototype,"_featureNavigationVisible",null),c([u()],hn.prototype,"_isCollapsed",null),c([u()],hn.prototype,"_collapseEnabled",null),c([u()],hn.prototype,"collapsed",void 0),c([u()],hn.prototype,"content",null),c([u()],hn.prototype,"icon",void 0),c([u()],hn.prototype,"featureMenuOpen",null),c([u()],hn.prototype,"featureNavigationTop",void 0),c([u()],hn.prototype,"features",null),c([u({type:Ps})],hn.prototype,"headerActions",void 0),c([u()],hn.prototype,"headingLevel",void 0),c([u()],hn.prototype,"location",null),c([u()],hn.prototype,"label",null),c([u(),F("esri/widgets/Features/t9n/Features")],hn.prototype,"messages",void 0),c([u(),F("esri/t9n/common")],hn.prototype,"messagesCommon",void 0),c([u()],hn.prototype,"promises",null),c([u()],hn.prototype,"responsiveActionsEnabled",void 0),c([u({readOnly:!0})],hn.prototype,"selectedFeature",null),c([u()],hn.prototype,"selectedFeatureIndex",null),c([u({readOnly:!0})],hn.prototype,"selectedFeatureWidget",null),c([u()],hn.prototype,"title",null),c([u()],hn.prototype,"updateLocationEnabled",null),c([u()],hn.prototype,"view",null),c([u({type:en}),ie(["triggerAction","trigger-action"])],hn.prototype,"viewModel",void 0),c([u({type:nn,nonNullable:!0})],hn.prototype,"visibleElements",void 0),c([u()],hn.prototype,"visible",null),hn=c([m("esri.widgets.Features")],hn);const cn=hn;const un="esri-popup",dn=`${un}--is-docked`,pn={base:un,main:`${un}__main-container`,shadow:`${un}--shadow`,isDocked:dn,isDockedTopLeft:`${dn}-top-left`,isDockedTopCenter:`${dn}-top-center`,isDockedTopRight:`${dn}-top-right`,isDockedBottomLeft:`${dn}-bottom-left`,isDockedBottomCenter:`${dn}-bottom-center`,isDockedBottomRight:`${dn}-bottom-right`,alignTopCenter:`${un}--aligned-top-center`,alignBottomCenter:`${un}--aligned-bottom-center`,alignTopLeft:`${un}--aligned-top-left`,alignBottomLeft:`${un}--aligned-bottom-left`,alignTopRight:`${un}--aligned-top-right`,alignBottomRight:`${un}--aligned-bottom-right`,pointer:`${un}__pointer`,pointerDirection:`${un}__pointer-direction`};let mn=class extends en{constructor(t){super(t)}};mn=c([m("esri.widgets.Popup.PopupViewModel")],mn);const fn=mn;let gn=class extends f{constructor(){super(...arguments),this.actionBar=!0,this.closeButton=!0,this.collapseButton=!0,this.featureNavigation=!0,this.heading=!0,this.spinner=!0}};c([u({type:Boolean,nonNullable:!0})],gn.prototype,"actionBar",void 0),c([u({type:Boolean,nonNullable:!0})],gn.prototype,"closeButton",void 0),c([u({type:Boolean,nonNullable:!0})],gn.prototype,"collapseButton",void 0),c([u({type:Boolean,nonNullable:!0})],gn.prototype,"featureNavigation",void 0),c([u({type:Boolean,nonNullable:!0})],gn.prototype,"heading",void 0),c([u({type:Boolean,nonNullable:!0})],gn.prototype,"spinner",void 0),gn=c([m("esri.widgets.Features.PopupVisibleElements")],gn);const vn=gn;const bn={buttonEnabled:!0,position:"auto",breakpoint:{width:544}};let wn=class extends I{constructor(t,e){super(t,e),this._dockAction=new zt({id:"popup-dock-action"}),this._featuresWidget=new cn({responsiveActionsEnabled:!0}),this._containerNode=null,this._mainContainerNode=null,this._pointerOffsetInPx=16,this.alignment="auto",this.collapsed=!1,this.dockEnabled=!1,this.headingLevel=2,this.messages=null,this.viewModel=new fn,this.visibleElements=new vn}initialize(){this.addHandles([g((()=>[this.viewModel?.view?.widthBreakpoint,this.dockEnabled]),(()=>this._handleDockIcon()),v),g((()=>[this.dockEnabled,this.messages?.undock,this.messages?.dock]),(()=>this._handleDockEnabled()),v),g((()=>this.dockOptions),(t=>{const{_dockAction:e}=this,i=this._featuresWidget.headerActions;i.remove(e),t.buttonEnabled&&i.add(e)}),v),g((()=>this.viewModel?.screenLocation),(()=>this._positionContainer())),g((()=>[this.viewModel?.active,this.dockEnabled]),(()=>this._toggleScreenLocationEnabled())),g((()=>[this.viewModel?.screenLocation,this.viewModel?.view?.padding,this.viewModel?.view?.size,this.viewModel?.active,this.viewModel?.location,this.alignment]),(()=>this.reposition())),g((()=>this.viewModel?.view?.size),((t,e)=>this._updateDockEnabledForViewSize(t,e))),g((()=>this.viewModel?.view),((t,e)=>this._viewChange(t,e))),g((()=>this.viewModel?.view?.ready),((t,e)=>this._viewReadyChange(t??!1,e??!1))),g((()=>this.viewModel),(()=>this._featuresWidget.viewModel=this.viewModel),v),g((()=>this._featureNavigationTop),(t=>this._featuresWidget.featureNavigationTop=t),v),g((()=>this.headingLevel),(t=>this._featuresWidget.headingLevel=t),v),g((()=>this.collapsed),(t=>this._featuresWidget.collapsed=t),v),g((()=>this.visibleElements.actionBar),(t=>this._featuresWidget.visibleElements.actionBar=!!t),v),g((()=>this.visibleElements.closeButton),(t=>this._featuresWidget.visibleElements.closeButton=!!t),v),g((()=>this.visibleElements.collapseButton),(t=>this._featuresWidget.visibleElements.collapseButton=!!t),v),g((()=>this.visibleElements.heading),(t=>this._featuresWidget.visibleElements.heading=!!t),v),g((()=>this.visibleElements.spinner),(t=>this._featuresWidget.visibleElements.spinner=!!t),v),g((()=>this.visibleElements.featureNavigation),(t=>this._featuresWidget.visibleElements.featureNavigation=!!t),v),A((()=>this._featuresWidget),"trigger-header-action",(t=>{t.action===this._dockAction&&(this.dockEnabled=!this.dockEnabled)}))])}normalizeCtorArgs(t){const e={...t};return null!=t?.visibleElements&&(e.visibleElements=new vn(t.visibleElements),null!=t.collapseEnabled&&(e.visibleElements.collapseButton=t.collapseEnabled),null!=t.spinnerEnabled&&(e.visibleElements.spinner=t.spinnerEnabled)),e}destroy(){this._dockAction.destroy(),this._featuresWidget?.destroy()}get _featureNavigationTop(){const{currentAlignment:t,currentDockPosition:e}=this;return"bottom-left"===t||"bottom-center"===t||"bottom-right"===t||"top-left"===e||"top-center"===e||"top-right"===e}get actions(){return this.viewModel.actions}set actions(t){this.viewModel.actions=t}get autoCloseEnabled(){return this.viewModel.autoCloseEnabled}set autoCloseEnabled(t){this.viewModel.autoCloseEnabled=t}get autoOpenEnabled(){return se(j.getLogger(this),"autoOpenEnabled",{replacement:"MapView/SceneView.popupEnabled",version:"4.27"}),this.viewModel.autoOpenEnabled}set autoOpenEnabled(t){se(j.getLogger(this),"autoOpenEnabled",{replacement:"MapView/SceneView.popupEnabled",version:"4.27"}),this.viewModel.autoOpenEnabled=t}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(t){this.viewModel.defaultPopupTemplateEnabled=t}get content(){return this.viewModel.content}set content(t){this.viewModel.content=t}get collapseEnabled(){return se(j.getLogger(this),"collapseEnabled",{replacement:"PopupVisibleElements.collapseButton",version:"4.29"}),this.visibleElements.collapseButton}set collapseEnabled(t){se(j.getLogger(this),"collapseEnabled",{replacement:"PopupVisibleElements.collapseButton",version:"4.29"}),this.visibleElements.collapseButton=t}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||bn}set dockOptions(t){const e={...bn},i=this.viewModel?.view?.breakpoints,s={};i&&(s.width=i.xsmall,s.height=i.xsmall);const n={...e,...t},r={...e.breakpoint,...s},{breakpoint:a}=n;"object"==typeof a?n.breakpoint={...r,...a}:a&&(n.breakpoint=r),this._set("dockOptions",n),this._setCurrentDockPosition(),this.reposition()}get featureCount(){return this.viewModel.featureCount}get featureMenuOpen(){return this.viewModel.featureMenuOpen}set featureMenuOpen(t){this.viewModel.featureMenuOpen=t}get features(){return this.viewModel.features}set features(t){this.viewModel.features=t}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(t){this.viewModel.goToOverride=t}get highlightEnabled(){return this.viewModel.highlightEnabled}set highlightEnabled(t){this.viewModel.highlightEnabled=t}get location(){return this.viewModel.location}set location(t){this.viewModel.location=t}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}get promises(){return this.viewModel.promises}set promises(t){this.viewModel.promises=t}get selectedFeature(){return this.viewModel.selectedFeature}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(t){this.viewModel.selectedFeatureIndex=t}get selectedFeatureWidget(){return this._featuresWidget.selectedFeatureWidget}get spinnerEnabled(){return se(j.getLogger(this),"spinnerEnabled",{replacement:"PopupVisibleElements.spinner",version:"4.29"}),this.visibleElements.spinner}set spinnerEnabled(t){se(j.getLogger(this),"spinnerEnabled",{replacement:"PopupVisibleElements.spinner",version:"4.29"}),this.visibleElements.spinner=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(t){this.viewModel.updateLocationEnabled=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}get visible(){return this.viewModel.visible}set visible(t){this.viewModel.visible=t}blur(){const{active:t}=this.viewModel;t||j.getLogger(this).warn("Popup can only be blurred when currently active."),this._featuresWidget.blur()}clear(){return this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(t,e){return this.viewModel.fetchFeatures(t,e)}focus(){const{active:t}=this.viewModel;t||j.getLogger(this).warn("Popup can only be focused when currently active."),this.reposition(),requestAnimationFrame((()=>{this._featuresWidget.focus()}))}next(){return this.viewModel.next()}open(t){const e=!!t&&!!t.featureMenuOpen,i={collapsed:!!t&&!!t.collapsed,featureMenuOpen:e};this.set(i),this.viewModel.open(t),this._shouldFocus(t)}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(t){return this.viewModel.triggerAction(t)}render(){const{dockEnabled:t,currentAlignment:e,currentDockPosition:i}=this,{active:s}=this.viewModel,n=s&&t,r=s&&!t,a=this.selectedFeature?.layer?.title,o=this.selectedFeature?.layer?.id,l={[pn.alignTopCenter]:"top-center"===e,[pn.alignBottomCenter]:"bottom-center"===e,[pn.alignTopLeft]:"top-left"===e,[pn.alignBottomLeft]:"bottom-left"===e,[pn.alignTopRight]:"top-right"===e,[pn.alignBottomRight]:"bottom-right"===e,[pn.isDocked]:n,[pn.shadow]:r,[pn.isDockedTopLeft]:"top-left"===i,[pn.isDockedTopCenter]:"top-center"===i,[pn.isDockedTopRight]:"top-right"===i,[pn.isDockedBottomLeft]:"bottom-left"===i,[pn.isDockedBottomCenter]:"bottom-center"===i,[pn.isDockedBottomRight]:"bottom-right"===i};return x("div",{afterCreate:this._positionContainer,afterUpdate:this._positionContainer,bind:this,class:this.classes(pn.base,l),"data-layer-id":o,"data-layer-title":a,role:"presentation"},s?[this._renderMainContainer(),this._renderPointer()]:null)}_renderPointer(){return this.dockEnabled?null:x("div",{class:pn.pointer,key:"popup-pointer",role:"presentation"},x("div",{class:this.classes(pn.pointerDirection,pn.shadow)}))}_renderMainContainer(){const{dockEnabled:t}=this,e={[pn.shadow]:t};return x("div",{afterCreate:this._setMainContainerNode,afterUpdate:this._setMainContainerNode,bind:this,class:this.classes(pn.main,M.widget,e)},this._featuresWidget.render())}async _shouldFocus(t){t?.shouldFocus&&(await ne((()=>!0===this.viewModel?.active)),this.focus())}_isOutsideView(t){const{popupHeight:e,popupWidth:i,screenLocation:s,side:n,view:r}=t;if(isNaN(i)||isNaN(e)||!r||!s)return!1;const a=r.padding;return"right"===n&&s.x+i/2>r.width-a.right||("left"===n&&s.x-i/2<a.left||("top"===n&&s.y-e<a.top||"bottom"===n&&s.y+e>r.height-a.bottom))}_calculateAutoAlignment(t){if("auto"!==t)return t;const{_pointerOffsetInPx:e,_containerNode:i,_mainContainerNode:s,viewModel:n}=this,{screenLocation:r,view:a}=n;if(null==r||!a||!i)return"top-center";function o(t){return parseInt(t.replaceAll(/[^-\d\.]/g,""),10)}const l=s?window.getComputedStyle(s,null):null,h=l?o(l.getPropertyValue("max-height")):0,c=l?o(l.getPropertyValue("height")):0,{height:u,width:d}=i.getBoundingClientRect(),p=d+e,m=Math.max(u,h,c)+e,f=this._isOutsideView({popupHeight:m,popupWidth:p,screenLocation:r,side:"right",view:a}),g=this._isOutsideView({popupHeight:m,popupWidth:p,screenLocation:r,side:"left",view:a}),v=this._isOutsideView({popupHeight:m,popupWidth:p,screenLocation:r,side:"top",view:a}),b=this._isOutsideView({popupHeight:m,popupWidth:p,screenLocation:r,side:"bottom",view:a});return g?v?"bottom-right":"top-right":f?v?"bottom-left":"top-left":v?b?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(t){return"function"==typeof t?t.call(this):t}_getCurrentAlignment(){const{alignment:t,dockEnabled:e}=this;return e||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(t)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(t){const e=["left","right"];return E(this.container)&&e.reverse(),t?.replace(/leading/gi,e[0]).replaceAll(/trailing/gi,e[1])}_callDockPosition(t){return"function"==typeof t?t.call(this):t}_getDockPosition(){return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition(this.dockOptions?.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_calculateAutoDockPosition(t){if("auto"!==t)return t;const e=this.viewModel?.view,i=E(this.container)?"top-left":"top-right";if(!e)return i;const s=e.padding||{left:0,right:0,top:0,bottom:0},n=e.width-s.left-s.right,{breakpoints:r}=e;return r&&n<=r.xsmall?"bottom-center":i}_getDockIcon(){const t=this._getDockPosition();if(this.dockEnabled)return"minimize";switch(t){case"top-left":case"bottom-left":return"dock-left";case"top-center":return"maximize";case"bottom-center":return"dock-bottom";default:return"dock-right"}}_handleDockIcon(){this._dockAction.icon=this._getDockIcon()}_handleDockEnabled(){this._dockAction.title=this.dockEnabled?this.messages?.undock:this.messages?.dock}_setMainContainerNode(t){this._mainContainerNode=t}_positionContainer(t=this._containerNode){if(t&&(this._containerNode=t),!this._containerNode)return;const{screenLocation:e}=this.viewModel,{width:i}=this._containerNode.getBoundingClientRect(),s=this._calculatePositionStyle(e,i);s&&Object.assign(this._containerNode.style,s)}_calculateFullWidth(t){const{currentAlignment:e,_pointerOffsetInPx:i}=this;return"top-left"===e||"bottom-left"===e||"top-right"===e||"bottom-right"===e?t+i:t}_calculateAlignmentPosition(t,e,i,s){const{currentAlignment:n,_pointerOffsetInPx:r}=this;if(!i)return;const{padding:a}=i,o=s/2,l=i.height-e,h=i.width-t;return"bottom-center"===n?{top:e+r-a.top,left:t-o-a.left}:"top-left"===n?{bottom:l+r-a.bottom,right:h+r-a.right}:"bottom-left"===n?{top:e+r-a.top,right:h+r-a.right}:"top-right"===n?{bottom:l+r-a.bottom,left:t+r-a.left}:"bottom-right"===n?{top:e+r-a.top,left:t+r-a.left}:"top-center"===n?{bottom:l+r-a.bottom,left:t-o-a.left}:void 0}_calculatePositionStyle(t,e){const{dockEnabled:i,view:s}=this;if(!s)return;if(i)return{left:"",top:"",right:"",bottom:""};if(null==t||!e)return;const n=this._calculateFullWidth(e),r=this._calculateAlignmentPosition(t.x,t.y,s,n);return r?{top:void 0!==r.top?`${r.top}px`:"auto",left:void 0!==r.left?`${r.left}px`:"auto",bottom:void 0!==r.bottom?`${r.bottom}px`:"auto",right:void 0!==r.right?`${r.right}px`:"auto"}:void 0}_viewChange(t,e){t&&e&&(this.close(),this.clear())}_viewReadyChange(t,e){t?this._wireUpView():e&&(this.close(),this.clear())}_wireUpView(){this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(t,e,i){const[s,n]=t,[r,a]=e,{width:o=0,height:l=0}=i??{};return s<=o&&r>o||s>o&&r<=o||n<=l&&a>l||n>l&&a<=l}_updateDockEnabledForViewSize(t,e){if(!t||!e)return;const i=this.viewModel?.view?.padding||{left:0,right:0,top:0,bottom:0},s=i.left+i.right,n=i.top+i.bottom,r=[],a=[];r[0]=t[0]-s,r[1]=t[1]-n,a[0]=e[0]-s,a[1]=e[1]-n;const{dockOptions:o}=this,l=o.breakpoint;this._dockingThresholdCrossed(r,a,l)&&this._setDockEnabledForViewSize(o),this._setCurrentDockPosition()}_toggleScreenLocationEnabled(){const{dockEnabled:t,viewModel:e}=this;if(!e)return;const i=e.active&&!t;e.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(t){const e=t.breakpoint,i=this.viewModel?.view?.ui;if(!i)return!1;const{width:s,height:n}=i;if(isNaN(s)||isNaN(n))return!1;if(!e)return!1;const r=e.hasOwnProperty("width")&&s<=(e.width??0),a=e.hasOwnProperty("height")&&n<=(e.height??0);return r||a}_setDockEnabledForViewSize(t){t.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(t))}};c([u({readOnly:!0})],wn.prototype,"_featureNavigationTop",null),c([u()],wn.prototype,"actions",null),c([u()],wn.prototype,"alignment",void 0),c([u()],wn.prototype,"autoCloseEnabled",null),c([u()],wn.prototype,"autoOpenEnabled",null),c([u()],wn.prototype,"defaultPopupTemplateEnabled",null),c([u()],wn.prototype,"content",null),c([u()],wn.prototype,"collapsed",void 0),c([u()],wn.prototype,"collapseEnabled",null),c([u({readOnly:!0})],wn.prototype,"currentAlignment",null),c([u({readOnly:!0})],wn.prototype,"currentDockPosition",null),c([u()],wn.prototype,"dockOptions",null),c([u()],wn.prototype,"dockEnabled",void 0),c([u({readOnly:!0})],wn.prototype,"featureCount",null),c([u()],wn.prototype,"featureMenuOpen",null),c([u()],wn.prototype,"features",null),c([u()],wn.prototype,"goToOverride",null),c([u()],wn.prototype,"headingLevel",void 0),c([u()],wn.prototype,"highlightEnabled",null),c([u()],wn.prototype,"location",null),c([u()],wn.prototype,"label",null),c([u(),F("esri/widgets/Popup/t9n/Popup")],wn.prototype,"messages",void 0),c([u()],wn.prototype,"promises",null),c([u({readOnly:!0})],wn.prototype,"selectedFeature",null),c([u()],wn.prototype,"selectedFeatureIndex",null),c([u({readOnly:!0})],wn.prototype,"selectedFeatureWidget",null),c([u()],wn.prototype,"spinnerEnabled",null),c([u()],wn.prototype,"title",null),c([u()],wn.prototype,"updateLocationEnabled",null),c([u()],wn.prototype,"view",null),c([u({type:fn}),ie(["triggerAction","trigger-action"])],wn.prototype,"viewModel",void 0),c([u()],wn.prototype,"visible",null),c([u({type:vn,nonNullable:!0})],wn.prototype,"visibleElements",void 0),wn=c([m("esri.widgets.Popup")],wn);const yn=wn;export default yn;
//# sourceMappingURL=p-6ff0937a.js.map