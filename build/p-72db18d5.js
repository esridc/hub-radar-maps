import{K as e}from"./p-a9376829.js";import{an as t,bg as s,bh as i,a as n,r as o,s as r,e as a,bi as l,bj as u,b4 as c,bk as f,u as h,d,aY as p,_ as m}from"./p-3013819f.js";import{a as w,K as v,L as x,d as b,u as y,i as g}from"./p-b362a32c.js";import{E as V,S,f as z,m as _,c as A,y as M,M as C,d as F,e as P,w as T,L as I}from"./p-0d83e514.js";import{a as R,_ as E,g as O,b as D,C as B,P as L,j as k,S as U,c as j,t as H,G as N,s as $,B as W,e as Z,H as X,k as q,f as G,h as Y,F as K,i as Q,U as J,x as ee,m as te,o as se,p as ie,q as ne,r as oe,u as re,v as ae,w as le,E as ue,y as ce,z as fe,A as he,D as de,R as pe,I as me,J as we,K as ve,L as xe,M as be,N as ye,W as ge,O as Ve,Q as Se,T as ze,X as _e,V as Ae,Y as Me,Z as Ce,$ as Fe,a0 as Pe,a1 as Te,a2 as Ie,a3 as Re,a4 as Ee,a5 as Oe,a6 as De,a7 as Be,a8 as Le,a9 as ke,aa as Ue,ab as je,ac as He,ad as Ne,ae as $e,af as We,ag as Ze,ah as Xe,ai as qe,aj as Ge,ak as Ye,al as Ke,am as Qe,an as Je,ao as et,ap as tt,aq as st,ar as it,as as nt,at as ot,au as rt,av as at,aw as lt,ax as ut,ay as ct,az as ft,aA as ht,aB as dt,aC as pt,aD as mt,aE as wt,aF as vt,d as xt}from"./p-ffa11fc1.js";import{C as bt,F as yt,L as gt,D as Vt,B as St,E as zt,U as _t,_ as At,G as Mt,P as Ct,O as Ft,I as Pt}from"./p-8567e6fe.js";import{h as Tt,s as It,i as Rt,x as Et}from"./p-201cec5f.js";import{o as Ot}from"./p-595ce045.js";import{t as Dt}from"./p-89242a33.js";import{t as Bt}from"./p-c7810a6f.js";import{m as Lt,d as kt}from"./p-c268fbe3.js";import{o as Ut}from"./p-a62b18ce.js";import{n as jt}from"./p-d97e7de8.js";class Ht{constructor(e){this.registryName=e,this.postProcessingEnabled=!1,this.overrideStencilRef=null,this.drawPhase=V.MAP|V.HITTEST|V.HIGHLIGHT|V.DEBUG,this.symbologyPlane=S.FILL}startup(){}shutdown(e){}postProcess(e,t){}}class Nt extends D{}t([R(0,B)],Nt.prototype,"pos",void 0);class $t extends K{}class Wt extends L{}t([E(k)],Wt.prototype,"dotSize",void 0);class Zt extends L{}t([E(U)],Zt.prototype,"locations",void 0),t([E(k)],Zt.prototype,"pixelRatio",void 0),t([E(k)],Zt.prototype,"tileZoomFactor",void 0);const Xt=1e-6;class qt extends j{vertex(e){const t=new H(1,0,0,0,-1,0,0,1,1).multiply(new N(e.pos.xy.divide(w),1)),s=$(this.draw.locations,t.xy),i=W(this.instance.dotSize.divide(2),new k(1));let n=new k(0);n=n.add(Z(s.a,new k(Xt)).multiply(2));let o=i.add(this.instance.dotSize);const r=this.view.displayViewScreenMat3.multiply(new N(e.pos.add(.5),1)),a=new X(r.xy,n,1),l=this.instance.dotSize.divide(o),u=new k(-1).divide(i.divide(o));return o=o.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:a,glPointSize:o,color:s,ratio:l,invEdgeRatio:u}}fragment(e){const t=q(e.glPointCoord.subtract(.5)).multiply(2),s=G(new k(0),new k(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),i=new Q;return i.glFragColor=e.color.multiply(s),i}}t([E(Wt)],qt.prototype,"instance",void 0),t([E(Zt)],qt.prototype,"draw",void 0),t([E(Y)],qt.prototype,"view",void 0),t([s(0,O(Nt))],qt.prototype,"vertex",null),t([s(0,O($t))],qt.prototype,"fragment",null);class Gt extends te{}t([R(3,k)],Gt.prototype,"inverseArea",void 0);class Yt extends L{}t([E(J.ofType(X,2))],Yt.prototype,"isActive",void 0),t([E(J.ofType(X,8))],Yt.prototype,"colors",void 0),t([E(k)],Yt.prototype,"dotValue",void 0);class Kt extends L{}t([E(U)],Kt.prototype,"dotTexture0",void 0),t([E(U)],Kt.prototype,"dotTexture1",void 0),t([E(k)],Kt.prototype,"tileZoomFactor",void 0),t([E(k)],Kt.prototype,"pixelRatio",void 0),t([E(k)],Kt.prototype,"tileDotsOverArea",void 0);class Qt extends se{_dotThreshold(e,t,s){return e.divide(t).divide(s)}vertex(e){const t=new H(2/w,0,0,0,-2/w,0,-1,1,1).multiply(new N(e.pos,1)),s=this.clip(e.id),i=new X(t.xy,s,1),n=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),r=this.draw.tileZoomFactor.multiply(w).divide(this.draw.pixelRatio),a=this._dotThreshold(n,this.instance.dotValue,this.draw.tileDotsOverArea),l=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),u=e.pos.add(.5).divide(r);return{glPosition:i,color:new X(0,0,0,0),textureCoords:u,thresholds0:a,thresholds1:l}}fragment(e){const t=new Q,s=$(this.draw.dotTexture0,e.textureCoords),i=$(this.draw.dotTexture1,e.textureCoords),n=e.thresholds0.subtract(s),o=e.thresholds1.subtract(i);let r;const a=ie.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),l=ie.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const e=Z(new k(0),n),t=Z(new k(0),o),s=ne(e,n).add(ne(t,o)),i=Z(s,new k(0)),u=new k(1).subtract(i),c=s.add(i),f=n.multiply(e).divide(c),h=o.multiply(t).divide(c),d=a.multiply(f).add(l.multiply(h));r=u.multiply(d)}else{const e=W(oe(n),oe(o)),t=Z(e,new k(0)),s=new k(1).subtract(t),i=Z(e,n),u=Z(e,o),c=a.multiply(i).add(l.multiply(u));r=s.multiply(c)}return t.glFragColor=r,t}hittest(e){return re(this.hittestRequest)}}t([ee],Qt.prototype,"blending",void 0),t([E(Yt)],Qt.prototype,"instance",void 0),t([E(Kt)],Qt.prototype,"draw",void 0),t([s(0,O(Gt))],Qt.prototype,"vertex",null),t([s(0,O(K))],Qt.prototype,"fragment",null);const Jt={[bt.BYTE]:1,[bt.UNSIGNED_BYTE]:1,[bt.SHORT]:2,[bt.UNSIGNED_SHORT]:2,[bt.INT]:4,[bt.UNSIGNED_INT]:4,[bt.FLOAT]:4};class es{constructor(e,t){this._boundPart=null;const s=[];for(const i of t.vertex){const t=Tt.createVertex(e,yt.STATIC_DRAW,i);s.push(t)}const i=[];for(const s of t.index||[]){const t=Tt.createIndex(e,yt.STATIC_DRAW,s);i.push(t)}this.groups=[];for(const n of t.groups){let o;if(null!=n.index){if(!t.index)throw new Error("No index data.");const{BYTES_PER_ELEMENT:e}=t.index[n.index];2===e?o=bt.UNSIGNED_SHORT:4===e&&(o=bt.UNSIGNED_INT)}const r=null!=n.index?i[n.index]:null,a=new Map,l={},u={};for(const e of n.attributes){const{name:t,count:i,type:n,offset:o,normalized:r,divisor:c,stride:f,vertex:h,location:d}=e,p=`vertex-buffer-${h}`;let m=l[p];m||(m=l[p]=[]);const w=new Dt(t,i,n,o,f,r,c);m.push(w),a.set(t,d),u[p]=s[h]}const c=new Ot(e,a,l,u,r);this.groups.push({...n,vertexArray:c,locations:a,layout:l,indexing:o})}this.parts=t.parts}bind(e,t){this._boundPart=t;const{group:s}=this.parts[this._boundPart],{vertexArray:i}=this.groups[s];e.bindVAO(i)}draw(e){if(null==this._boundPart)throw new Error("Mesh.bind() has not been called.");const{start:t,count:s}=this.parts[this._boundPart],{group:i}=this.parts[this._boundPart],{indexing:n,primitive:o}=this.groups[i];n?e.drawElements(o,s,n,t*Jt[n]):e.drawArrays(o,t,s)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArray:e}of this.groups)e.dispose()}}class ts extends es{static create(e,t){const s=[];let{stride:i,hash:n}=t.layout;if(null==i){i=0;for(const{count:e,type:s,offset:n}of t.layout.attributes){if(null!=n)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");i+=e*Jt[s]}}let o=0,r=0;for(const{count:e,name:n,offset:a,type:l,normalized:u}of t.layout.attributes){null!=a&&(r=a);const t={name:n,location:o,vertex:0,count:e,type:l,offset:r,stride:i,divisor:0,normalized:null!=u&&u};s.push(t),o++,r+=e*Jt[l]}const a={attributes:s,primitive:t.primitive};null!=t.index&&(a.index=0);let{count:l}=t;if(null==l&&(l=t.index?t.index.length:t.vertex.byteLength/i,Math.floor(l)!==l))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${i}.`);const u={start:0,count:l,group:0,primitive:t.primitive},c={vertex:[t.vertex],parts:[u],groups:[a]};null!=t.index&&(c.index=[t.index]),null==n&&(n=Bt(s));return new ts(e,c,{hash:n,attributes:s,stride:i})}constructor(e,t,s){super(e,t),this.layout=s}bind(e,t=0){super.bind(e,t)}}class ss{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(null==this._dotFBO){const t=w,s=w,i=new kt(t,s);i.samplingMode=gt.NEAREST,i.wrapMode=Vt.CLAMP_TO_EDGE;const n=new It(e,new Rt(St.DEPTH_STENCIL,t,s));this._dotFBO=new Et(e,i,n)}return this._dotFBO}getDotDensityMesh(e){if(null==this._dotMesh){const t=w,s=t*t,i=2,n=new Int16Array(s*i);for(let e=0;e<t;e++)for(let s=0;s<t;s++)n[i*(s+e*t)]=s,n[i*(s+e*t)+1]=e;const o=[{count:2,type:bt.UNSIGNED_SHORT,name:"a_position",offset:0}],r={hash:Bt(o),attributes:o,stride:4};this._dotMesh=ts.create(e,{primitive:zt.POINTS,vertex:n,count:s,layout:r})}return this._dotMesh}getDotDensityTextures(e,t,s){if(this._dotTextureSize===t&&this._seed===s||(this._disposeTextures(),this._dotTextureSize=t,this._seed=s),null===this._dotTextures){const n=new i(s);this._dotTextures=[this._allocDotDensityTexture(e,t,n),this._allocDotDensityTexture(e,t,n)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,s){const i=new Float32Array(t*t*4);for(let e=0;e<i.length;e++)i[e]=s.getFloat();const n=new kt;return n.dataType=_t.FLOAT,n.samplingMode=gt.NEAREST,n.width=t,n.height=t,new Lt(e,n,i)}}class is extends Ht{constructor(){super(...arguments),this.shaders={polygon:new Qt,point:new qt,fill:new ae},this.meshWriter=le.DotDensityMeshWriter,this._resources=new Map}render(e,t){z(e)||_(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{context:s,painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:{...A(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...M(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}_renderDotDensity(e,t){const{context:s,painter:i,requiredLevel:n}=e,o=t.instance.getInput(),r=this._getOrCreateResourcesRecord(s),a=r.getDotDensityTextures(s,w,o.seed),l=1/2**(n-t.target.key.level),u=w,c=u*window.devicePixelRatio*u*window.devicePixelRatio,f=1/l*(1/l),h=o.dotScale?e.state.scale/o.dotScale:1,d=o.dotValue*h*f;i.setShader({shader:this.shaders.polygon,uniforms:{...A(e,t.target),instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,d)},draw:{dotTexture0:{unit:v,texture:a[0]},dotTexture1:{unit:x,texture:a[1]},tileZoomFactor:l,pixelRatio:window.devicePixelRatio,tileDotsOverArea:c/(w*window.devicePixelRatio*w*window.devicePixelRatio)}},defines:{...M(e),blending:o.blending},optionalAttributes:{},useComputeBuffer:!1}),i.setPipelineState(C(e));const p=s.getViewport();s.setViewport(0,0,w,w);const m=s.getBoundFramebufferObject(),b=r.getFBO(s);s.bindFramebuffer(b),s.setClearColor(0,0,0,0),i.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),i.updatePipelineState(s),s.clear(At.COLOR_BUFFER_BIT),i.submitDraw(s,t),s.bindFramebuffer(m),s.setViewport(p.x,p.y,p.width,p.height);const y=r.getFBO(s).colorTexture;i.setShader({shader:this.shaders.point,uniforms:{view:F(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:v,texture:y},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...M(e)},optionalAttributes:{},useComputeBuffer:!1}),i.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),i.submitDrawMesh(s,r.getDotDensityMesh(s))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new ss,this._resources.set(e,t)),t}}class ns extends Ht{constructor(){super(...arguments),this.meshWriter=le.ComplexFillMeshWriter,this.shaders={geometry:new ue}}render(e,t){const{context:s,painter:i}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey),localTileOffset:T(t.target)},defines:{...M(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}function os(e){const t=1/e;return{antialiasing:t,blur:0+t}}class rs extends Ht{constructor(){super(...arguments),this.meshWriter=le.ComplexOutlineFillMeshWriter,this.shaders={geometry:new ce}}render(e,t){const{context:s,painter:i,pixelRatio:n}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),antialiasingControls:os(n),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey),localTileOffset:T(t.target)},defines:{...M(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class as extends Ht{constructor(){super(...arguments),this.meshWriter=le.FillMeshWriter,this.shaders={geometry:new ae}}render(e,t){const{context:s,painter:i}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target)},defines:M(e),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class ls extends Ht{constructor(){super(...arguments),this.meshWriter=le.OutlineFillMeshWriter,this.shaders={geometry:new fe}}render(e,t){const{context:s,painter:i,pixelRatio:n}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),antialiasingControls:os(n)},defines:{...M(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class us extends Ht{constructor(){super(...arguments),this.meshWriter=le.PatternFillMeshWriter,this.shaders={geometry:new he}}render(e,t){const{context:s,painter:i}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey),localTileOffset:T(t.target)},defines:{...M(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class cs extends Ht{constructor(){super(...arguments),this.meshWriter=le.PatternOutlineFillMeshWriter,this.shaders={geometry:new de}}render(e,t){const{context:s,painter:i,pixelRatio:n}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),antialiasingControls:os(n),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey),localTileOffset:T(t.target)},defines:{...M(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class fs{constructor(e,t,s,i){this.dataType=e,this.samplingMode=t,this.pixelFormat=s,this.internalFormat=i}}function hs(e,t){const{textureFloat:s,colorBufferFloat:i}=e.capabilities,o=s?.textureFloatLinear,r=i?.textureFloat,a=i?.textureHalfFloat,l=i?.floatBlend,u=e.driverTest.floatBufferBlend.result;if(!r&&!a)throw new n("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(l&&u||a))throw new n("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));const c=r&&l&&u,f=a,h=o,d=!!i?.R32F,p=!!i?.R16F;if(c&&h)return h||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new fs(_t.FLOAT,h?gt.LINEAR:gt.NEAREST,d?Mt.RED:Mt.RGBA,d?Ct.R32F:Mt.RGBA);if(f)return new fs(_t.HALF_FLOAT,gt.LINEAR,p?Mt.RED:Mt.RGBA,p?Ct.R16F:Mt.RGBA);throw new n("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}const ds=()=>r.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources");class ps{destroy(){this._accumulateFramebuffer=o(this._accumulateFramebuffer),this._resolveGradientTexture=o(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return null!=this._accumulateFramebuffer&&null!=this._resolveGradientTexture}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(null==this._qualityProfile){const t=hs(e,ds());this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==_t.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,s){if(null==this._accumulateFramebuffer){const{dataType:i,samplingMode:n,pixelFormat:o,internalFormat:r}=this.loadQualityProfile(e),a=new kt(t,s);a.pixelFormat=o,a.internalFormat=r,a.dataType=i,a.samplingMode=n,a.wrapMode=Vt.CLAMP_TO_EDGE;const l=new Rt(St.DEPTH_STENCIL,t,s);this._accumulateFramebuffer=new Et(e,a,l)}else{const{width:e,height:i}=this._accumulateFramebuffer;e===t&&i===s||this._accumulateFramebuffer.resize(t,s)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,s){if(null==this._resolveGradientTexture){const t=new kt;t.wrapMode=Vt.CLAMP_TO_EDGE,this._resolveGradientTexture=new Lt(e,t)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(s.length/4,1),this._resolveGradientTexture.setData(s),this._prevGradientHash=t);return this._resolveGradientTexture}}function ms(e){return e?.25:1}class ws extends te{}t([R(5,B)],ws.prototype,"offset",void 0);class vs extends K{}class xs extends L{}t([E(k)],xs.prototype,"radius",void 0),t([E(k)],xs.prototype,"isFieldActive",void 0);class bs extends se{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:s}=this.kernelControls,i=e.offset,n=s.multiply(this.storage.getVVData(e.id).x).add(new k(1).subtract(s)),o=this.view.displayViewScreenMat3.multiply(new N(e.pos,1)).add(this.view.displayViewMat3.multiply(new N(i,0)).multiply(t)),r=this.clip(e.id);return{glPosition:new X(o.xy,r,1),offset:i,fieldValue:n,color:new X(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:s}=e,i=q(t),n=Z(i,new k(1)),o=new k(1).subtract(i.multiply(i)),r=o.multiply(o),a=n.multiply(r).multiply(s).multiply(new k(ms(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new X(a),e)}hittest(e){const{viewMat3:t,tileMat3:s}=this.view,i=t.multiply(s).multiply(new N(e.pos,1));return pe(i.xy,this.kernelControls.radius,this.hittestRequest.position)}}t([ee],bs.prototype,"usesHalfFloatPrecision",void 0),t([E(xs)],bs.prototype,"kernelControls",void 0),t([s(0,O(ws))],bs.prototype,"vertex",null),t([s(0,O(vs))],bs.prototype,"fragment",null);class ys extends D{}t([R(0,B)],ys.prototype,"pos",void 0);class gs extends me{}class Vs extends L{}t([E(U)],Vs.prototype,"texture",void 0),t([E(B)],Vs.prototype,"minAndInvRange",void 0),t([E(k)],Vs.prototype,"normalization",void 0);class Ss extends L{}t([E(U)],Ss.prototype,"texture",void 0);class zs extends j{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new X(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){const{accumulatedDensity:t,gradient:s}=this;let i=$(t.texture,e.uv).r.multiply(new k(ms(this.usesHalfFloatPrecision)));i=i.multiply(t.normalization),i=i.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const n=$(s.texture,new B(i,.5)),o=new Q;return o.glFragColor=new X(n.rgb.multiply(n.a),n.a),o}}t([ee],zs.prototype,"usesHalfFloatPrecision",void 0),t([E(Vs)],zs.prototype,"accumulatedDensity",void 0),t([E(Ss)],zs.prototype,"gradient",void 0),t([s(0,O(ys))],zs.prototype,"vertex",null),t([s(0,O(gs))],zs.prototype,"fragment",null);class _s extends Ht{constructor(){super(...arguments),this.meshWriter=le.HeatmapMeshWriter,this.shaders={accumulate:new bs,resolve:new zs},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=Ms}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:s,painter:i,state:n}=e,o=t.instance.getInput(),{isFieldActive:r}=o,a=this._getOrCreateResourcesRecord(s),l=a.loadQualityProfile(s);if(z(e))return;_(e)||this._bind(e,a,o),i.setShader({shader:this.shaders.accumulate,uniforms:{...A(e,t.target),kernelControls:{radius:Ts(o,n),isFieldActive:r?1:0}},defines:{...M(e),...l.defines},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)});const u=_(e)?Fs:Cs;i.setPipelineState(u),i.submitDraw(s,t)}postProcess(e,t){if(_(e)||z(e))return;const{context:s,painter:i}=e,n=this._resources.get(s);if(null==this._prevFBO||null==this._prevViewport||!n?.initialized)return;const{defines:o}=n.loadQualityProfile(s),{minDensity:r,maxDensity:a,radius:l}=t.getInput(),u=8,c=9,f=n.accumulateFramebuffer,h=n.resolveGradientTexture;i.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:u,texture:f.colorTexture},minAndInvRange:[r,1/(a-r)],normalization:3/(l*l*Math.PI)},gradient:{texture:{unit:c,texture:h}}},defines:o,optionalAttributes:{},useComputeBuffer:!1}),s.bindFramebuffer(this._prevFBO),s.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),s.bindTexture(f.colorTexture,u),s.bindTexture(h,c),i.setPipelineState(Ps),i.submitDrawQuad(s),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new ps,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,s){if(this._isBound)return;const{context:i,state:n,pixelRatio:o}=e,r=i.getBoundFramebufferObject(),a=i.getViewport();this._prevFBO=r,this._prevViewport=a;const{gradient:l,gradientHash:u}=s;t.ensureResolveGradientTexture(i,u,l);const{width:c,height:f}=a,h=As(Ts(s,n),o),d=c*h,p=f*h,m=t.ensureAccumulateFBO(i,d,p);i.blitFramebuffer(r,m,0,0,r.width,r.height,0,0,m.width,m.height,At.STENCIL_BUFFER_BIT,gt.NEAREST),i.bindFramebuffer(m),i.setViewport(0,0,m.width,m.height),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(At.COLOR_BUFFER_BIT),this._isBound=!0}}function As(e,t){const s=t>1.5?.25:.5;return e<1/(2*s)?1:s}function Ms(e){return e.key.level+1}const Cs={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:Ms,compare:Ft.GEQUAL,mask:255,op:{fail:Pt.KEEP,zFail:Pt.KEEP,zPass:Pt.REPLACE}}}},Fs={...Cs,stencil:!1},Ps={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function Ts(e,t){const{referenceScale:s,radius:i}=e;return i*(0!==s?s/t.scale:1)}class Is extends L{getVVRotationMat4(e){return we(ve(e),ie.identity(),(()=>{const t=this._getNormalizedAngle(e).multiply(ye),s=ge(t),i=Ve(t);return new ie(i,s,0,0,s.multiply(new k(-1)),i,0,0,0,0,1,0,0,0,0,1)}))}getVVRotationMat3(e){return we(ve(e),H.identity(),(()=>{const t=this._getNormalizedAngle(e).multiply(ye),s=ge(t),i=Ve(t);return new H(i,s,0,s.multiply(new k(-1)),i,0,0,0,1)}))}_getNormalizedAngle(e){const t=xe(this.rotationType,new k(be.Arithmatic));return we(t,new k(90).subtract(e),e)}}t([E(k)],Is.prototype,"rotationType",void 0);const Rs=360/254;class Es extends te{}t([R(3,X)],Es.prototype,"color",void 0),t([R(4,B)],Es.prototype,"offset",void 0),t([R(5,B)],Es.prototype,"textureUV",void 0),t([R(6,k)],Es.prototype,"fontSize",void 0),t([R(7,k)],Es.prototype,"referenceSize",void 0),t([R(8,k)],Es.prototype,"haloFontSize",void 0),t([R(9,X)],Es.prototype,"haloColor",void 0),t([R(10,B)],Es.prototype,"zoomRange",void 0),t([R(11,k)],Es.prototype,"clipAngle",void 0),t([R(12,X)],Es.prototype,"referenceSymbol",void 0);class Os extends ze{}t([R(13,B)],Os.prototype,"offsetNextVertex1",void 0),t([R(14,B)],Os.prototype,"offsetNextVertex2",void 0);class Ds extends K{}class Bs extends se{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,s){const i=t.multiply(Rs),n=_e(this.view.rotation.subtract(i)),o=Ae(new k(360).subtract(n),n);let r=new k(0);const a=Me(this.view.currentZoom.multiply(b)).divide(b),l=e.x,u=e.y,c=new k(1).subtract(Z(l,a)).multiply(2),f=Z(new k(90),o).multiply(2),h=new k(2).multiply(new k(1).subtract(Z(a,u)));return r=r.add(s.multiply(c)),r=r.add(s.multiply(f)),r=r.add(h),r}vertex(e,t){const s=Ce(e.bitset,We),i=new k(1).subtract(s);let n=e.fontSize,o=n.divide(Fe);const r=this.isHaloPass?e.haloColor:this._getVertexColor(e),a=this.isLabel?r.multiply(this.storage.getAnimationValue(e.id)):r,l=this.view.displayViewScreenMat3.multiply(new N(e.pos,1));let u=e.offset,c=new k(1),f=H.identity();if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const t=e.referenceSymbol,s=t.xy,i=t.z,n=this._unpackDirection(t.w),o=Pe(this,e.id,i).divide(2),r=n.multiply(o.add(y));u=u.add(s).add(r)}else{c=Pe(this,e.id,e.referenceSize).divide(e.referenceSize),n=n.multiply(c),o=o.multiply(c),u=u.multiply(c),f=Te(this,e.id),u=f.multiply(new N(u,0)).xy}const h=Ce(e.bitset,Ze),d=this._getViewRotationMatrix(h).multiply(new N(u,0));let p=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,h):this.clip(e.id,e.zoomRange);p=this.isBackgroundPass?p.add(i.multiply(2)):p.add(s.multiply(2));const m=new X(l.xy.add(d.xy),p,1),w=e.textureUV.divide(this.mosaicInfo.size);let v=new k(0);if(this.isHaloPass){v=e.haloFontSize.divide(o).divide(Ie)}return{glPosition:m,color:a,size:o,textureUV:w,antialiasingWidth:new k(.105*Fe).divide(n).divide(this.view.pixelRatio),haloDistanceOffset:v,...this.maybeRunHittest(e,t,{vvSizeAdjustment:c,vvRotation:f})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,s=this.view.displayMat3,i=new k(1).subtract(e);return t.multiply(e).add(s.multiply(i))}fragment(e){const t=new k(2/8),s=new k(1).subtract(t),i=$(this.mosaicInfo.texture,e.textureUV).a;let n=s.subtract(e.haloDistanceOffset);this.highlight&&(n=n.divide(2));const o=e.antialiasingWidth,r=G(n.subtract(o),n.add(o),i);return this.getFragmentOutput(e.color.multiply(r),e)}hittest(e,t,{vvSizeAdjustment:s,vvRotation:i}){const n=i.multiply(new N(e.offset.multiply(s),0)),o=i.multiply(new N(t.offsetNextVertex1.multiply(s),0)),r=i.multiply(new N(t.offsetNextVertex2.multiply(s),0)),{viewMat3:a,tileMat3:l}=this.view,u=a.multiply(l).multiply(new N(e.pos,1)),c=u.add(l.multiply(n)).xy,f=u.add(l.multiply(o)).xy,h=u.add(l.multiply(r)).xy;return Re(this.hittestRequest.position,c.xy,f.xy,h.xy)}_unpackDirection(e){const t=new Ee(e),s=Oe(t,new Ee(2)),i=De(t,new Ee(3));return new B(new k(s).subtract(1),new k(i).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const s=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(s,e.color,new Be(!1))}if(this.visualVariableOpacity){const s=this.storage.getOpacityValue(e.id),i=this.visualVariableOpacity.getOpacity(s);t=t.multiply(i)}return t}}t([Se(Le)],Bs.prototype,"visualVariableColor",void 0),t([Se(ke)],Bs.prototype,"visualVariableOpacity",void 0),t([Se(Is)],Bs.prototype,"visualVariableRotation",void 0),t([Se(Ue)],Bs.prototype,"visualVariableSizeMinMaxValue",void 0),t([Se(je)],Bs.prototype,"visualVariableSizeScaleStops",void 0),t([Se(He)],Bs.prototype,"visualVariableSizeStops",void 0),t([Se(Ne)],Bs.prototype,"visualVariableSizeUnitValue",void 0),t([E($e)],Bs.prototype,"mosaicInfo",void 0),t([ee],Bs.prototype,"isHaloPass",void 0),t([ee],Bs.prototype,"isBackgroundPass",void 0),t([ee],Bs.prototype,"isLabel",void 0),t([s(0,O(Es)),s(1,O(Os))],Bs.prototype,"vertex",null),t([s(0,O(Ds))],Bs.prototype,"fragment",null);class Ls extends Ht{constructor(){super(...arguments),this.meshWriter=le.LabelMeshWriter,this.shaders={geometry:new Bs},this.drawPhase=V.LABEL|V.LABEL_ALPHA,this.symbologyPlane=S.TEXT}render(e,t){const{context:s,painter:i}=e,n=M(e),o={...C(e)},r={shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey)},defines:{...n,isHaloPass:!1,isBackgroundPass:!0,isLabel:!0},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:!1};i.setShader(r),i.setPipelineState(o),i.submitDraw(s,t),i.setShader({...r,defines:{...n,isHaloPass:!0,isBackgroundPass:!1,isLabel:!0}}),i.setPipelineState(o),i.submitDraw(s,t),i.setShader({...r,defines:{...n,isHaloPass:!1,isBackgroundPass:!1,isLabel:!0}}),i.setPipelineState(o),i.submitDraw(s,t)}}class ks extends Ht{constructor(){super(...arguments),this.meshWriter=le.LineMeshWriter,this.shaders={geometry:new Xe},this.symbologyPlane=S.LINE}render(e,t){const{context:s,painter:i,pixelRatio:n}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),antialiasingControls:os(n)},defines:{...M(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class Us extends qe{}t([R(9,k)],Us.prototype,"accumulatedDistance",void 0),t([R(10,B)],Us.prototype,"segmentDirection",void 0),t([R(11,X)],Us.prototype,"tlbr",void 0);class js extends Xe{_getLineWidthRatio(e,t){const s=new k(Ut),i=Ce(e.bitset,it);return i.multiply(W(t,new k(.25))).add(new k(1).subtract(i)).divide(s)}_getSDFAlpha(e){const{halfWidth:t,normal:s,tlbr:i,patternSize:n,accumulatedDistance:o,lineWidthRatio:r}=e,a=n.x.multiply(new k(2)).multiply(r),l=Ge(o.divide(a)),u=new k(.25).multiply(s.y).add(new k(.5)),c=Ye(i.xy,i.zw,new B(l,u)),f=Ke($(this.mosaicInfo.texture,c)).subtract(new k(.5)).multiply(t),h=Qe(new k(.5).subtract(f),new k(0),new k(1));return new X(h)}_getPatternColor(e){const{halfWidth:t,normal:s,color:i,accumulatedDistance:n,patternSize:o,sampleAlphaOnly:r,tlbr:a}=e,l=o.y.multiply(new k(2).multiply(t).divide(o.x)),u=Ge(n.divide(l)),c=new k(.5).multiply(s.y).add(new k(.5)),f=Ye(a.xy,a.zw,new B(c,u));let h=$(this.mosaicInfo.texture,f);return null!=this.visualVariableColor&&(h=we(Je(r,new k(.5)),new X(i.a),i)),h}vertex(e,t){const{segmentDirection:s,tlbr:i,bitset:n}=e,o=et(this,e),r=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(ne(s,o.scaledOffset)),a=new B(i.z.subtract(i.x),i.w.subtract(i.y)),l=i.divide(this.mosaicInfo.size.xyxy),u=Ce(n,nt),c=Ce(n,ot),f=we(Je(u,new k(.5)),this._getLineWidthRatio(e,o.scaledHalfWidth),new k(1));return{...o,tlbr:l,patternSize:a,accumulatedDistance:r,isSDF:u,sampleAlphaOnly:c,lineWidthRatio:f,...this.maybeRunHittest(e,t,o.halfWidth)}}fragment(e){const{color:t,opacity:s,isSDF:i}=e,n=tt(e,this.antialiasingControls.blur),o=we(Je(i,new k(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),r=t.multiply(s).multiply(n).multiply(o);return this.getFragmentOutput(r,e)}}t([E($e)],js.prototype,"mosaicInfo",void 0),t([s(0,O(Us)),s(1,O(st))],js.prototype,"vertex",null);class Hs extends Ht{constructor(){super(...arguments),this.meshWriter=le.TexturedLineMeshWriter,this.shaders={geometry:new js},this.symbologyPlane=S.LINE}render(e,t){const{context:s,painter:i,pixelRatio:n}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),antialiasingControls:os(n),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey)},defines:{...M(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class Ns extends te{}t([R(3,X)],Ns.prototype,"color",void 0),t([R(4,X)],Ns.prototype,"outlineColor",void 0),t([R(5,B)],Ns.prototype,"offset",void 0),t([R(6,B)],Ns.prototype,"textureUV",void 0),t([R(7,X)],Ns.prototype,"sizing",void 0),t([R(8,k)],Ns.prototype,"placementAngle",void 0),t([R(9,k)],Ns.prototype,"sizeRatio",void 0),t([R(10,B)],Ns.prototype,"zoomRange",void 0);class $s extends ze{}t([R(12,B)],$s.prototype,"offsetNextVertex1",void 0),t([R(13,B)],$s.prototype,"offsetNextVertex2",void 0),t([R(14,B)],$s.prototype,"textureUVNextVertex1",void 0),t([R(15,B)],$s.prototype,"textureUVNextVertex2",void 0);class Ws extends K{}function Zs(e,t,s,i){return t.multiply(e.x).add(s.multiply(e.y)).add(i.multiply(e.z))}function Xs(e){return e.multiply(e).divide(128)}class qs extends se{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const s=Xs(e.sizing.x),i=Xs(e.sizing.y),n=Xs(e.sizing.z),o=e.placementAngle,r=Ce(e.bitset,wt.bitset.isSDF),a=Ce(e.bitset,wt.bitset.isMapAligned),l=Ce(e.bitset,wt.bitset.scaleSymbolsProportionally),u=rt(e.bitset,wt.bitset.colorLocked),c=at(this,e.id),f=lt(this,e.id,e.color,u).multiply(c),h=this.view.displayViewScreenMat3.multiply(new N(e.pos.xy,1)),d=Pe(this,e.id,n).divide(n),p=s.multiply(d),m=e.offset.xy.multiply(d);let w=i.multiply(l.multiply(d.subtract(1)).add(1));w=Ae(w,W(p.subtract(.99),new k(0)));const v=W(w,new k(1)),x=Ae(w,new k(1)),b=H.fromRotation(o.multiply(ut)),y=Te(this,e.id),g=this._getViewRotationMatrix(a).multiply(y).multiply(b).multiply(new N(m.xy,0)),V=this.clip(e.id,e.zoomRange),S=new X(h.xy.add(g.xy),V,1),z=e.textureUV.divide(this.mosaicInfo.size),_=e.outlineColor.multiply(x),A=Ce(e.bitset,wt.bitset.overrideOutlineColor),M=e.sizeRatio.multiply(p).multiply(.5);return{glPosition:S,color:f,textureUV:z,outlineColor:_,outlineSize:v,distanceToPx:M,isSDF:r,overrideOutlineColor:A,...this.maybeRunHittest(e,t,{pos:e.pos,size:p,sizeCorrection:d,isMapAligned:a,outlineSize:v,distanceToPx:M,isSDF:r})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,s){return we(ct(s.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,s),this._hittestMarker(e,t,s))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,s=this.view.displayMat3,i=new k(1).subtract(e);return t.multiply(e).add(s.multiply(i))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),s=this.view.tileMat3,i=new k(1).subtract(e);return t.multiply(e).add(s.multiply(i))}_getColor(e,t){return we(xe(t.isSDF,new k(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return $(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const s=$(this.mosaicInfo.texture,e),i=new k(.5).subtract(Ke(s)).multiply(t.distanceToPx).multiply(ft),n=Qe(new k(.5).subtract(i),new k(0),new k(1)),o=t.color.multiply(n);let r=t.outlineSize;this.highlight&&(r=W(r,t.overrideOutlineColor.multiply(4)));const a=r.multiply(.5),l=_e(i).subtract(a),u=Qe(new k(.5).subtract(l),new k(0),new k(1)),c=Ye(t.outlineColor,t.color,t.overrideOutlineColor).multiply(u);return new k(1).subtract(c.a).multiply(o).add(c)}_hittestSmallMarker(e,t,s){const{position:i,distance:n,smallSymbolDistance:o}=this.hittestRequest,r=n.subtract(o),{viewMat3:a,tileMat3:l}=this.view,u=a.multiply(l).multiply(new N(s.pos,1)).xy,c=s.size.multiply(.5);return ht(u,i).subtract(c).add(r)}_hittestMarker(e,t,s){const{pos:i,size:n,sizeCorrection:o,isMapAligned:r,outlineSize:a,isSDF:l,distanceToPx:u}=s,c=new N(e.offset.multiply(o),0),f=new N(t.offsetNextVertex1.multiply(o),0),h=new N(t.offsetNextVertex2.multiply(o),0),{viewMat3:d,tileMat3:p}=this.view,m=d.multiply(p).multiply(new N(i,1)),w=this._getViewScreenMatrix(r),v=m.add(w.multiply(c)).xy,x=m.add(w.multiply(f)).xy,b=m.add(w.multiply(h)).xy,y=this.hittestRequest.position,g=this.hittestRequest.distance,V=dt(y.add(new B(pt(g),pt(g))),v,x,b),S=dt(y.add(new B(0,pt(g))),v,x,b),z=dt(y.add(new B(g,pt(g))),v,x,b),_=dt(y.add(new B(pt(g),0)),v,x,b),A=dt(y,v,x,b),M=dt(y.add(new B(g,0)),v,x,b),C=dt(y.add(new B(pt(g),g)),v,x,b),F=dt(y.add(new B(0,g)),v,x,b),P=dt(y.add(new B(g,g)),v,x,b),T=e.textureUV.divide(this.mosaicInfo.size),I=t.textureUVNextVertex1.divide(this.mosaicInfo.size),R=t.textureUVNextVertex2.divide(this.mosaicInfo.size),E={color:new X(1),outlineColor:new X(1),overrideOutlineColor:new k(1),outlineSize:a,distanceToPx:u,isSDF:l};let O=new k(0);return O=O.add(mt(V).multiply(this._getColor(Zs(V,T,I,R),E).a)),O=O.add(mt(S).multiply(this._getColor(Zs(S,T,I,R),E).a)),O=O.add(mt(z).multiply(this._getColor(Zs(z,T,I,R),E).a)),O=O.add(mt(_).multiply(this._getColor(Zs(_,T,I,R),E).a)),O=O.add(mt(A).multiply(this._getColor(Zs(A,T,I,R),E).a)),O=O.add(mt(M).multiply(this._getColor(Zs(M,T,I,R),E).a)),O=O.add(mt(C).multiply(this._getColor(Zs(C,T,I,R),E).a)),O=O.add(mt(F).multiply(this._getColor(Zs(F,T,I,R),E).a)),O=O.add(mt(P).multiply(this._getColor(Zs(P,T,I,R),E).a)),Z(O,new k(.05)).multiply(re(this.hittestRequest))}}t([Se(Le)],qs.prototype,"visualVariableColor",void 0),t([Se(ke)],qs.prototype,"visualVariableOpacity",void 0),t([Se(Is)],qs.prototype,"visualVariableRotation",void 0),t([Se(Ue)],qs.prototype,"visualVariableSizeMinMaxValue",void 0),t([Se(je)],qs.prototype,"visualVariableSizeScaleStops",void 0),t([Se(He)],qs.prototype,"visualVariableSizeStops",void 0),t([Se(Ne)],qs.prototype,"visualVariableSizeUnitValue",void 0),t([E($e)],qs.prototype,"mosaicInfo",void 0),t([s(0,O(Ns)),s(1,O($s))],qs.prototype,"vertex",null),t([s(0,O(Ws))],qs.prototype,"fragment",null);class Gs extends Ht{constructor(){super(...arguments),this.meshWriter=le.MarkerMeshWriter,this.shaders={geometry:new qs},this.symbologyPlane=S.MARKER}render(e,t){const{context:s,painter:i}=e;i.setShader({shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey,!0)},defines:{...M(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class Ys{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map((([e,t])=>`${e}.${t}`)).join("."),s=a(t);this._locationInfo={hash:s,locations:e}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,s]of this.locationsMap.entries())e.set("a_"+t,s);return e}getShaderKey(e,t,s){const i=Object.keys(s).filter((e=>s[e])).map((e=>`${e}_${s[e].toString()}`)).join("."),n=Object.keys(t).filter((e=>this.optionPropertyKeys.has(e))).join(".");return`${e.hash}.${i}.${n}`}getProgram(e,t,s,i){let n="",o="";for(const e in s)if(s[e]){const t="boolean"==typeof s[e]?`#define ${e}\n`:`#define ${e} ${s[e]}\n`;n+=t,o+=t}return n+=this.vertexShader,o+=this.fragmentShader,new vt(n,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const e in this.required){const s=this.required[e];t.push({uniformHydrated:null,shaderModulePath:e,uniformName:e,uniformType:s.type,uniformArrayElementType:Ks(s),uniformArrayLength:Qs(s)})}for(const s in e){const i=this.options[s];if(e[s])for(const e in i){const n=i[e];t.push({uniformHydrated:null,shaderModulePath:`${s}.${e}`,uniformName:e,uniformType:n.type,uniformArrayElementType:Ks(n),uniformArrayLength:Qs(n)})}}return t}}const Ks=e=>"array"===e.type?e.elementType?.type:void 0,Qs=e=>"array"===e.type?e.size:void 0;const Js={hittestDist:k,hittestPos:B},ei={filterFlags:U,animation:U,visualVariableData:U,dataDriven0:U,dataDriven1:U,dataDriven2:U,gpgpu:U,size:k},ti={displayViewScreenMat3:H,displayViewMat3:H,displayMat3:H,viewMat3:H,tileMat3:H,displayZoomFactor:k,requiredZoomFactor:k,tileOffset:B,currentScale:k,currentZoom:k,metersPerSRUnit:k};class si extends Ys{constructor(){super(...arguments),this.vertexShader=jt("materials/pie/pie.vert"),this.fragmentShader=jt("materials/pie/pie.frag"),this.required={...ei,...ti,outlineWidth:k,colors:J,defaultColor:X,othersColor:X,outlineColor:X,donutRatio:k,sectorThreshold:k},this.options={hittestUniforms:Js,visualVariableSizeMinMaxValue:{minMaxValueAndSize:X},visualVariableSizeScaleStops:{sizes:{...J.ofType(k,8),type:"array",elementType:k,size:8},values:{...J.ofType(k,8),type:"array",elementType:k,size:8}},visualVariableSizeStops:{sizes:{...J.ofType(k,8),type:"array",elementType:k,size:8},values:{...J.ofType(k,8),type:"array",elementType:k,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:k},visualVariableOpacity:{opacities:{...J.ofType(k,8),type:"array",elementType:k,size:8},opacityValues:{...J.ofType(k,8),type:"array",elementType:k,size:8}}},this.locations={pos:{index:0,type:B},id:{index:1,type:N},bitset:{index:2,type:k},offset:{index:3,type:B},texCoords:{index:4,type:B},size:{index:5,type:B},referenceSize:{index:6,type:k},zoomRange:{index:7,type:B}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...J.ofType(X,e),type:"array",elementType:X,size:e}}}class ii extends Ht{constructor(){super(...arguments),this.meshWriter=le.PieChartMeshWriter,this.shaders={geometry:new si},this.symbologyPlane=S.MARKER}render(e,t){const{context:s,painter:i}=e,{instance:n,target:o}=t,r=this.shaders.geometry,a=n.getInput(),l=a.numberOfFields,u=_(e),c=A(e,o),f=M(e);r.setNumberOfFields(l),i.setShader({shader:r,uniforms:{...P(e,t.target,a.geometry),...c.storage,...c.view,hittestUniforms:c.hittestRequest?{hittestDist:c.hittestRequest?.distance,hittestPos:c.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!a.geometry.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!a.geometry.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!a.geometry.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!a.geometry.visualVariableSizeUnitValue,VV_OPACITY:!!a.geometry.visualVariableOpacity,HITTEST:u,highlight:c.highlight?1:0,...f,numberOfFields:l},optionalAttributes:{},useComputeBuffer:u}),i.setPipelineState(C(e)),i.submitDraw(s,t)}}class ni extends Ht{constructor(){super(...arguments),this.meshWriter=le.TextMeshWriter,this.shaders={geometry:new Bs},this.symbologyPlane=S.TEXT}render(e,t){const{context:s,painter:i}=e,n=M(e),o={shader:this.shaders.geometry,uniforms:{...P(e,t.target,t.instance.getInput().geometry),...A(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey)},defines:{...n,isHaloPass:!1,isBackgroundPass:!0,isLabel:!1},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:_(e)};i.setShader(o),i.setPipelineState(C(e)),i.submitDraw(s,t),i.setShader({...o,defines:{...n,isHaloPass:!0,isBackgroundPass:!1,isLabel:!1}}),i.submitDraw(s,t),i.setShader({...o,defines:{...n,isHaloPass:!1,isBackgroundPass:!1,isLabel:!1}}),i.submitDraw(s,t)}}const oi={fill:new as("fill"),patternFill:new us("patternFill"),complexFill:new ns("complexFill"),outlineFill:new ls("outlineFill"),patternOutlineFill:new cs("patternOutlineFill"),complexOutlineFill:new rs("complexOutlineFill"),marker:new Gs("marker"),pieChart:new ii("pieChart"),line:new ks("line"),texturedLine:new Hs("texturedLine"),text:new ni("text"),label:new Ls("label"),heatmap:new _s("heatmap"),dotDensity:new is("dotDensity")};function ri(){for(const e in oi){oi[e].startup()}}function ai(e){for(const t in oi){oi[t].shutdown(e)}}function li(e,t){const s=e.slice(0,t),i=t-s.length;for(let e=0;e<i;e++){const e=s[s.length-1];s.push(e)}return s}function ui(e){if(!e)return[0,0,0,0];const{r:t,g:s,b:i,a:n}=e;return[t*(n/255),s*(n/255),i*(n/255),n]}const ci=8,fi=ci-2,hi=()=>r.getLogger("esri.views.2d.layers.features.support.rendererUtils");function di(e){return e.map((e=>pi(e)?mi(e.clone()):e))}function pi(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function mi(e){return e.stops=bi(e.type,e.stops??[]),e}function wi(e,t,s){return(1-s)*e+s*t}function vi(e,t){const[s,...i]=t,n=i.pop(),o=i[0].value,r=i[i.length-1].value,a=(r-o)/fi,u=[];for(let s=o;s<r;s+=a){let n=0;for(;s>=i[n].value;)n++;const o=i[n],r=t[n-1],a=s-r.value,c=o.value===r.value?1:a/(o.value-r.value);if("color"===e){const e=i[n],o=t[n-1],r=e.color.clone();r.r=wi(o.color.r,r.r,c),r.g=wi(o.color.g,r.g,c),r.b=wi(o.color.b,r.b,c),r.a=wi(o.color.a,r.a,c),u.push({value:s,color:r,label:e.label})}else if("size"===e){const e=i[n],o=t[n-1],r=l(e.size),a=wi(l(o.size),r,c);u.push({value:s,size:a,label:e.label})}else{const e=i[n],o=wi(t[n-1].opacity,e.opacity,c);u.push({value:s,opacity:o,label:e.label})}}return[s,...u,n]}function xi(e){const[t,...s]=e,i=s.pop();for(;s.length>fi;){let e=0,t=0;for(let i=1;i<s.length;i++){const n=s[i-1],o=s[i],r=Math.abs(o.value-n.value);r>t&&(t=r,e=i)}s.splice(e,1)}return[t,...s,i]}function bi(e,t){return t.length<=ci?t:(hi().warn(`Found ${t.length} Visual Variable stops, but MapView only supports ${ci}. Displayed stops will be simplified.`),t.length>2*ci?vi(e,t):xi(t))}function yi(){const{supportsColorBufferFloat:e,supportsColorBufferFloatBlend:t,supportsColorBufferHalfFloat:s}=u();return e&&t||s}function gi(e){if(!e)return!0;switch(e.type){case"dot-density":break;case"heatmap":if(!yi()){const e=u(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter((t=>!e[t])).join(", ");return hi().errorOnce(new n("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}const Vi=1.25,Si=128,zi=128;function _i(e){if(!e.stops?.length)return null;const t=e.stops.sort(((e,t)=>e.value-t.value)),s=li(t,8),i=s.map((({value:e})=>e)),n=s.map((({color:e})=>ui(e)));return{values:i,colors:n}}function Ai(e){if(!e.stops?.length)return null;const t=e.stops.sort(((e,t)=>e.value-t.value)),s=li(t,8);return{opacityValues:s.map((({value:e})=>e)),opacities:s.map((({opacity:e})=>e))}}function Mi(e){return{rotationType:"geographic"===e.rotationType?be.Geographic:be.Arithmatic}}function Ci(e){if(!e.stops?.length)return null;if(e.stops.some((e=>e.useMaxValue||e.useMinValue)))return(t,s)=>{const i=t.statisticsByLevel.get(s.key.level),n=e.stops.map((t=>({value:t.useMaxValue?i?.get(e.field)?.maxValue??0:t.useMinValue?i?.get(e.field)?.minValue??0:t.value,size:t.size?h(t.size):g}))).sort(((e,t)=>e.value-t.value)),o=li(n,8);return{values:o.map((({value:e})=>e)),sizes:o.map((({size:e})=>e))}};const t=e.stops.sort(((e,t)=>e.value-t.value)),s=li(t,8);return{values:s.map((({value:e})=>e)),sizes:s.map((({size:e})=>h(e)))}}function Fi(e){return t=>{const{state:s}=t;return{unitValueToPixelsRatio:c(s.spatialReference)/f[e.valueUnit]/s.resolution}}}function Pi(e,t){const s=t.length;if(e<t[0].value||1===s)return t[0].size;for(let i=1;i<s;i++)if(e<t[i].value){const s=(e-t[i-1].value)/(t[i].value-t[i-1].value);return t[i-1].size+s*(t[i].size-t[i-1].size)}return t[s-1].size}function Ti(e){const{minDataValue:t,maxDataValue:s,minSize:i,maxSize:n}=e;if("object"==typeof i&&"object"==typeof n)return(e,o)=>{const r=e.state.scale,a=h(Pi(r,i.stops)),l=h(Pi(r,n.stops));return{minMaxValueAndSize:[t,s,a,l]}};if("object"==typeof i||"object"==typeof n)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[t,s,h(i),h(n)]}}const Ii={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function Ri(e,t=zi,s=Vi){if(e.visualVariableSizeMinMaxValue)return e.visualVariableSizeMinMaxValue instanceof Function?Si:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*s,t);if(e.visualVariableSizeScaleStops){if(e.visualVariableSizeScaleStops instanceof Function)return Si;const i=e.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*s,t)}if(e.visualVariableSizeStops){if(e.visualVariableSizeStops instanceof Function)return Si;const i=e.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*s,t)}return e.visualVariableSizeUnitValue?2*Si:0}function Ei(e){const t={...Ii};if(!e||!("visualVariables"in e)||!e.visualVariables)return t;for(const s of di(e.visualVariables))switch(s.type){case"color":t.visualVariableColor=_i(s);break;case"opacity":t.visualVariableOpacity=Ai(s);break;case"rotation":t.visualVariableRotation=Mi(s);break;case"size":switch(Oi(s)){case"field-stops":t.visualVariableSizeStops=Ci(s);break;case"scale-stops":"outline"===s.target?t.visualVariableSizeOutlineScaleStops=Ci(s):t.visualVariableSizeScaleStops=Ci(s);break;case"min-max":t.visualVariableSizeMinMaxValue=Ti(s);break;case"unit-value":t.visualVariableSizeUnitValue=Fi(s)}break;default:console.error("Unable to handle VV type")}return t}function Oi(e){if("number"==typeof e.minDataValue&&"number"==typeof e.maxDataValue&&null!=e.minSize&&null!=e.maxSize)return"min-max";if((e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops))return"scale-stops";if((null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels))return"field-stops";if((null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit)return"unit-value";throw new Error("InternalError: Found unknown sizeVV type")}function Di(e){return!!(e.visualVariableSizeMinMaxValue||e.visualVariableSizeScaleStops||e.visualVariableSizeStops||e.visualVariableSizeUnitValue||e.visualVariableSizeOutlineScaleStops)}function Bi(e){return!!e.visualVariableRotation}function Li(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function ki(e){if(null==e)return null;if(Array.isArray(e)){const[t,s,i,n]=e;return[t,s,i,255*n]}return"string"==typeof e?e:{...e,defaultValue:ki(e?.defaultValue)}}async function Ui(t,s){const{cimResourceManager:i,cimAnalyzer:n,scaleExpression:o}=s.schemaOptions;await Promise.all(e.fetchResources(t.symbol,i,[]));const r=n.analyzeSymbolReference(t,!1),a={scaleInfo:Li(t),scaleExpression:o},l=[];for(const e of r)switch(e.type){case"marker":l.push(...ji(e,s,a));break;case"fill":l.push(...Wi(e,s,a));break;case"line":l.push(...Xi(e,s,a));break;case"text":l.push(...Ki(e,s,a))}return l}function ji(e,t,s){const{uniforms:i,schemaOptions:n}=t,{store:o}=n,r=e.isOutline?{...Ii,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return Hi(o.ensureInstance(oi.marker,{geometry:r},{zoomRange:!!s.scaleInfo}),e,i,s)}function Hi(e,t,s,{scaleInfo:i,scaleExpression:n}){const o=Di(s);return[e.createMeshInfo({params:{size:t.size,scaleX:t.scaleX,anchorX:t.anchorPoint.x,anchorY:t.anchorPoint.y,angle:t.rotation,color:ki(t.color)??[0,0,0,0],colorLocked:t.colorLocked,frameHeight:t.frameHeight,widthRatio:t.widthRatio,scaleInfo:i,offsetX:t.offsetX,offsetY:t.offsetY,outlineColor:ki(t.outlineColor)??[0,0,0,0],outlineSize:t.outlineWidth,referenceSize:t.referenceSize||d.CIMVectorMarker.size,rotateClockwise:t.rotateClockwise,scaleFactor:n??1,sizeRatio:t.sizeRatio,alignment:t.alignment,isAbsoluteAnchorPoint:t.isAbsoluteAnchorPoint,scaleSymbolsProportionally:t.scaleSymbolsProportionally,sprite:t.spriteRasterizationParam,hasSizeVV:o,placement:t.markerPlacement,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,transforms:t.transform,minPixelBuffer:Ri(s)}})]}function Ni(e,t,s){const{uniforms:i,schemaOptions:n}=t,{store:o}=n;return $i(o.ensureInstance(oi.fill,{geometry:{visualVariableColor:e.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!s.scaleInfo}),e,s)}function $i(e,t,{scaleInfo:s}){return[e.createMeshInfo({params:{color:ki(t.color)??[0,0,0,0],scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null}})]}function Wi(e,t,s){if(!e.spriteRasterizationParam)return Ni(e,t,s);const{uniforms:i,schemaOptions:n}=t,{store:o}=n;return Zi(o.ensureInstance(oi.complexFill,{geometry:{visualVariableColor:e.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!s.scaleInfo}),e,null!=i.visualVariableColor,s)}function Zi(e,t,s,{scaleInfo:i}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const n=!!t.hasUnresolvedReplacementColor&&(!s||t.colorLocked),o=t.sampleAlphaOnly&&!n,r=t.spriteRasterizationParam;return[e.createMeshInfo({params:{color:ki(t.color)??[0,0,0,0],height:t.height,aspectRatio:t.scaleX,offsetX:t.offsetX,offsetY:t.offsetY,scaleX:1,scaleY:1,angle:t.angle,applyRandomOffset:t.applyRandomOffset,sampleAlphaOnly:o,scaleProportionally:"CIMHatchFill"===r.resource.type,sprite:r,scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null}})]}function Xi(e,t,s){const{uniforms:i,schemaOptions:n}=t,{store:o}=n,r=e.isOutline?{...Ii,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},a={geometry:r},l=!!(r.visualVariableSizeMinMaxValue||r.visualVariableSizeScaleStops||r.visualVariableSizeStops||r.visualVariableSizeUnitValue);if(!e.spriteRasterizationParam){return Gi(o.ensureInstance(oi.line,a,{zoomRange:!!s.scaleInfo}),e,l,s)}return Yi(o.ensureInstance(oi.texturedLine,a,{zoomRange:!!s.scaleInfo}),e,l,s)}function qi(e,t,{scaleInfo:s}){return{params:{color:ki(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:s,hasSizeVV:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}}function Gi(e,t,s,i){if(t.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");return[e.createMeshInfo({params:qi(t,s,i).params})]}function Yi(e,t,s,i){const{spriteRasterizationParam:n,scaleDash:o,sampleAlphaOnly:r}=t;if(!n)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({params:{...qi(t,s,i).params,shouldScaleDash:o??!1,shouldSampleAlphaOnly:r,isSDF:"CIMPictureStroke"!==n.resource.type,sprite:n}})]}function Ki(e,t,s){const{uniforms:i,schemaOptions:n}=t,{store:o}=n;return Qi(o.ensureInstance(oi.text,{geometry:{visualVariableColor:e.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue}},{zoomRange:!!s.scaleInfo,referenceSymbol:!1,clipAngle:!1}),e,i,s)}function Qi(e,t,s,{scaleInfo:i,scaleExpression:n}){return[e.createMeshInfo({params:{boxBackgroundColor:ki(t.backgroundColor),boxBorderLineColor:ki(t.borderLineColor),boxBorderLineSize:t.borderLineWidth??0,color:ki(t.color)??[0,0,0,0],offsetX:t.offsetX,offsetY:t.offsetY,postAngle:t.angle,fontSize:t.size,referenceSize:t.referenceSize,decoration:t.decoration,haloColor:ki(t.outlineColor)??[0,0,0,0],haloFontSize:t.outlineSize,lineWidth:t.lineWidth||512,lineHeightRatio:1,horizontalAlignment:t.horizontalAlignment??"center",verticalAlignment:t.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:t.textRasterizationParam,scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,placement:t.markerPlacement,transforms:t.transform,scaleFactor:n??1,minPixelBuffer:Ri(s),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}function Ji(e,t){return{type:"simple",filters:t,capabilities:{maxTextureSize:u().maxTextureSize},bindings:tn(e)}}function en(e){switch(e){case"opacity":return I.OPACITY;case"color":return I.COLOR;case"rotation":return I.ROTATION;case"size":return I.SIZE;default:return null}}function tn(e){if(!e)return[];switch(e.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return rn(e);case"dot-density":return sn(e);case"pie-chart":return nn(e);case"heatmap":return on(e)}}function sn(e){const t=[];for(const s of e.attributes)t.push({binding:t.length,expression:s.valueExpression,field:s.field});return t}function nn(e){const t=rn(e);let s=4;for(const i of e.attributes)t.push({binding:s++,expression:i.valueExpression,field:i.field});return t}function on({valueExpression:e,field:t}){return e||t?[{binding:0,expression:e,field:t}]:[]}function rn(e){if(!("visualVariables"in e)||!e.visualVariables?.length)return[];return di(e.visualVariables).map((e=>fn(e))).filter(p)}function an(e){return"$view.scale"===e.valueExpression?null:{binding:en(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression,valueRepresentation:e.valueRepresentation}}function ln(e){return{binding:en(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}function un(e){return{binding:en(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}function cn(e){return{binding:en(e.type),expression:e.valueExpression,field:e.field}}function fn(e){switch(e.type){case"size":return an(e);case"color":return ln(e);case"opacity":return un(e);case"rotation":return cn(e)}}function hn(e){return e.some((e=>e.globalId))}function dn(e){return e.filter((e=>!e.error)).map((e=>e.objectId??e.globalId)).filter((e=>null!=e))}function pn(e,t){const s=new Set(e);for(const e of t.values())s.add(e);return s}function mn(e,t){const s=new Set(e);for(const e of t.values())s.delete(e);return s}class wn{constructor(e){this.updateTracking=new xt({debugName:"FeatureCommandQueue"}),this._hasGlobalIds=!1,this._queueProcessor=new m({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return this.updateTracking.addPromise(this._doPush(e))}async _doPush(e){const t=this._queueProcessor,s=t.last(),i=[];switch(e.type){case"update":if(s?.type===e.type)return;i.push(t.push(e));break;case"edit":{const n="processed-edit"===s?.type?s:null;n&&t.popLast();const o=this._mergeEdits(n,e);for(const e of o)e&&i.push(t.push(e));break}}await Promise.all(i)}_mergeEdits(e,t){const{addedFeatures:s,deletedFeatures:i,updatedFeatures:n}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||hn(s)||hn(n)||hn(i),this._hasGlobalIds){return[e,{type:"processed-edit",edits:{addOrModified:[...s,...n],removed:i}}]}const o=new Set(dn(e?.edits.addOrModified??[])),r=new Set(dn(e?.edits.removed??[])),a=new Set([...dn(s),...dn(n)]),l=new Set(dn(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(pn(mn(o,l),a)).map((e=>({objectId:e}))),removed:Array.from(pn(mn(r,a),l)).map((e=>({objectId:e})))}}]}}export{ri as F,Zi as S,ai as T,wn as a,oi as b,Ri as c,Di as d,Ei as e,ui as f,rn as g,Gi as h,Bi as i,gi as m,Ui as n,$i as p,Li as s,Ji as t,Hi as u,Ii as x,Qi as y,Yi as z};
//# sourceMappingURL=p-72db18d5.js.map