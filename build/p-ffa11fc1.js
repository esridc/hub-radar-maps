import{bp as t,h as e,c3 as s,s as n,a as i,u as r,c4 as o,an as c,c5 as a,c6 as u,e as h,bg as l,c7 as f,al as p,bC as d,bb as m,c8 as w,H as g,N as y,K as v,bD as b,ao as x,ap as k,am as M,c9 as $,ca as P,ah as _}from"./p-3013819f.js";import{a as S,i as z,c as C}from"./p-808395fb.js";import"./p-508fdb0a.js";import{e as F,i as O,l as T}from"./p-f1aede5a.js";import{e as A}from"./p-94b15954.js";import{a as R,d as I,$ as V,r as D,l as L,S as G,e as B,g as W,_ as E}from"./p-b362a32c.js";import{$ as N,A as U,s as j,a as H,g as X,O as Y,b as q,c as K,d as Z,e as Q}from"./p-a9376829.js";import{t as J,e as tt,w as et,f as st,T as nt,r as it}from"./p-c7810a6f.js";import{C as rt}from"./p-8567e6fe.js";import{U as ot,e as ct,w as at,d as ut,i as ht}from"./p-30a1f911.js";import{a as lt}from"./p-7580bdba.js";import"./p-c268fbe3.js";import{r as ft}from"./p-201cec5f.js";import{l as pt}from"./p-7b13247d.js";import{i as dt}from"./p-a897fcf8.js";import{t as mt}from"./p-a62b18ce.js";function wt(t){return t}function gt(t){return t}function yt(t,e,s,n,i,r,o){qt=0;const c=(n-s)*r,a=i&&i.length,u=a?(i[0]-s)*r:c;let h,l,f,p,d,m=vt(e,s,n,0,u,r,!0);if(m&&m.next!==m.prev){if(a&&(m=St(e,s,n,i,m,r)),c>80*r){h=f=e[0+s*r],l=p=e[1+s*r];for(let t=r;t<u;t+=r){const n=e[t+s*r],i=e[t+1+s*r];h=Math.min(h,n),l=Math.min(l,i),f=Math.max(f,n),p=Math.max(p,i)}d=Math.max(f-h,p-l),d=0!==d?1/d:0}xt(m,t,r,h,l,d,o,0)}}function vt(t,e,s,n,i,r,o){let c;if(o===It(t,e,s,n,i,r)>0)for(let s=n;s<i;s+=r)c=$t(s+e*r,t[s+e*r],t[s+1+e*r],c);else for(let s=i-r;s>=n;s-=r)c=$t(s+e*r,t[s+e*r],t[s+1+e*r],c);return c&&Gt(c,c.next)&&(Pt(c),c=c.next),c}function bt(t,e=t){if(!t)return t;let s,n=t;do{if(s=!1,n.steiner||!Gt(n,n.next)&&0!==Tt(n.prev,n,n.next))n=n.next;else{if(Pt(n),n=e=n.prev,n===n.next)break;s=!0}}while(s||n!==e);return e}function xt(t,e,s,n,i,r,o,c){if(!t)return;!c&&r&&(t=Ft(t,n,i,r));let a=t;for(;t.prev!==t.next;){const u=t.prev,h=t.next;if(r?Mt(t,n,i,r):kt(t))e.push(u.index/s+o),e.push(t.index/s+o),e.push(h.index/s+o),Pt(t),t=h.next,a=h.next;else if((t=h)===a){c?1===c?xt(t=Wt(t,e,s,o),e,s,n,i,r,o,2):2===c&&Et(t,e,s,n,i,r,o):xt(bt(t),e,s,n,i,r,o,1);break}}}function kt(t){const e=t.prev,s=t,n=t.next;if(Tt(e,s,n)>=0)return!1;let i=t.next.next;const r=i;let o=0;for(;i!==t.prev&&(0===o||i!==r);){if(o++,Vt(e.x,e.y,s.x,s.y,n.x,n.y,i.x,i.y)&&Tt(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function Mt(t,e,s,n){const i=t.prev,r=t,o=t.next;if(Tt(i,r,o)>=0)return!1;const c=i.x<r.x?i.x<o.x?i.x:o.x:r.x<o.x?r.x:o.x,a=i.y<r.y?i.y<o.y?i.y:o.y:r.y<o.y?r.y:o.y,u=i.x>r.x?i.x>o.x?i.x:o.x:r.x>o.x?r.x:o.x,h=i.y>r.y?i.y>o.y?i.y:o.y:r.y>o.y?r.y:o.y,l=Lt(c,a,e,s,n),f=Lt(u,h,e,s,n);let p=t.prevZ,d=t.nextZ;for(;p&&p.z>=l&&d&&d.z<=f;){if(p!==t.prev&&p!==t.next&&Vt(i.x,i.y,r.x,r.y,o.x,o.y,p.x,p.y)&&Tt(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,d!==t.prev&&d!==t.next&&Vt(i.x,i.y,r.x,r.y,o.x,o.y,d.x,d.y)&&Tt(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;p&&p.z>=l;){if(p!==t.prev&&p!==t.next&&Vt(i.x,i.y,r.x,r.y,o.x,o.y,p.x,p.y)&&Tt(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&Vt(i.x,i.y,r.x,r.y,o.x,o.y,d.x,d.y)&&Tt(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function $t(t,e,s,n){const i=Ht.create(t,e,s);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function Pt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function _t(t){let e=t,s=t;do{(e.x<s.x||e.x===s.x&&e.y<s.y)&&(s=e),e=e.next}while(e!==t);return s}function St(t,e,s,n,i,r){const o=new Array;for(let i=0,c=n.length;i<c;i++){const a=vt(t,e,s,n[i]*r,i<c-1?n[i+1]*r:s*r,r,!1);a===a.next&&(a.steiner=!0),o.push(_t(a))}o.sort(Bt);for(const t of o)i=zt(t,i);return i}function zt(t,e){const s=Ct(t,e);if(!s)return e;const n=jt(s,t);return bt(n,n.next),bt(s,s.next)}function Ct(t,e){let s=e;const n=t.x,i=t.y;let r,o=-1/0;do{if(i<=s.y&&i>=s.next.y&&s.next.y!==s.y){const t=s.x+(i-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(t<=n&&t>o){if(o=t,t===n){if(i===s.y)return s;if(i===s.next.y)return s.next}r=s.x<s.next.x?s:s.next}}s=s.next}while(s!==e);if(!r)return null;if(n===o)return r.prev;const c=r,a=r.x,u=r.y;let h,l=1/0;for(s=r.next;s!==c;)n>=s.x&&s.x>=a&&n!==s.x&&Vt(i<u?n:o,i,a,u,i<u?o:n,i,s.x,s.y)&&(h=Math.abs(i-s.y)/(n-s.x),(h<l||h===l&&s.x>r.x)&&Dt(s,t)&&(r=s,l=h)),s=s.next;return r}function Ft(t,e,s,n){let i;for(;i!==t;i=i.next){if(i=i||t,null===i.z&&(i.z=Lt(i.x,i.y,e,s,n)),i.prev.next!==i||i.next.prev!==i)return i.prev.next=i,i.next.prev=i,Ft(t,e,s,n);i.prevZ=i.prev,i.nextZ=i.next}return t.prevZ.nextZ=null,t.prevZ=null,Ot(t)}function Ot(t){let e,s=1;for(;;){let n,i=t;t=null,e=null;let r=0;for(;i;){r++,n=i;let o=0;for(;o<s&&n;o++)n=n.nextZ;let c=s;for(;o>0||c>0&&n;){let s;0===o?(s=n,n=n.nextZ,c--):0!==c&&n?i.z<=n.z?(s=i,i=i.nextZ,o--):(s=n,n=n.nextZ,c--):(s=i,i=i.nextZ,o--),e?e.nextZ=s:t=s,s.prevZ=e,e=s}i=n}if(e.nextZ=null,s*=2,r<2)return t}}function Tt(t,e,s){return(e.y-t.y)*(s.x-e.x)-(e.x-t.x)*(s.y-e.y)}function At(t,e,s,n){return!!(Gt(t,e)&&Gt(s,n)||Gt(t,n)&&Gt(s,e))||Tt(t,e,s)>0!=Tt(t,e,n)>0&&Tt(s,n,t)>0!=Tt(s,n,e)>0}function Rt(t,e){let s=t;do{if(s.index!==t.index&&s.next.index!==t.index&&s.index!==e.index&&s.next.index!==e.index&&At(s,s.next,t,e))return!0;s=s.next}while(s!==t);return!1}function It(t,e,s,n,i,r){let o=0;for(let s=n,c=i-r;s<i;s+=r)o+=(t[c+e*r]-t[s+e*r])*(t[s+1+e*r]+t[c+1+e*r]),c=s;return o}function Vt(t,e,s,n,i,r,o,c){return(i-o)*(e-c)-(t-o)*(r-c)>=0&&(t-o)*(n-c)-(s-o)*(e-c)>=0&&(s-o)*(r-c)-(i-o)*(n-c)>=0}function Dt(t,e){return Tt(t.prev,t,t.next)<0?Tt(t,e,t.next)>=0&&Tt(t,t.prev,e)>=0:Tt(t,e,t.prev)<0||Tt(t,t.next,e)<0}function Lt(t,e,s,n,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Gt(t,e){return t.x===e.x&&t.y===e.y}function Bt(t,e){return t.x-e.x}function Wt(t,e,s,n){let i=t;do{const r=i.prev,o=i.next.next;!Gt(r,o)&&At(r,i,i.next,o)&&Dt(r,o)&&Dt(o,r)&&(e.push(r.index/s+n),e.push(i.index/s+n),e.push(o.index/s+n),Pt(i),Pt(i.next),i=t=o),i=i.next}while(i!==t);return i}function Et(t,e,s,n,i,r,o){let c=t;do{let t=c.next.next;for(;t!==c.prev;){if(c.index!==t.index&&Nt(c,t)){let a=jt(c,t);return c=bt(c,c.next),a=bt(a,a.next),xt(c,e,s,n,i,r,o,0),void xt(a,e,s,n,i,r,o,0)}t=t.next}c=c.next}while(c!==t)}function Nt(t,e){return t.next.index!==e.index&&t.prev.index!==e.index&&!Rt(t,e)&&Dt(t,e)&&Dt(e,t)&&Ut(t,e)}function Ut(t,e){let s=t,n=!1;const i=(t.x+e.x)/2,r=(t.y+e.y)/2;do{s.y>r!=s.next.y>r&&s.next.y!==s.y&&i<(s.next.x-s.x)*(r-s.y)/(s.next.y-s.y)+s.x&&(n=!n),s=s.next}while(s!==t);return n}function jt(t,e){const s=Ht.create(t.index,t.x,t.y),n=Ht.create(e.index,e.x,e.y),i=t.next,r=e.prev;return t.next=e,e.prev=t,s.next=i,i.prev=s,n.next=s,s.prev=n,r.next=n,n.prev=r,n}class Ht{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,s){const n=qt<Xt.length?Xt[qt++]:new Ht;return n.index=t,n.x=e,n.y=s,n.prev=null,n.next=null,n.z=null,n.prevZ=null,n.nextZ=null,n.steiner=!1,n}}const Xt=[],Yt=8096;let qt=0;for(let t=0;t<Yt;t++)Xt.push(new Ht);const Kt=1e-5,Zt=new F(0,0,0,1,0),Qt=new F(0,0,0,1,0);function Jt(t,e,s){let n=0;for(let i=1;i<s;i++){const s=t[2*(e+i-1)],r=t[2*(e+i-1)+1];n+=(t[2*(e+i)]-s)*(t[2*(e+i)+1]+r)}return n}function te(t,e,s,n,i){let r=0;const o=2;for(let c=s;c<n;c+=3){const s=(t[c]-i)*o,n=(t[c+1]-i)*o,a=(t[c+2]-i)*o;r+=Math.abs((e[s]-e[a])*(e[n+1]-e[s+1])-(e[s]-e[n])*(e[a+1]-e[s+1]))}return r}function ee(t,e){const{coords:s,lengths:n,hasIndeterminateRingOrder:i}=e,r=0,o=t;if(i)return!1;let c=0;for(let t=0;t<n.length;){let e=t,i=n[t],a=Jt(s,c,i);const u=[];for(;++e<n.length;){const t=n[e],r=Jt(s,c+i,t);if(!(r>0))break;a+=r,u.push(c+i),i+=t}const h=o.length;yt(o,s,c,c+i,u,2,r);const l=te(o,s,h,o.length,r),f=Math.abs(a);if(Math.abs((l-f)/Math.max(1e-7,f))>Kt)return o.length=0,!1;t=e,c+=i}return!0}function se(t){const{coords:e,lengths:s}=t,{buffer:n}=S(e,s);return n}function ne(t,e,s){let n=0;for(let i=0;i<t.lengths.length;i++){const r=t.lengths[i];for(let i=0;i<r;i++){const r=t.coords[2*(i+n)],o=t.coords[2*(i+n)+1];if(r<e||r>s||o<e||o>s)return!0}n+=r}return!1}function ie(t,e){if(null==t)return null;if(!ne(t,-128,R+128))return t;Zt.setPixelMargin(e),Zt.reset(O.Polygon);let s=0;for(let e=0;e<t.lengths.length;e++){const n=t.lengths[e];let i=t.coords[2*(0+s)],r=t.coords[2*(0+s)+1];Zt.moveTo(i,r);for(let e=1;e<n;e++)i=t.coords[2*(e+s)],r=t.coords[2*(e+s)+1],Zt.lineTo(i,r);Zt.close(),s+=n}const n=Zt.result(!1);if(!n)return null;const i=[],r=[];for(const t of n){let e=0;for(const s of t)r.push(s.x),r.push(s.y),e++;i.push(e)}return new A(i,r)}function re(t,e){Qt.setPixelMargin(e);const s=Qt,n=-e,i=R+e;let r=[],o=!1;if(!t.nextPath())return null;let c=!0;for(;c;){t.seekPathStart();const e=[];if(!t.pathSize)return null;s.reset(O.LineString),t.nextPoint();let a=t.x,u=t.y;if(o)s.moveTo(a,u);else{if(a<n||a>i||u<n||u>i){o=!0;continue}e.push({x:a,y:u})}let h=!1;for(;t.nextPoint();)if(a=t.x,u=t.y,o)s.lineTo(a,u);else{if(a<n||a>i||u<n||u>i){h=!0;break}e.push({x:a,y:u})}if(h)o=!0;else{if(o){const t=s.resultWithStarts();if(t)for(const e of t)r.push(e)}else r.push({line:e,start:0});c=t.nextPath(),o=!1}}return r=r.filter((t=>t.line.length>1)),0===r.length?null:r}Zt.setExtent(R),Qt.setExtent(R);const oe=96/72;class ce{static executeEffects(t,e,s,n){const i=oe,r=N(t);let o=new j(e);for(const e of t){const t=U(e);t&&(o=t.execute(o,e,i,s,n,r))}return o}static applyEffects(e,s,n){if(!e)return s;const i=N(e);let r,o=new j(H.fromJSONCIM(s));for(const t of e){const e=U(t);e&&(o=e.execute(o,t,1,null,n,i))}const c=[];let a=null;for(;r=o.next();)c.push(...t(r)),a=r.geometryType;return 0===c.length||null===a?null:"esriGeometryPolygon"===a?{rings:c}:{paths:c}}}let ae=null;function ue(){return ae}async function he(){ae=await import("./p-5e1d2ab6.js")}function le(t){switch(t){case rt.BYTE:case rt.UNSIGNED_BYTE:return 1;case rt.SHORT:case rt.UNSIGNED_SHORT:return 2;case rt.FLOAT:case rt.INT:case rt.UNSIGNED_INT:return 4}}function fe(t){const e=[],s=[],n=[];for(const i of t){const t=le(i.type)*i.count;switch(t%2||t%4||4){case 4:e.push(i);continue;case 2:s.push(i);continue;case 1:n.push(i);continue;default:throw new Error("Found unexpected dataType byte count")}}return e.push(...s),e.push(...n),e}class pe{static fromVertexSpec({attributes:t},e){let s,n,i;const r=[];for(const o in t){const c=t[o];!1!==e?.[o]&&("position"===c.pack?s={...c,name:o,offset:0}:"id"===c.pack?n={...c,name:o,offset:4}:"bitset"===o?i={...c,name:o,offset:7}:r.push({...c,name:o}))}const o=fe(r),c=[];let a=8,u=1;for(const t of o)c.push({...t,offset:a}),a+=le(t.type)*t.count,t.packAlternating&&(u=Math.max(t.packAlternating.count,u));const h=Uint32Array.BYTES_PER_ELEMENT,l=a%h;return new pe(s,n,i,c,a+(l?h-l:0),u)}constructor(t,e,s,n,i,r){this.position=t,this.id=e,this.bitset=s,this.standardAttributes=n,this.stride=i,this.packVertexCount=r,n.push(s),this._attributes=[t,e,s,...n]}get attributeLayout(){if(!this._attributeLayout){const t=J(this._attributes),e=this._attributes.map((t=>({name:t.name,count:t.count,offset:t.offset,type:t.type,packPrecisionFactor:t.packPrecisionFactor,normalized:t.normalized??!1})));this._attributeLayout={attributes:e,hash:t,stride:this.stride}}return this._attributeLayout}}class de{static fromVertexSpec(t,e){const s=pe.fromVertexSpec(t,e);return new de(s)}constructor(t){this._spec=t,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(t,e,s,n,i,r){for(let t=0;t<this._spec.packVertexCount;t++){const o=t*this._spec.stride;this._packPosition(s,n,o),this._packId(e,o);const c=this._spec.bitset;if(r){if(c.packTessellation){const t=c.packTessellation(r,i);this._pack(t,c,o)}for(const t of this._spec.standardAttributes)if(null!=t.packTessellation){const e=t.packTessellation(r,i);this._pack(e,t,o)}else if(t.packAlternating?.packTessellation){const e=t.packAlternating.packTessellation(r,i);for(let s=0;s<this._spec.packVertexCount;s++){const n=e[s];this._pack(n,t,s*this._spec.stride)}}}}t.vertexWriteRegion(this._packedU32View)}pack(t,e){for(const s of this._spec.standardAttributes)if(s.pack&&"string"!=typeof s.pack){const n=s.pack(t,e);for(let t=0;t<this._spec.packVertexCount;t++)this._pack(n,s,t*this._spec.stride)}else if(s.packAlternating?.pack){const n=s.packAlternating.pack(t,e);for(let t=0;t<this._spec.packVertexCount;t++){const e=n[t];this._pack(e,s,t*this._spec.stride)}}}_packPosition(t,e,s){const{offset:n}=this._spec.position,i=this._spec.position.packPrecisionFactor??1,r=et(t*i,e*i);this._dataView.setUint32(s+n,r,!0)}_packId(t,e){const s=t*(this._spec.id.packPrecisionFactor??1),n=4278190080&this._dataView.getUint32(e+this._spec.id.offset,!0);this._dataView.setUint32(e+this._spec.id.offset,s|n,!0)}_pack(t,e,s){tt(this._dataView,t,e,s)}}function me(t){if(!t)return!1;for(const e of t)switch(e.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1}class we{constructor(t,e,s,n){this._instanceId=t,this._evaluator=e,this._viewParams=s,this._optionalAttributes=n,this._evaluator.evaluator=t=>this.vertexSpec.createComputedParams(t)}get _vertexPack(){if(!this._cachedVertexPack){const t=de.fromVertexSpec(this.vertexSpec,this._optionalAttributes);this._evaluator.hasDynamicProperties||t.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=t}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(t){this._references=t}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){me(this._evaluator.inputMeshParams.params.effects?.effectInfos)&&await he()}enqueueRequest(t,e,s){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(t,e,s)}write(t,e,s,n,i){this.ensurePacked(e,s,n);const r=this.evaluatedMeshParams.effects;if(!r||0===r.length)return void this._write(t,s,void 0,i);const o=s.readGeometryForDisplay()?.clone();if(!o)return;const c=H.fromOptimizedCIM(o,s.geometryType),a=ue();c.invertY();const u=t.id||"",h=ce.executeEffects(r,c,u,a);let l;for(;l=h.next();)l.invertY(),this._write(t,s,l,i)}ensurePacked(t,e,s){if(!this._evaluator.hasDynamicProperties)return;const n=this._evaluator.evaluateMeshParams(t,e,s);this._vertexPack.pack(n,this._viewParams)}_writeVertex(t,e,s,n,i){const r=this.evaluatedMeshParams;this._vertexPack.writeVertex(t,e,s,n,r,i)}}const ge=100,ye=e("featurelayer-fast-triangulation-enabled");class ve extends we{async loadDependencies(){await Promise.all([super.loadDependencies(),z()])}_write(t,e,s){const n=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(n);i&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,i),t.recordEnd())}_clip(t){if(!t)return null;const e=this.hasEffects;return ie(t,e?256:8)}_writeGeometry(t,e,s){const n=s.maxLength>ge,i=[],r=this.createTesselationParams(e);if(!n&&ye&&ee(i,s))return void(i.length&&this._writeVertices(t,e,s.coords,r,i));const o=se(s);this._writeVertices(t,e,o,r)}_writeVertices(t,e,s,n,i){const r=e.getDisplayId(),o=t.vertexCount(),c=this.hasEffects;let a=0;if(i)for(const e of i){const i=s[2*e],o=s[2*e+1];c&&t.recordBounds(i,o,0,0),this._writeVertex(t,r,i,o,n),a++}else for(let e=0;e<s.length;e+=2){const i=Math.round(s[e]),o=Math.round(s[e+1]);c&&t.recordBounds(i,o,0,0),this._writeVertex(t,r,i,o,n),a++}t.indexEnsureSize(a);for(let e=0;e<a;e++)t.indexWrite(e+o)}}const be={createComputedParams:t=>t,attributes:{id:{type:rt.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:rt.UNSIGNED_BYTE,count:1},pos:{type:rt.SHORT,count:2,pack:"position",packPrecisionFactor:10},inverseArea:{type:rt.FLOAT,count:1,packTessellation:({inverseArea:t})=>t}}};class xe extends ve{constructor(){super(...arguments),this.vertexSpec=be}createTesselationParams(t){return{inverseArea:1/t.readGeometryArea()}}}const ke=()=>n.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils"),Me=0,$e=100;function Pe(t,e){return[!!t?.minScale&&e.scaleToZoom(t.minScale)||Me,!!t?.maxScale&&e.scaleToZoom(t.maxScale)||$e]}function _e(t){return 1<<t}function Se(t){let e=0;for(const[s,n]of t)n&&(e|=1<<s);return e}function ze(t){let e;if(!t)return[0,0,0,0];if("string"==typeof t){const n=s.fromString(t);if(!n)return ke().errorOnce(new i("mapview:mesh-processing","Unable to parse string into color",{color:t})),[0,0,0,0];e=n.toArray()}else e=t;const[n,r,o,c]=e;return[n*(c/255),r*(c/255),o*(c/255),c]}function Ce(t){switch(t){case"butt":case ot.Butt:return ct.BUTT;case"round":case ot.Round:return ct.ROUND;case"square":case ot.Square:return ct.SQUARE}}function Fe(t){switch(t){case"bevel":case at.Bevel:return ut.BEVEL;case"miter":case at.Miter:return ut.MITER;case"round":case at.Round:return ut.ROUND}}function Oe(t,e){return Math.round(Math.min(Math.sqrt(t*e),255))}function Te(t,e){return Math.round(t*e)/e}function Ae(t,e){return Math.ceil(t*e)/e}const Re={createComputedParams:t=>t,attributes:{id:{type:rt.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:rt.UNSIGNED_BYTE,count:1},pos:{type:rt.SHORT,count:2,pack:"position",packPrecisionFactor:10},zoomRange:{type:rt.SHORT,count:2,packPrecisionFactor:I,pack:({scaleInfo:t},{tileInfo:e})=>Pe(t,e)},color:{type:rt.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>ze(t)}}};class Ie extends ve{constructor(){super(...arguments),this.vertexSpec=Re}createTesselationParams(t){return null}}const Ve={createComputedParams:t=>t,attributes:{...Re.attributes,tlbr:{count:4,type:rt.UNSIGNED_SHORT,pack:({sprite:t})=>{const{rect:e,width:s,height:n}=t,i=e.x+V,r=e.y+V;return[i,r,i+s,r+n]}},inverseRasterizationScale:{count:1,type:rt.BYTE,packPrecisionFactor:16,pack:({sprite:t})=>1/t.rasterizationScale}}};class De extends Ie{constructor(){super(...arguments),this.vertexSpec=Ve}_write(t,e,s){const n=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(n);if(!i)return;const r=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,r),this._writeGeometry(t,e,i),t.recordEnd()}}var Le;!function(t){t[t.Geographic=0]="Geographic",t[t.Arithmatic=1]="Arithmatic"}(Le||(Le={}));const Ge=3.14159265359/180,Be=3.14159265359/128,We=1,Ee=1.1,Ne=1,Ue=24,je=8,He=1e-5,Xe=.05,Ye=1e-30,qe=4,Ke=0,Ze=2,Qe=5,Je=6,ts=2,es=3,ss=0,ns=3,is=16777216;function rs(t){const{sprite:e,aspectRatio:s,scaleProportionally:n}=t,i=r(t.height),o=i>0?i:e.height;let c=i*s;return c<=0?c=e.width:n&&(c*=e.width/e.height),{width:c,height:o}}function os(t){const{applyRandomOffset:e,sampleAlphaOnly:s}=t,{width:n,height:i}=rs(t);return Se([[Ze,e],[qe,s],[Je,n<D],[Qe,i<D]])}function cs(t){const{width:e}=rs(t);return Math.round(e<D?e*L:e)}function as(t){const{height:e}=rs(t);return Math.round(e<D?e*L:e)}const us={createComputedParams:t=>t,attributes:{...Ve.attributes,bitset:{count:1,type:rt.UNSIGNED_BYTE,pack:os},width:{count:1,type:rt.UNSIGNED_SHORT,pack:cs},height:{count:1,type:rt.UNSIGNED_SHORT,pack:as},offset:{count:2,type:rt.SHORT,pack:({offsetX:t,offsetY:e})=>[r(t),-r(e)]},scale:{count:2,type:rt.UNSIGNED_BYTE,packPrecisionFactor:16,pack:({scaleX:t,scaleY:e})=>[t,e]},angle:{count:1,type:rt.UNSIGNED_BYTE,pack:({angle:t})=>T(t)}}};class hs extends De{constructor(){super(...arguments),this.vertexSpec=us}}class ls{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0}}const fs={createComputedParams:t=>t,attributes:{id:{type:rt.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:rt.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:rt.UNSIGNED_BYTE,count:1},zoomRange:{type:rt.SHORT,count:2,packPrecisionFactor:I,pack:({scaleInfo:t},{tileInfo:e})=>Pe(t,e)},color:{type:rt.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>ze(t)},offset:{type:rt.BYTE,count:2,packPrecisionFactor:16,packTessellation:({extrusionOffsetX:t,extrusionOffsetY:e})=>[Te(t,16),Te(e,16)]},normal:{type:rt.BYTE,count:2,packPrecisionFactor:16,packTessellation:({normalX:t,normalY:e})=>[Te(t,16),Te(e,16)]},halfWidth:{type:rt.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:({width:t})=>Ae(r(.5*t),16)},referenceHalfWidth:{type:rt.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:({referenceWidth:t})=>Ae(r(.5*t),16)}}};class ps{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0}}const ds=65535;class ms extends we{constructor(t,e,s,n){super(t,e,s,n),this.vertexSpec=fs,this._currentWrite=new ps,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:ds,textured:!1},this._tessParams=new ls,this._initializeTessellator()}writeLineVertices(t,e,s){const n=this._getLines(e);null!=n&&this._writeVertices(t,s,n)}_initializeTessellator(){this._lineTessellator=new C(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(t,e,s){const n=s??H.fromFeatureSetReaderCIM(e);n&&this._writeGeometry(t,e,n)}_writeGeometry(t,e,s,n){t.recordStart(this.instanceId,this.attributeLayout,n),this.writeLineVertices(t,s,e),t.recordEnd()}_getLines(t){return re(t,st(this.evaluatedMeshParams))}_writeVertices(t,e,s){const{_currentWrite:n,_tessellationOptions:i,evaluatedMeshParams:o}=this,{width:c,capType:a,joinType:u,miterLimit:h,hasSizeVV:l}=o,f=r(.5*c);i.halfWidth=f,i.capType=Ce(a),i.joinType=Fe(u),i.miterLimit=h;const p=!l;n.out=t,n.id=e.getDisplayId(),n.vertexCount=0,n.indexCount=0,n.vertexFrom=t.vertexCount(),n.vertexBounds=p&&f<G?0:1;for(const{line:t,start:e}of s)i.initialDistance=e%ds,this._lineTessellator.tessellate(t,i,p)}_writeTesselatedVertex(t,e,s,n,i,r,o,c,a,u,h){const{out:l,id:f,vertexBounds:p}=this._currentWrite;return this.hasEffects&&l.recordBounds(t,e,p,p),this._tessParams.extrusionOffsetX=o,this._tessParams.extrusionOffsetY=c,this._tessParams.normalX=a,this._tessParams.normalY=u,this._tessParams.directionX=i,this._tessParams.directionY=r,this._tessParams.distance=h,this._writeVertex(l,f,t,e,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(t,e,s){const{out:n}=this._currentWrite;n.indexEnsureSize(3),n.indexWrite(t),n.indexWrite(e),n.indexWrite(s),this._currentWrite.indexCount+=3}}const ws={createComputedParams:t=>t,attributes:{...fs.attributes,bitset:{type:rt.UNSIGNED_BYTE,count:1,pack:t=>0},color:{type:rt.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>ze(t)}}},gs={createComputedParams:t=>t,attributes:{...fs.attributes,bitset:{type:rt.UNSIGNED_BYTE,count:1,pack:t=>Se([[Ke,!0]])},color:{type:rt.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:t})=>ze(t)}}};class ys extends ms{constructor(){super(...arguments),this.vertexSpec=gs}}class vs extends Ie{constructor(t,e,s,n){super(t,e,s,n),this.vertexSpec=ws,this._lineMeshWriter=this._createOutlineWriter(t,e,s,n)}_createOutlineWriter(t,e,s,n){return new ys(t,e,s,n)}_write(t,e,s){const n=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(n);i&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,i),this._lineMeshWriter.writeLineVertices(t,H.fromOptimizedCIM(i,"esriGeometryPolyline"),e),t.recordEnd())}_clip(t){return t?ie(t,st(this.evaluatedMeshParams)):null}ensurePacked(t,e,s){super.ensurePacked(t,e,s),this._lineMeshWriter.ensurePacked(t,e,s)}enqueueRequest(t,e,s){super.enqueueRequest(t,e,s),this._lineMeshWriter.enqueueRequest(t,e,s)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const bs=()=>n.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class xs{constructor(){this._includedModules=new Map}include(t,e){if(this._includedModules.has(t)){const s=this._includedModules.get(t);if(s!==e){bs().error("Trying to include shader module multiple times with different sets of options.");const e=new Set;for(const n of Object.keys(s))s[n]!==t[n]&&e.add(n);for(const n of Object.keys(t))s[n]!==t[n]&&e.add(n);e.forEach((e=>console.error(`  ${e}: current ${s[e]} new ${t[e]}`)))}}else this._includedModules.set(t,e),t(this.builder,e)}}class ks extends xs{constructor(){super(...arguments),this.vertex=new Ps,this.fragment=new Ps,this.attributes=new _s,this.varyings=new Ss,this.extensions=new zs,this.constants=new Cs}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(t,e=!0){const s=this.extensions.generateSource(t),n=this.attributes.generateSource(t),i=this.varyings.generateSource(t),r="vertex"===t?this.vertex:this.fragment,o=r.uniforms.generateSource(),c=r.code.generateSource(),a="vertex"===t?Os:Fs(e),u=this.constants.generateSource().concat(r.constants.generateSource());return`${e?"#version 300 es":""}\n${s.join("\n")}\n${a}\n${u.join("\n")}\n${o.join("\n")}\n${n.join("\n")}\n${i.join("\n")}\n${c.join("\n")}`}generateBindPass(t){const e=new Map;this.vertex.uniforms.entries.forEach((t=>{const s=t.bind[lt.Pass];s&&e.set(t.name,s)})),this.fragment.uniforms.entries.forEach((t=>{const s=t.bind[lt.Pass];s&&e.set(t.name,s)}));const s=Array.from(e.values()),n=s.length;return(e,i)=>{for(let r=0;r<n;++r)s[r](t,e,i)}}generateBindDraw(t){const e=new Map;this.vertex.uniforms.entries.forEach((t=>{const s=t.bind[lt.Draw];s&&e.set(t.name,s)})),this.fragment.uniforms.entries.forEach((t=>{const s=t.bind[lt.Draw];s&&e.set(t.name,s)}));const s=Array.from(e.values()),n=s.length;return(e,i,r)=>{for(let o=0;o<n;++o)s[o](t,e,i,r)}}}class Ms{constructor(){this._entries=new Map}add(...t){for(const e of t)this._add(e)}get(t){return this._entries.get(t)}_add(t){if(null!=t){if(this._entries.has(t.name)&&!this._entries.get(t.name).equals(t))throw new i(`Duplicate uniform name ${t.name} for different uniform type`);this._entries.set(t.name,t)}else bs().error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map((t=>null!=t.arraySize?`uniform ${t.type} ${t.name}[${t.arraySize}];`:`uniform ${t.type} ${t.name};`))}get entries(){return Array.from(this._entries.values())}}class $s{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}}class Ps extends xs{constructor(){super(...arguments),this.uniforms=new Ms,this.code=new $s,this.constants=new Cs}get builder(){return this}}class _s{constructor(){this._entries=new Array}add(t,e){this._entries.push([t,e])}generateSource(t){return"fragment"===t?[]:this._entries.map((t=>`in ${t[1]} ${t[0]};`))}}class Ss{constructor(){this._entries=new Map}add(t,e){this._entries.has(t)&&o(this._entries.get(t)===e),this._entries.set(t,e)}generateSource(t){const e=new Array;return this._entries.forEach(((s,n)=>e.push("vertex"===t?`out ${s} ${n};`:`in ${s} ${n};`))),e}}class zs{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const e="vertex"===t?zs.ALLOWLIST_VERTEX:zs.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((t=>e.includes(t))).map((t=>`#extension ${t} : enable`))}}zs.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],zs.ALLOWLIST_VERTEX=[];class Cs{constructor(){this._entries=new Set}add(t,e,s){let n="ERROR_CONSTRUCTOR_STRING";switch(e){case"float":n=Cs._numberToFloatStr(s);break;case"int":n=Cs._numberToIntStr(s);break;case"bool":n=s.toString();break;case"vec2":n=`vec2(${Cs._numberToFloatStr(s[0])},                            ${Cs._numberToFloatStr(s[1])})`;break;case"vec3":n=`vec3(${Cs._numberToFloatStr(s[0])},                            ${Cs._numberToFloatStr(s[1])},                            ${Cs._numberToFloatStr(s[2])})`;break;case"vec4":n=`vec4(${Cs._numberToFloatStr(s[0])},                            ${Cs._numberToFloatStr(s[1])},                            ${Cs._numberToFloatStr(s[2])},                            ${Cs._numberToFloatStr(s[3])})`;break;case"ivec2":n=`ivec2(${Cs._numberToIntStr(s[0])},                             ${Cs._numberToIntStr(s[1])})`;break;case"ivec3":n=`ivec3(${Cs._numberToIntStr(s[0])},                             ${Cs._numberToIntStr(s[1])},                             ${Cs._numberToIntStr(s[2])})`;break;case"ivec4":n=`ivec4(${Cs._numberToIntStr(s[0])},                             ${Cs._numberToIntStr(s[1])},                             ${Cs._numberToIntStr(s[2])},                             ${Cs._numberToIntStr(s[3])})`;break;case"mat2":case"mat3":case"mat4":n=`${e}(${Array.prototype.map.call(s,(t=>Cs._numberToFloatStr(t))).join(", ")})`}return this._entries.add(`const ${e} ${t} = ${n};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}}function Fs(t=!0){return`#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n${t?"out vec4 fragColor;":""}\n`}const Os="precision highp float;\nprecision highp sampler2D;";function Ts(t){return t.split(" ").map(((t,e)=>e>0?t.charAt(0).toUpperCase()+t.slice(1):t)).join("")}function As(t,e){const s=[];for(s.push(e);s.length;){const e=s.pop();if("object"==typeof e&&!t.has(e.uid)){t.add(e.uid);for(const t of e.children)s.push(t)}}}class Rs{constructor(){this.uid=Rs.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(t){return t=Ts(t),this._debugName=t,this.isImplicit&&this.children[0]instanceof Rs&&this.children[0].setDebugName(t),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(t){t._debugName=this._debugName,t._isMutable=this._isMutable,t.isImplicit=this.isImplicit,t.uid=this.uid}}function Is(t){return"object"==typeof t?t.clone():t}Rs.NodeCount=0;class Vs extends Rs{constructor(){super(...arguments),this.shaderType="primitive-node"}}class Ds extends Rs{constructor(t){super(),this.child=t,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const t=new Ds(Is(this.child));return this.cloneInto(t),t}}class Ls extends Rs{constructor(t,e,s){super(),this.property=t,this.target=e,this.returnType=s,this.shaderType="property-access-node"}get children(){const t=[this.target];return"string"!=typeof this.property&&t.push(this.property),t}clone(){const t=new Ls(this.property,Is(this.target),this.returnType);return this.cloneInto(t),t}}class Gs extends Rs{constructor(t,e,s){super(),this.condition=t,this.ifTrue=e,this.ifFalse=s,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const t=Is(this.ifTrue),e=this.ifFalse?Is(this.ifFalse):null,s=new Gs(this.condition,t,e);return this.cloneInto(s),s}}class Bs extends Rs{constructor(t,e,s,n){super(),this.captureList=t,this.returnType=e,this.generator=n,this.shaderType="block-node",s&&(this.subgraph=new Ds(s))}get children(){return Object.keys(this.captureList).map((t=>this.captureList[t])).concat(this.subgraph??[])}clone(){const t={};for(const e in this.captureList)t[e]=Is(this.captureList[e]);const e=new Bs(t,this.returnType,this.subgraph?Is(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(e),e}}class Ws extends Rs{constructor(t,e,s,n,i,r=!1){super(),this.token=t,this._children=e,this.isInfix=s,this.isPropertyAccess=n,this.returnType=i,this.isTernary=r,this.shaderType="function-node"}get children(){return this._children}clone(){const t=new Ws(this.token,this._children.map(Is),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(t),t}}var Es,Ns,Us,js,Hs,Xs,Ys,qs,Ks,Zs,Qs,Js,tn,en;function sn(t){const e=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const s of e)if(s.includes(t))return s.map((t=>Fn[t]));throw new Error("Unable to find type family")}function nn(t){return new Proxy(t,{get(e,s){if("constructor"===s)return new Proxy(e.constructor,{construct:(t,e,s)=>nn(new t(...e))});if(s in e)return e[s];if("string"==typeof s){const e=sn(t.type);return Dn(t,s,e[s.length-1])}}})}function rn(t){return new Proxy(t,{construct:(t,e,s)=>nn(new t(...e))})}function on(t){return new Proxy(t,{get(e,s){if(s in e)return e[s];if("string"==typeof s){const e=parseInt(s,10);if(!isNaN(e))return Dn(t,`[${e}]`,t.elementType.constructor)}}})}function cn(t){return new Proxy(t,{construct:(t,e,s)=>on(new t(...e))})}class an extends Error{}let un=Es=class extends Vs{constructor(t,e){super(),this.elementType=t,this.size=e,this.children=[],this.type="array"}clone(){const t=new Es(this.elementType,this.size);return super.cloneInto(t),t}get(t){if("number"==typeof t){const e=new $n(t);return e.isImplicit=!0,Dn(this,e,this.elementType.constructor)}return Dn(this,t,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(t,e,s){return Un(this,t,e,s)}glslFindIndex(t,e,s){return jn(this,t,e,s)}static ofType(t,e){const s={construct:(s,n)=>new Es(new t,e)};return new Proxy(Es,s)}};un.type="array",un=Es=c([cn],un);class hn extends Vs{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const t=new hn;return t.children=this.children.map(Is),super.cloneInto(t),t}}hn.type="sampler2D";class ln extends Vs{constructor(t){super(),this.type="float",this.children=[t]}clone(){const t=new ln(Is(this.children[0]));return super.cloneInto(t),t}multiply(t){return Yn(this,"number"==typeof t?kn(t,ln):t)}divide(t){return qn(this,"number"==typeof t?kn(t,ln):t)}add(t){return Kn(this,"number"==typeof t?kn(t,ln):t)}subtract(t){return Zn(this,"number"==typeof t?kn(t,ln):t)}}ln.type="float";let fn=Ns=class extends Vs{constructor(t,e){super(),this.type="vec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new Ns(Is(this.children[0]),Is(this.children[1]));return super.cloneInto(t),t}get 0(){return Dn(this,"[0]",ln)}get 1(){return Dn(this,"[1]",ln)}get 2(){throw new an}get 3(){throw new an}multiply(t){return Yn(this,"number"==typeof t?kn(t,ln):t)}divide(t){return qn(this,"number"==typeof t?kn(t,ln):t)}add(t){return Kn(this,"number"==typeof t?kn(t,ln):t)}subtract(t){return Zn(this,"number"==typeof t?kn(t,ln):t)}};fn.type="vec2",fn=Ns=c([rn],fn);let pn=Us=class extends Vs{constructor(t,e,s){super(),this.type="vec3",this.children=[t,e,s].filter((t=>null!=t))}get 0(){return Dn(this,"[0]",ln)}get 1(){return Dn(this,"[1]",ln)}get 2(){return Dn(this,"[2]",ln)}get 3(){throw new an}clone(){const t=new Us(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]));return super.cloneInto(t),t}multiply(t){return Yn(this,"number"==typeof t?kn(t,ln):t)}divide(t){return qn(this,"number"==typeof t?kn(t,ln):t)}add(t){return Kn(this,"number"==typeof t?kn(t,ln):t)}subtract(t){return Zn(this,"number"==typeof t?kn(t,ln):t)}};pn.type="vec3",pn=Us=c([rn],pn);let dn=js=class extends Vs{constructor(t,e,s,n){super(),this.type="vec4",this.children=[t,e,s,n].filter((t=>null!=t))}clone(){const t=new js(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]),Is(this.children[3]));return super.cloneInto(t),t}get 0(){return Dn(this,"[0]",ln)}get 1(){return Dn(this,"[1]",ln)}get 2(){return Dn(this,"[2]",ln)}get 3(){return Dn(this,"[3]",ln)}multiply(t){return Yn(this,"number"==typeof t?kn(t,ln):t)}divide(t){return qn(this,"number"==typeof t?kn(t,ln):t)}add(t){return Kn(this,"number"==typeof t?kn(t,ln):t)}subtract(t){return Zn(this,"number"==typeof t?kn(t,ln):t)}};dn.type="vec4",dn=js=c([rn],dn);let mn=Hs=class extends Vs{constructor(t){super(),this.type="uint",this.children=[t]}clone(){const t=new Hs(Is(this.children[0]));return super.cloneInto(t),t}};mn.type="uint",mn=Hs=c([rn],mn);let wn=Xs=class extends Vs{constructor(t,e){super(),this.type="uvec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new Xs(Is(this.children[0]),Is(this.children[1]));return super.cloneInto(t),t}};wn.type="uvec2",wn=Xs=c([rn],wn);let gn=Ys=class extends Vs{constructor(t,e,s){super(),this.type="uvec3",this.children=[t,e,s].filter((t=>null!=t))}clone(){const t=new Ys(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]));return super.cloneInto(t),t}};gn.type="uvec3",gn=Ys=c([rn],gn);let yn=qs=class extends Vs{constructor(t,e,s,n){super(),this.type="uvec4",this.children=[t,e,s,n].filter((t=>null!=t))}clone(){const t=new qs(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]),Is(this.children[3]));return super.cloneInto(t),t}};yn.type="uvec4",yn=qs=c([rn],yn);class vn extends Vs{constructor(t){super(),this.type="bool",this.children=[t]}and(t){return ci(this,t)}or(t){return ri(this,t)}clone(){const t=new vn(Is(this.children[0]));return super.cloneInto(t),t}}vn.type="bool";let bn=Ks=class extends Vs{constructor(t,e){super(),this.type="bvec2",this.children=[t,e].filter((t=>null!=t))}all(){return hi(this)}any(){return li(this)}clone(){const t=new Ks(Is(this.children[0]),Is(this.children[1]));return super.cloneInto(t),t}};bn.type="bvec2",bn=Ks=c([rn],bn);let xn=Zs=class extends Vs{constructor(t,e,s){super(),this.type="bvec3",this.children=[t,e,s].filter((t=>null!=t))}all(){return hi(this)}any(){return li(this)}clone(){const t=new Zs(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]));return super.cloneInto(t),t}};function kn(t,e){if("number"==typeof t){return new e(t)}return t}xn.type="bvec3",xn=Zs=c([rn],xn);let Mn=Qs=class extends Vs{constructor(t,e,s,n){super(),this.type="bvec4",this.children=[t,e,s,n].filter((t=>null!=t))}all(){return hi(this)}any(){return li(this)}clone(){const t=new Qs(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]),Is(this.children[3]));return super.cloneInto(t),t}};Mn.type="bvec4",Mn=Qs=c([rn],Mn);class $n extends Vs{constructor(t){super(),this.type="int",this.children=[t]}multiply(t){return Yn(this,kn(t,$n))}add(t){return Kn(this,kn(t,$n))}subtract(t){return Zn(this,kn(t,$n))}divide(t){return qn(this,kn(t,$n))}clone(){const t=new $n(Is(this.children[0]));return super.cloneInto(t),t}}$n.type="int";let Pn=Js=class extends Vs{constructor(t,e){super(),this.type="ivec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new Js(Is(this.children[0]),Is(this.children[1]));return super.cloneInto(t),t}};Pn.type="ivec2",Pn=Js=c([rn],Pn);let _n=tn=class extends Vs{constructor(t,e,s){super(),this.type="ivec3",this.children=[t,e,s].filter((t=>null!=t))}clone(){const t=new tn(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]));return super.cloneInto(t),t}};_n.type="ivec3",_n=tn=c([rn],_n);let Sn=en=class extends Vs{constructor(t,e,s,n){super(),this.type="ivec4",this.children=[t,e,s,n].filter((t=>null!=t))}clone(){const t=new en(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]),Is(this.children[3]));return super.cloneInto(t),t}};Sn.type="ivec4",Sn=en=c([rn],Sn);class zn extends Vs{static identity(){return new zn(1,0,0,0,1,0,0,0,1)}static fromRotation(t){const e=_i(t),s=di(t);return new zn(s,e,0,En(e),s,0,0,0,1)}constructor(t,e,s,n,i,r,o,c,a){super(),this.type="mat3",this.children=[t,e,s,n,i,r,o,c,a]}add(t){return Kn(this,t)}multiply(t){return Yn(this,t)}clone(){const t=new zn(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]),Is(this.children[3]),Is(this.children[4]),Is(this.children[5]),Is(this.children[6]),Is(this.children[7]),Is(this.children[8]));return super.cloneInto(t),t}}zn.type="mat3";class Cn extends Vs{static identity(){return new Cn(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(t,e,s,n,i,r,o,c,a,u,h,l,f,p,d,m){super(),this.type="mat4",this.children=[t,e,s,n,i,r,o,c,a,u,h,l,f,p,d,m]}static fromColumns(t,e,s,n){return new Cn(t.x,t.y,t.z,t.w,e.x,e.y,e.z,e.w,s.x,s.y,s.z,s.w,n.x,n.y,n.z,n.w)}multiply(t){return Yn(this,t)}clone(){const t=new Cn(Is(this.children[0]),Is(this.children[1]),Is(this.children[2]),Is(this.children[3]),Is(this.children[4]),Is(this.children[5]),Is(this.children[6]),Is(this.children[7]),Is(this.children[8]),Is(this.children[9]),Is(this.children[10]),Is(this.children[11]),Is(this.children[12]),Is(this.children[13]),Is(this.children[14]),Is(this.children[15]));return super.cloneInto(t),t}}Cn.type="mat4";const Fn={float:ln,vec2:fn,vec3:pn,vec4:dn,int:$n,ivec2:Pn,ivec3:_n,ivec4:Sn,uint:mn,uvec2:wn,uvec3:gn,uvec4:yn,bool:vn,bvec2:bn,bvec3:xn,bvec4:Mn},On=(...t)=>new $n(...t),Tn=(...t)=>new ln(...t),An=(...t)=>new fn(...t),Rn=(...t)=>new pn(...t),In=(...t)=>new dn(...t),Vn=(...t)=>new zn(...t);function Dn(t,e,s){const n=new s(new Ls(e,t,s));return n.isImplicit=!0,n}function Ln(t,e,s,n=null){if(n){const i=new n,r=new n(new Ws(t,[e,s],!0,!1,i));return r.isImplicit=!0,r}if("float"===e.type||"int"===e.type){const n=new s.constructor(new Ws(t,[e,s],!0,!1,s.constructor));return n.isImplicit=!0,n}if(("mat2"===e.type||"mat3"===e.type||"mat4"===e.type)&&"float"!==s.type){const n=new s.constructor(new Ws(t,[e,s],!0,!1,s.constructor));return n.isImplicit=!0,n}const i=new e.constructor(new Ws(t,[e,s],!0,!1,e.constructor));return i.isImplicit=!0,i}function Gn(t,e,s=e.constructor){const n=new s(new Ws(t,[e],!1,!1,s));return n.isImplicit=!0,n}function Bn(t,e,s,n=e.constructor){const i=new n(new Ws(t,[e,s],!1,!1,n));return i.isImplicit=!0,i}function Wn(t,e,s,n,i=e.constructor){const r=new i(new Ws(t,[e,s,n],!1,!1,i));return r.isImplicit=!0,r}function En(t){return Yn(t,Tn(-1))}function Nn(t,e,s,n){return new e(new Bs(t,e,s,n))}function Un(t,e,s=0,n=t.size){const i=new $n(s).setMutable().setDebugName("FindIndexIterator"),r=e(t.get(i)).setDebugName("FindIndexPredicate"),o=Nn({iter:i},$n,r,(({out:t,iter:e,subgraph:s})=>`\n${t} = -1;\n\nfor (; ${e} < ${n}; ${e}++) {\n\n${s.body}\n\n  if (${s.varName}) {\n    ${t} = ${e};\n    break;\n  }\n\n}\n`)).setDebugName("FindIndexBlock");return o}function jn(t,e,s=0,n=t.size){const i=Nn({array:t},$n,null,(({out:t,array:i})=>`\n${t} = -1;\nfor (int i = ${s}; i < ${n}; i++) {\n  bool condition;\n  ${e({array:i,i:"i",out:"condition"})}\n  if (condition) {\n    ${t} = i;\n    break;\n  }\n}\n`)).setDebugName("GlslFindIndexBlock");return i}function Hn(t,e,s){const n="function"==typeof e?e():e,i="function"==typeof s?s():s,r=new n.constructor(new Gs(t,n,i));return r.isImplicit=!0,r}function Xn(...t){const e=t.map((([t,e])=>"function"==typeof e?[t,e()]:[t,e])),s=e[0][1].constructor,n=e.findIndex((t=>!0===t[0]));if(-1===n)throw new Error("A cond must have a fallthrough case with `true`/; ");const i=e.slice(0,n),r=e[n][1],o=new s(i.reduceRight(((t,e)=>Hn(e[0],e[1],t)),r));return o.isImplicit=!0,o}function Yn(t,e){return Ln("*",t,e)}function qn(t,e){return Ln("/",t,e)}function Kn(t,e){return Ln("+",t,e)}function Zn(t,e){return Ln("-",t,e)}function Qn(t,e){return Ln(">>",t,e)}function Jn(t,e){return Ln("&",t,e)}function ti(t,e){return Ln("==",t,e,vn)}function ei(t,e){return Ln("<",t,e,vn)}function si(t,e){return Ln("<=",t,e,vn)}function ni(t,e){return Ln(">",t,e,vn)}function ii(t,e){return Ln(">=",t,e,vn)}function ri(...t){return t.length<=1?t[0]:t.slice(1).reduce(((t,e)=>oi(t,e)),t[0])}function oi(t,e){return Ln("||",t,e,vn)}function ci(...t){return t.length<=1?t[0]:t.slice(1).reduce(((t,e)=>ai(t,e)),t[0])}function ai(t,e){return Ln("&&",t,e,vn)}function ui(t){return Gn("abs",t)}function hi(t){return Gn("all",t,vn)}function li(t){return Gn("any",t,vn)}function fi(t){return Gn("ceil",t)}function pi(t,e,s){return Wn("clamp",t,e,s,t.constructor)}function di(t){return Gn("cos",t)}function mi(t,e){return Bn("distance",t,e,ln)}function wi(t,e){return Bn("dot",t,e,ln)}function gi(t){return Gn("floor",t)}function yi(t){return Gn("fract",t)}function vi(t){return Gn("length",t,ln)}function bi(t,e){return Bn("max",t,e)}function xi(t,e){return Bn("min",t,e)}function ki(t,e,s){return Wn("mix",t,e,s)}function Mi(t,e){return Bn("mod",t,e)}function $i(t){return Gn("normalize",t)}function Pi(t){return"bool"===t.type?Gn("!",t):Gn("not",t)}function _i(t){return Gn("sin",t)}function Si(t,e,s){return Wn("smoothstep",t,e,s)}function zi(t,e){return Bn("step",t,e,e.constructor)}function Ci(t,e){return Bn("texture2D",t,e,dn)}const Fi=5;function Oi(t,e,s){const n=e.split("\n");for(const e of n)if(e.trim().length){{let e="";null!=s&&(e+=`/*id:${s??"000"}*/   `),t.body+=e.padEnd(14)}t.body+=" ".repeat(t.indent)+e+"\n"}}class Ti{write(t){for(const e of t.rootOutputNodes())t.shouldPruneOutputNode(e)||(e.variableName=this._write(t,e.node));return t}_createVarName(t,e){let s="";return"boolean"!=typeof e&&"number"!=typeof e&&e.debugInfo.name&&(s=`${e.debugInfo.name}_`),`${s}v${t.varCount++}`}_write(t,e,s=!1){if("number"==typeof e)return e.toString();if("boolean"==typeof e)return e.toString();let n=t.getEmit(e);if(n)return n;switch(e.shaderType){case"scope-node":n=this._writeScopeNode(t,e);break;case"primitive-node":n=this._writePrimitveNode(t,e,s);break;case"function-node":n=this._writeFunctionNode(t,e);break;case"property-access-node":n=this._writePropertyAccessNode(t,e);break;case"text-node":n=e.text;break;case"block-node":n=this._writeBlockNode(t,e);break;case"condition-node":n=this._writeConditionNode(t,e)}return t.setEmit(e,n),n}_writeScopeNode(t,e){const s=new e.child.constructor;s.setDebugName(e.debugInfo.name);const n=this._write(t,s,!0);Oi(t,`{ /*ScopeStart: ${e.uid} ${e.debugInfo.name}*/`),t.indent+=2;return Oi(t,`${n} = ${this._write(t,e.child)};`),t.indent-=2,Oi(t,`} /*ScopeEnd: ${e.uid} ${e.debugInfo.name}*/`),n}_writeConditionNode(t,e){const s=new e.ifTrue.constructor,n=this._write(t,s,!0);Oi(t,`if (${this._write(t,e.condition)}) {`),t.indent+=2;const i=t.createSubgraphContext(),r=this._write(i,e.ifTrue);if(t.body+=i.body,r&&Oi(t,`${n} = ${r};`),t.indent-=2,Oi(t,"}"),e.ifFalse){Oi(t,"else {"),t.indent+=2;const s=t.createSubgraphContext(),i=this._write(s,e.ifFalse);t.body+=s.body,i&&Oi(t,`${n} = ${i};`),t.indent-=2,Oi(t,"}")}return n}_writeBlockNode(t,e){const{captureList:s,generator:n,returnType:i}=e,r={};for(const e in s){if(!s[e])continue;const n=this._write(t,s[e]);r[e]=n}const o=new i,c=this._write(t,o,!0);if(r.out=c,e.subgraph){const s=t.createSubgraphContext(),n=this._write(s,e.subgraph.child),i=s.body;r.subgraph={varName:n,body:i}}const a=n(r);return Oi(t,"{\n"),t.indent+=2,Oi(t,a),t.indent-=2,Oi(t,"}\n"),c}_writePropertyAccessNode(t,e){const s=this._write(t,e.target);if("string"==typeof e.property&&e.property.includes("["))return`${s}${e.property}`;if("string"!=typeof e.property){return`${s}[${this._write(t,e.property)}]`}return`${s}.${e.property}`}_writeFunctionNode(t,e){const s=e.returnType.type;if(e.isInfix){const[n,i]=e.children.map((e=>this._write(t,e))),r=this._createVarName(t,e);return Oi(t,`${s.padEnd(Fi)} ${r} = ${n} ${e.token} ${i};`,e.uid),r}const n=e.children.map((e=>this._write(t,e))).join(", "),i=this._createVarName(t,e);return Oi(t,`${s.padEnd(Fi)} ${i} = ${e.token}(${n});`,e.uid),i}_writePrimitveNode(t,e,s=!1){const n=t.getInput(e);if(n)return n.isUsed=!0,n.variableName;const i=1===e.children.length&&e.children[0]?.type===e.type;if(e.isImplicit||i)return this._write(t,e.children[0]);const r=this._createVarName(t,e);if(s)return Oi(t,`${e.type.padEnd(Fi)} ${r};`,e.uid),r;const o=!e.debugInfo.name&&!e.isMutable;if(o&&"float"===e.type&&"number"==typeof e.children[0])return Number.isInteger(e.children[0])?e.children[0].toFixed(1):e.children[0].toString();if(o&&"int"===e.type&&"number"==typeof e.children[0]&&Number.isInteger(e.children[0]))return e.children[0].toString();const c=e.children.map((e=>this._write(t,e))).join(", ");return"array"===e.type?(Oi(t,`${e.type.padEnd(Fi)} ${r} = [${c}];`,e.uid),r):o?`${e.type}(${c})`:(Oi(t,`${e.type.padEnd(Fi)} ${r} = ${e.type}(${c});`,e.uid),r)}}class Ai{constructor(t,e,s){this.variableName=t,this.variableInputType=e,this.node=s,this.type="shader-input",this.isUsed=!1}clone(){return new Ai(this.variableName,this.variableInputType,Is(this.node))}}class Ri{constructor(t,e,s){this.outVariableName=t,this.outVariableType=e,this.node=s,this.type="shader-output"}clone(){const t=new Ri(this.outVariableName,this.outVariableType,Is(this.node));return t.variableName=this.variableName,t}}class Ii{static createVertex(t,e,s,n,i,r){const o=[];for(const e in t){const n=t[e],i=s.get(e);i?o.push(new Ai(i,"builtin",n)):o.push(new Ai("a_"+e,"attribute",n))}for(const t of n){const e=t.uniformHydrated;o.push(new Ai(t.uniformName,"uniform",e))}const c=[];for(const t in e){const s=e[t];"glPosition"===t?c.push(new Ri("gl_Position","builtin",s)):"glPointSize"===t?c.push(new Ri("gl_PointSize","builtin",s)):c.push(new Ri("v_"+t,"varying",s))}return new Ii(o,c,i,r)}static createFragment(t,e,s,n,i,r){const o=[],c=Array.from(i.rootOutputNodes());for(const e in t){const n=t[e],i=s.get(e);if(i){o.push(new Ai(i,"builtin",n));continue}const r=c.find((t=>t.node===n));r&&o.push(new Ai(r.outVariableName,r.outVariableType,n))}for(const t of n){const e=t.uniformHydrated;o.push(new Ai(t.uniformName,"uniform",e))}const a=[];for(const t in e){const n=e[t],i=s.get(t);if("discard"===t)a.push(new Ri(null,"discard",n));else{if(!i)throw new Error(`Member ${t} in shader fragment output shoule be tagged as builtin`);a.push(new Ri(i,"builtin",n))}}return new Ii(o,a,r)}constructor(t,e,s,n){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const e of t)this._inputShaderTypesByNodeUid.set(e.node.uid,e);this._outputShaderTypes=e,this._transformFeedbackBindings=s,this._transformFeedbackNames=new Set(s.map((t=>"v_"+t.propertyKey))),this._usedInFragmentShader=n}shouldPruneOutputNode(t){return!!this._usedInFragmentShader&&("builtin"!==t.outVariableType&&(!this._transformFeedbackNames.has(t.outVariableName)&&!this._usedInFragmentShader.has(t.node.uid)))}setEmit(t,e){this._nodeEmitMap.set(t.uid,e)}getEmit(t){return this._nodeEmitMap.get(t.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(t){return this._inputShaderTypesByNodeUid.get(t.uid)}*rootOutputNodes(){for(const t of this._outputShaderTypes)yield t}*nodes(){const t=[];for(const e of this._outputShaderTypes.values())t.push(e.node);for(;t.length;){const e=t.pop();"number"!=typeof e&&"boolean"!=typeof e&&t.push(...e.children.filter(Boolean)),yield e}}*nodesOfTypeOrFunction(){for(const t of this.nodes())"number"!=typeof t&&"boolean"!=typeof t&&(yield t)}createSubgraphContext(){const t=this.clone();return t.body="",t.indent=this.indent+2,t._nodeEmitMap=new Map(this._nodeEmitMap),t}clone(){const t=new Ii([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return t._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,t.indent=this.indent,t.body=this.body,t.varCount=this.varCount,t._nodeEmitMap=this._nodeEmitMap,t}insertVertexShader(t){t.vertex.code.add(""),this._insertInputs(t,"vertex"),t.vertex.code.add(""),t.vertex.code.add("// OUTPUTS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this.rootOutputNodes()){const s="builtin"===e.outVariableType;this.shouldPruneOutputNode(e)||(s?t.vertex.code.add(`// ${e.outVariableType.padEnd(7)} ${e.node.type.padEnd(9)} ${e.outVariableName};`):t.vertex.code.add(`${e.outVariableType.padEnd(10)} ${e.node.type.padEnd(9)} ${e.outVariableName};`))}t.vertex.code.add(""),t.vertex.code.add("void main() {"),t.vertex.code.add("  "+this.body.split("\n").join("\n  "));for(const e of this.rootOutputNodes())this.shouldPruneOutputNode(e)||t.vertex.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.vertex.code.add("}")}insertFragmentShader(t){this._insertInputs(t,"fragment"),t.fragment.code.add(""),t.fragment.code.add("void main() {"),t.fragment.code.add("  "+this.body.split("\n").join("\n  "));for(const e of this.rootOutputNodes())"discard"===e.outVariableType?(t.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),t.fragment.code.add(`  if (${e.variableName}) {`),t.fragment.code.add("    discard;"),t.fragment.code.add("  }"),t.fragment.code.add("  ")):t.fragment.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.fragment.code.add("}")}_insertInputs(t,e){t[e].code.add("// INPUTS: "),t[e].code.add("// --------------------------------------------------------- ");for(const s of this.inputs())s.isUsed&&"builtin"!==s.variableInputType&&("array"===s.node.type?t[e].code.add(`${s.variableInputType.padEnd(10)} ${s.node.elementType.type.padEnd(9)} ${s.variableName}[${s.node.size}];`):t[e].code.add(`${s.variableInputType.padEnd(10)} ${s.node.type.padEnd(9)} ${s.variableName};`))}}const Vi=()=>n.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram");function Di(t,e,s){const n=e.length;if(n!==s){const r=new i("Invalid Uniform",`Invalid length, expected ${s} but got ${n}`,{uniformName:t,values:e});Vi().errorOnce(r)}}class Li{constructor(t,e,s,n,i,r){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=t,this.fragmentShader=e,this._locations=s,this._locationInfo=n,this._uniformBindings=i,this._transformFeedbackBindings=r}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(t){this._uniforms=t}cleanupTemporaryTextures(){for(const t of this._temporaryTextures)t.dispose();this._temporaryTextures=[]}bind(t){const e=this._uniforms;if(!this._program){const e=new Map;for(const[t,s]of this._locations)e.set(t,s);const s=[];for(const t of this._transformFeedbackBindings??[]){const{index:e,propertyKey:n}=t;s[e]=`v_${n}`}this._program=new ft(t,this.vertexShader,this.fragmentShader,e,new Map,s)}const s=this._program;t.useProgram(s);for(const n of this._uniformBindings){const{shaderModulePath:i,uniformName:r,uniformType:o,uniformArrayLength:c}=n,u=a(i,e);if(null==u){if("sampler2D"===o)continue;throw new Error(`Failed to find uniform value for ${i}`)}switch("array"===o?n.uniformArrayElementType:o){case"sampler2D":{const{unit:e,texture:n}=u;if(s.setUniform1i(r,e),"type"in n)t.bindTexture(n,e);else{const s=nt(t,n.descriptor,n.data);t.bindTexture(s,e)}break}case"int":if(!c){s.setUniform1i(r,u);break}Di(n.uniformName,u,c),s.setUniform1iv(r,u);break;case"float":if(!c){s.setUniform1f(r,u);break}Di(n.uniformName,u,c),s.setUniform1fv(r,u);break;case"vec2":if(!c){s.setUniform2f(r,u[0],u[1]);break}Di(n.uniformName,u,c),s.setUniform2fv(r,u.flat());break;case"vec3":if(!c){s.setUniform3f(r,u[0],u[1],u[2]);break}Di(n.uniformName,u,c),s.setUniform3fv(r,u.flat());break;case"vec4":if(!c){s.setUniform4f(r,u[0],u[1],u[2],u[3]);break}Di(n.uniformName,u,c),s.setUniform4fv(r,u.flat());break;case"mat3":s.setUniformMatrix3fv(r,u.flat());break;case"mat4":s.setUniformMatrix4fv(r,u.flat());break;default:throw new Error(`Unable to set uniform for type ${o}`)}}}}function Gi(t){return new t}function Bi(t,e,s){const n=t.constructor[e]??[];t.constructor.hasOwnProperty(e)||Object.defineProperty(t.constructor,e,{value:n.slice()}),t.constructor[e].push(s)}function Wi(t,e){return(s,n)=>{Bi(s,"locations",{typeCtor:e,propertyKey:n,parameterIndex:null,index:t})}}const Ei=t=>(e,s)=>{Bi(e,"builtins",{builtin:t,propertyKey:s})},Ni=t=>(e,s,n)=>{Bi(e,"inputs",{inputCtor:t,propertyKey:s,parameterIndex:n})},Ui=t=>(e,s)=>{Bi(e,"uniforms",{typeCtor:t,propertyKey:s})},ji=t=>(e,s)=>{Bi(e,"options",{typeCtor:t,propertyKey:s})},Hi=(t,e)=>{Bi(t,"defines",{propertyKey:e})};const Xi=(t,e)=>(s,n)=>{s.constructor.builtins.push({builtin:t,propertyKey:n,typeCtor:e})};class Yi{}Yi.builtins=[],c([Xi("gl_VertexID",$n)],Yi.prototype,"glVertexID",void 0);class qi{}class Ki{}Ki.builtins=[],c([Xi("gl_FragCoord",dn)],Ki.prototype,"glFragCoord",void 0),c([Xi("gl_PointCoord",fn)],Ki.prototype,"glPointCoord",void 0);class Zi{}c([Ei("gl_FragColor")],Zi.prototype,"glFragColor",void 0);class Qi{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}}class Ji{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const t=u(this._shaderModuleClass.inputs,(t=>"vertex"===t.propertyKey&&0===t.parameterIndex));if(!t)throw new Error("Unable to find vertex input parameter");return t}get computeInput(){return u(this._shaderModuleClass.inputs,(t=>"vertex"===t.propertyKey&&1===t.parameterIndex))}get fragmentInput(){const t=u(this._shaderModuleClass.inputs,(t=>"fragment"===t.propertyKey));if(!t)throw new Error("Unable to find fragment input parameter");return t}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){return[...this.vertexInput.inputCtor.locations,...this.computeInput?.inputCtor.locations??[]]}get locationsMap(){const t=new Map,e=new Set;for(const s of this.locations)e.has(s.index)?n.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${s.propertyKey} to ${s.index}. Index already in use`,{locationsMap:t}):(t.set(s.propertyKey,s.index),e.add(s.index));return t}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,e=Array.from(t.entries()).map((([t,e])=>`${t}.${e}`)).join("."),s=h(e);this._locationInfo={hash:s,locations:t}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const e of this.locations)t.set("a_"+e.propertyKey,e.index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set;for(const e of this._options)t.add(e.propertyKey);this._optionPropertyKeys=t}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(t,e,s,n){try{const{vertex:i,fragment:r,uniformBindings:o}=this._generateShaders(t,e,s,n);return new Li(i,r,this.renamedLocationsMap,this.locationInfo,o,this.transformFeedbackBindings)}catch(t){return console.error("Failed to create program",{error:t}),new Li("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(t){const e=this._options.find((e=>e.propertyKey===t));if(e)return{type:"option",className:e.typeCtor};const s=this._uniforms.find((e=>e.propertyKey===t));if(!s)throw new Error(`Unable to find uniform class type for property: ${t}`);return{type:"required",className:s.typeCtor}}getShaderKey(t,e,s,n){const i=Object.keys(s).map((t=>`${t}.${s[t]}`)).join("."),r=Object.keys(n).map((t=>`${t}.${n[t]}`)).join("."),o=Object.keys(e).filter((t=>this.optionPropertyKeys.has(t)&&e[t])).join(".");return`${this.constructor.name}.${t.hash}.${i}.${r}.${o}`}_generateShaders(t,e,s,n){const i=[];this._setDefines(s),this._setOptionalUniforms(i,e),this._setRequiredUniforms(i);const r=this._hydrateVertexInput(n),o=this._injectPackPrecisionFactor(r,t),c=this._hydrateComputeInput(),a=c&&this._injectPackPrecisionFactor(c,t),u=this.vertex(o,a),h=this._hydrateFragmentInput(u),l=this.fragment(h),f=new Set;for(const t in l){const e=l[t];As(f,e)}const p=this._getVertexInputBuiltins(),d=Ii.createVertex({...r,...c},u,p,i,this.transformFeedbackBindings,f);(new Ti).write(d);const m=this._getFragmentInputBuiltins(l);m.set("glPointCoord","gl_PointCoord");const w=Ii.createFragment(h,l,m,i,d,this.transformFeedbackBindings);(new Ti).write(w);const g=this._createShaderBuilder(d,w),y=g.generate("vertex",!1),v=g.generate("fragment",!1);return this.logShader&&(console.log(y),console.log(v)),{vertex:y,fragment:v,uniformBindings:i}}_setDefines(t){for(const e in t)this[e]=t[e]}_setOptionalUniforms(t,e){for(const s of this._options){e[s.propertyKey]?this[s.propertyKey]=this._hydrateUniformGroup(t,s):this[s.propertyKey]=null}}_setRequiredUniforms(t){for(const e of this._uniforms)this[e.propertyKey]=this._hydrateUniformGroup(t,e)}_hydrateUniformGroup(t,e){const s=new e.typeCtor;for(const n of s._uniforms??[]){const i=Gi(n.typeCtor),r=`u_${e.propertyKey}_${n.propertyKey}`,o=i.type,c=[e.propertyKey,n.propertyKey].join(".");if("type"in n.typeCtor&&"array"===n.typeCtor.type){const e=i;t.push({shaderModulePath:c,uniformName:r,uniformType:o,uniformArrayLength:e.size,uniformArrayElementType:e.elementType.type,uniformHydrated:i})}else t.push({shaderModulePath:c,uniformName:r,uniformType:o,uniformHydrated:i});s[n.propertyKey]=i}return s}_hydrateVertexInput(t){const e=this.vertexInput.inputCtor,s=e.locations.reduce(((e,s)=>!1===t[s.propertyKey]?e:{...e,[s.propertyKey]:Gi(s.typeCtor)}),{});for(const{propertyKey:t,typeCtor:n}of e.builtins){const e=Gi(n);s[t]=e}return s}_hydrateComputeInput(){if(null==this.computeInput)return null;return this.computeInput.inputCtor.locations.reduce(((t,e)=>({...t,[e.propertyKey]:Gi(e.typeCtor)})),{})}_injectPackPrecisionFactor(t,e){const s={};for(const n in t){const i=t[n],r=e.attributes.find((t=>t.name===n));if(r?.packPrecisionFactor){if("float"!==i.type&&"vec2"!==i.type&&"vec3"!==i.type&&"vec4"!==i.type)throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${i.type}`);s[n]=i.divide(new ln(r.packPrecisionFactor))}else s[n]=i}return s}_hydrateFragmentInput(t){const e={};for(const s in t)e[s]=t[s];for(const{propertyKey:t,typeCtor:s}of Ki.builtins){const n=Gi(s);e[t]=n}return e}_getVertexInputBuiltins(){const t=this.vertexInput.inputCtor,e=new Map;for(const{builtin:s,propertyKey:n}of t.builtins)e.set(n,s);return e}_getFragmentInputBuiltins(t){const e=t.constructor,s=new Map;for(const t of e.builtins??[])s.set(t.propertyKey,t.builtin);return s}_createShaderBuilder(t,e){const s=new ks;return this._insertDebugInfo(s),t.insertVertexShader(s),e.insertFragmentShader(s),s}_insertDebugInfo(t){t.vertex.code.add("// DEFINES: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._defines)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`);t.vertex.code.add(""),t.vertex.code.add("// OPTIONS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._options)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`)}}function tr(t){const e=Tn(12.9898),s=Tn(78.233),n=Tn(43758.5453),i=wi(t,An(e,s)),r=Mi(i,Tn(3.14));return yi(_i(r).multiply(n))}function er(t){return ti(t,Tn(Ye))}function sr(t,e){return t.x.multiply(e.y).subtract(e.x.multiply(t.y))}function nr(t){return t.multiply(2).subtract(1)}function ir(t,e){const s=Tn(2**e);return Mi(gi(t.divide(s)),Tn(2))}function rr(t,e){return ni(ir(t,e),Tn(.5))}function or(t,e){return ir(t,e+pt.length)}function cr(t,e){return ir(t,e)}function ar(t){const e=ir(t.z,7),s=Tn(1).subtract(e),n=t.xyz.subtract(Rn(0,0,Tn(128)));return s.multiply(t).add(e.multiply(n))}function ur(t){const e=In(255/256,255/65536,255/16777216,255/4294967296);return wi(t,e)}function hr(t){return bi(bi(bi(t.x,t.y),t.z),t.w)}class lr extends Qi{getVisualVariableData(t){if(!this._vvData){const e=this.getAttributeDataCoords(t);this._vvData=Ci(this.visualVariableData,e).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const e=ar(t),s=this.size,n=On(e.x),i=On(e.y).multiply(On(256)),r=On(e.z).multiply(On(256)).multiply(On(256)),o=Tn(n.add(i).add(r)),c=Mi(o,s),a=o.subtract(c).divide(s);this._uv=new fn(c,a).add(.5).divide(s)}return this._uv}getFilterData(t){const e=this.getAttributeDataCoords(t);return Ci(this.filterFlags,e).setDebugName("storage0")}getAnimationData(t){const e=this.getAttributeDataCoords(t);return Ci(this.animation,e).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const e=this.getAttributeDataCoords(t);return Ci(this.dataDriven0,e).setDebugName("storage30")}getDataDrivenData1(t){const e=this.getAttributeDataCoords(t);return Ci(this.dataDriven1,e).setDebugName("storage31")}getDataDrivenData2(t){const e=this.getAttributeDataCoords(t);return Ci(this.dataDriven2,e).setDebugName("storage32")}getGPGPUData(t){const e=this.getAttributeDataCoords(t);return Ci(this.gpgpu,e).setDebugName("storage4")}getFilterFlags(t){return e("webgl-ignores-sampler-precision")?fi(this.getFilterData(t).x.multiply(Tn(255))):this.getFilterData(t).x.multiply(Tn(255))}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}}c([Ui(hn)],lr.prototype,"filterFlags",void 0),c([Ui(hn)],lr.prototype,"animation",void 0),c([Ui(hn)],lr.prototype,"gpgpu",void 0),c([Ui(hn)],lr.prototype,"visualVariableData",void 0),c([Ui(hn)],lr.prototype,"dataDriven0",void 0),c([Ui(hn)],lr.prototype,"dataDriven1",void 0),c([Ui(hn)],lr.prototype,"dataDriven2",void 0),c([Ui(ln)],lr.prototype,"size",void 0);class fr extends Qi{}c([Ui(ln)],fr.prototype,"activeReasons",void 0),c([Ui(ln)],fr.prototype,"highlightAll",void 0);class pr extends Qi{}c([Ui(fn)],pr.prototype,"position",void 0),c([Ui(ln)],pr.prototype,"distance",void 0),c([Ui(ln)],pr.prototype,"smallSymbolDistance",void 0),c([Ui(ln)],pr.prototype,"smallSymbolSizeThreshold",void 0);class dr extends Qi{}c([Ui(zn)],dr.prototype,"displayViewScreenMat3",void 0),c([Ui(zn)],dr.prototype,"displayViewMat3",void 0),c([Ui(zn)],dr.prototype,"displayMat3",void 0),c([Ui(zn)],dr.prototype,"viewMat3",void 0),c([Ui(zn)],dr.prototype,"tileMat3",void 0),c([Ui(ln)],dr.prototype,"displayZoomFactor",void 0),c([Ui(ln)],dr.prototype,"requiredZoomFactor",void 0),c([Ui(fn)],dr.prototype,"tileOffset",void 0),c([Ui(ln)],dr.prototype,"currentScale",void 0),c([Ui(ln)],dr.prototype,"currentZoom",void 0),c([Ui(ln)],dr.prototype,"metersPerSRUnit",void 0),c([Ui(ln)],dr.prototype,"rotation",void 0),c([Ui(ln)],dr.prototype,"pixelRatio",void 0);class mr extends Yi{}c([Wi(0,pn)],mr.prototype,"id",void 0),c([Wi(1,ln)],mr.prototype,"bitset",void 0),c([Wi(2,fn)],mr.prototype,"pos",void 0);class wr extends qi{}c([Wi(14,fn)],wr.prototype,"nextPos1",void 0),c([Wi(15,fn)],wr.prototype,"nextPos2",void 0);class gr extends Ki{}class yr extends Ji{clip(t,e){let s=new ln(0);const n=this.storage.getFilterFlags(t);if(s=s.add(Tn(2).multiply(Tn(1).subtract(or(n,0)))),this.inside?s=s.add(Tn(2).multiply(Tn(1).subtract(or(n,1)))):this.outside?s=s.add(Tn(2).multiply(or(n,1))):this.highlight&&(s=s.add(Tn(2).multiply(Tn(1).subtract(this._checkHighlight(n))))),null!=e){const t=new ln(1).subtract(zi(e.x,this.view.currentZoom)),n=zi(e.y,this.view.currentZoom);s=s.add(new ln(2).multiply(t.add(n)))}return s}getFragmentOutput(t,e,s=new ln(1/255)){const n=new Zi;return n.glFragColor=this._maybeWriteHittest(e)??this._maybeHighlight(t,s)??t,n}_maybeHighlight(t,e){return this.highlight?new dn(t.rgb,zi(e,t.a)):null}_checkHighlight(t){let e=this._checkHighlightBit(t,0);for(let s=1;s<pt.length;s++)e=e.add(this._checkHighlightBit(t,s));return zi(new ln(.1),e.add(this.highlight.highlightAll))}_checkHighlightBit(t,e){return cr(t,e).multiply(ir(this.highlight.activeReasons,e))}maybeRunHittest(t,e,s){if(null==this.hittestRequest)return null;const n=this.hittest(t,e,s);let i=Hn(ni(n,this.hittestRequest.distance),new ln(2),new ln(0));const r=this.storage.getAttributeDataCoords(t.id),o=nr(r);i=i.add(this.clip(t.id,t.zoomRange));const c=new dn(new ln(1/255),0,0,0);return{glPointSize:new ln(1),glPosition:new dn(o,i,1),color:c}}_maybeWriteHittest(t){return null!=this.hittestRequest?t.color:null}}c([Hi],yr.prototype,"inside",void 0),c([Hi],yr.prototype,"outside",void 0),c([ji(fr)],yr.prototype,"highlight",void 0),c([Ui(lr)],yr.prototype,"storage",void 0),c([Ui(dr)],yr.prototype,"view",void 0),c([ji(pr)],yr.prototype,"hittestRequest",void 0);function vr(t,e){return wi(t,$i(e))}function br(t,e,s){const n=s.subtract(e),i=vr(t.subtract(e),n),r=pi(i.divide(vi(n)),new ln(0),new ln(1));return mi(t,e.add(r.multiply(s.subtract(e))))}function xr(t){const e=ui(t);return zi(e.x.add(e.y).add(e.z),new ln(1.05))}function kr(t,e,s,n){const i=new zn(s.x.multiply(n.y).subtract(n.x.multiply(s.y)),n.x.multiply(e.y).subtract(e.x.multiply(n.y)),e.x.multiply(s.y).subtract(s.x.multiply(e.y)),s.y.subtract(n.y),n.y.subtract(e.y),e.y.subtract(s.y),n.x.subtract(s.x),e.x.subtract(n.x),s.x.subtract(e.x)),r=e.x.multiply(s.y.subtract(n.y)),o=s.x.multiply(n.y.subtract(e.y)),c=n.x.multiply(e.y.subtract(s.y)),a=r.add(o).add(c);return new ln(1).divide(a).multiply(i.multiply(new pn(1,t)))}function Mr(t,e,s,n){return ti(xr(kr(t,e,s,n)),new ln(1))}function $r(t,e,s,n){const i=s.subtract(e),r=n.subtract(e),o=sr(i,r),c=ci(ei(o,new ln(Xe)),ni(o,new ln(-Xe)));return Xn([ci(Pi(c),Mr(t.xy,e,s,n)),new ln(-1)],[!0,()=>{const i=br(t,e,s),r=br(t,s,n),o=br(t,n,e);return xi(xi(i,r),o)}])}function Pr(t){return t.distance.add(1)}function _r(t,e,s){const{viewMat3:n,tileMat3:i}=t.view,r=n.multiply(i),o=r.multiply(new pn(e.pos,1)),c=r.multiply(new pn(s.nextPos1,1)),a=r.multiply(new pn(s.nextPos2,1));return $r(t.hittestRequest.position,o.xy,c.xy,a.xy)}function Sr(t,e,s){return mi(t,s).subtract(e)}class zr extends Qi{getColor(t,e,s){return Xn([ri(er(t),s),e],[si(t,this.values.first()),this.colors.first()],[ii(t,this.values.last()),this.colors.last()],[!0,()=>{const e=this.values.findIndex((e=>ni(e,t))),s=this.values.get(e),n=e.subtract(1),i=this.values.get(n),r=t.subtract(i).divide(s.subtract(i));return ki(this.colors.get(n),this.colors.get(e),r)}])}}c([Ui(un.ofType(dn,8))],zr.prototype,"colors",void 0),c([Ui(un.ofType(ln,8))],zr.prototype,"values",void 0);class Cr extends Qi{getOpacity(t){return Xn([er(t),new ln(1)],[si(t,this.opacityValues.first()),this.opacities.first()],[ii(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const e=this.opacityValues.findIndex((e=>ni(e,t))),s=this.opacityValues.get(e),n=e.subtract(1),i=this.opacityValues.get(n),r=t.subtract(i).divide(s.subtract(i));return ki(this.opacities.get(n),this.opacities.get(e),r)}])}}c([Ui(un.ofType(ln,8))],Cr.prototype,"opacities",void 0),c([Ui(un.ofType(ln,8))],Cr.prototype,"opacityValues",void 0);function Fr(t){return null!=t.visualVariableSizeMinMaxValue||null!=t.visualVariableSizeScaleStops||null!=t.visualVariableSizeStops||null!=t.visualVariableSizeUnitValue}function Or(t,e,s){if(Fr(t)){const n=t.storage.getSizeValue(e);return t.visualVariableSizeMinMaxValue?.getSize(n,s)??t.visualVariableSizeScaleStops?.getSizeForViewScale(t.view.currentScale)??t.visualVariableSizeStops?.getSize(n,s)??t.visualVariableSizeUnitValue?.getSize(n,s)}return s}function Tr(t,e,s,n=new vn(!1)){if(null==t.visualVariableColor)return s;const i=t.storage.getColorValue(e);return t.visualVariableColor.getColor(i,s,n)}function Ar(t,e){if(null==t.visualVariableOpacity)return new ln(1);const s=t.storage.getOpacityValue(e);return t.visualVariableOpacity.getOpacity(s)}function Rr(t,e){if(null==t.visualVariableRotation)return zn.identity();const s=t.storage.getRotationValue(e);return t.visualVariableRotation.getVVRotationMat3(s)}class Ir extends mr{}c([Wi(3,dn)],Ir.prototype,"color",void 0),c([Wi(4,fn)],Ir.prototype,"zoomRange",void 0);class Vr extends yr{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const s=Ar(this,t.id),n=Tr(this,t.id,t.color).multiply(s),i=this.view.displayViewScreenMat3.multiply(new pn(t.pos.xy,1)),r=this.clip(t.id,t.zoomRange);return{glPosition:new dn(i.xy,r,1),color:n,...this.maybeRunHittest(t,e,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new ln(0))}hittest(t,e){return _r(this,t,e)}}c([ji(zr)],Vr.prototype,"visualVariableColor",void 0),c([ji(Cr)],Vr.prototype,"visualVariableOpacity",void 0),c([l(0,Ni(Ir)),l(1,Ni(wr))],Vr.prototype,"vertex",null),c([l(0,Ni(gr))],Vr.prototype,"fragment",null);class Dr extends Qi{getPatternOffsetAtTileOrigin(t,e=new ln(0),s=new ln(1)){const n=new fn(is).divide(t);let i=t.multiply(yi(this.maxIntsToLocalOrigin.multiply(n))).add(this.tileOffsetFromLocalOrigin).subtract(new ln(.5).multiply(t));return i=new fn(i.x.multiply(s).subtract(i.y.multiply(e)),i.x.multiply(e).add(i.y.multiply(s))),Mi(i,t)}}c([Ui(fn)],Dr.prototype,"tileOffsetFromLocalOrigin",void 0),c([Ui(fn)],Dr.prototype,"maxIntsToLocalOrigin",void 0);class Lr extends Qi{}c([Ui(fn)],Lr.prototype,"size",void 0),c([Ui(hn)],Lr.prototype,"texture",void 0);class Gr extends Ir{}c([Wi(5,dn)],Gr.prototype,"tlbr",void 0),c([Wi(6,ln)],Gr.prototype,"width",void 0),c([Wi(7,ln)],Gr.prototype,"height",void 0),c([Wi(8,fn)],Gr.prototype,"offset",void 0),c([Wi(9,fn)],Gr.prototype,"scale",void 0),c([Wi(10,ln)],Gr.prototype,"angle",void 0);class Br extends gr{}function Wr(t,e,s,n,i){const r=ti(ir(i,Ze),Tn(1)),o=ur(new dn(t,0));return Hn(r,Vn(n.divide(e.x),s.divide(e.y),0,En(s.divide(e.x)),n.divide(e.y),0,tr(An(o,0)),tr(An(0,o)),1),Vn(n.divide(e.x),s.divide(e.y),0,En(s.divide(e.x)),n.divide(e.y),0,0,0,1))}function Er(t,e){const s=ki(new fn(1),new fn(1/L),new fn(ir(e.bitset,Je),ir(e.bitset,Qe))),n=t.view.requiredZoomFactor,i=new fn(e.width,e.height).multiply(s),r=i.multiply(e.scale).multiply(n),o=e.angle.multiply(Be),c=_i(o),a=di(o),u=Wr(e.id,r,c,a,e.bitset),h=t.localTileOffset.getPatternOffsetAtTileOrigin(i,c,a),l=n.multiply(e.scale).multiply(e.offset.subtract(h)).divide(r),f=new pn(e.pos,1),p=u.multiply(f).xy.subtract(l),d=e.tlbr.divide(t.mosaicInfo.size.xyxy);let m=ir(e.bitset,qe);return null!=t.visualVariableColor&&(m=Hn(er(t.storage.getColorValue(e.id)),new ln(0),m)),{tileTextureCoord:p,tlbr:d,sampleAlphaOnly:m}}function Nr(t,e){const s=Mi(e.tileTextureCoord,new ln(1)),n=ki(e.tlbr.xy,e.tlbr.zw,s);let i=Ci(t.mosaicInfo.texture,n);return i=Hn(ni(e.sampleAlphaOnly,new ln(.5)),i.aaaa,i),e.color.multiply(i)}class Ur extends Vr{vertex(t,e){return{...super.vertex(t,e),...Er(this,t)}}fragment(t){const e=Nr(this,t);return this.getFragmentOutput(e,t,new ln(0))}}c([Ui(Lr)],Ur.prototype,"mosaicInfo",void 0),c([Ui(Dr)],Ur.prototype,"localTileOffset",void 0),c([l(0,Ni(Gr)),l(1,Ni(wr))],Ur.prototype,"vertex",null),c([l(0,Ni(Br))],Ur.prototype,"fragment",null);class jr extends Qi{getSize(t,e){const s=this.minMaxValueAndSize.xy,n=this.minMaxValueAndSize.zw;return Hn(er(t),e,(()=>{const e=t.subtract(s.x).divide(s.y.subtract(s.x)),i=pi(e,new ln(0),new ln(1));return n.x.add(i.multiply(n.y.subtract(n.x)))}))}}c([Ui(dn)],jr.prototype,"minMaxValueAndSize",void 0);class Hr extends Qi{getSizeForViewScale(t){return Xn([si(t,this.values.first()),this.sizes.first()],[ii(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex((e=>ni(e,t))),s=this.values.get(e),n=e.subtract(1),i=this.values.get(n),r=t.subtract(i).divide(s.subtract(i));return ki(this.sizes.get(n),this.sizes.get(e),r)}])}}c([Ui(un.ofType(ln,8))],Hr.prototype,"sizes",void 0),c([Ui(un.ofType(ln,8))],Hr.prototype,"values",void 0);class Xr extends Qi{getSize(t,e){const s=Xn([er(t),e],[si(t,this.values.first()),this.sizes.first()],[ii(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex((e=>ni(e,t))),s=this.values.get(e),n=e.subtract(1),i=this.values.get(n),r=t.subtract(i).divide(s.subtract(i));return ki(this.sizes.get(n),this.sizes.get(e),r)}]);return Hn(er(s),e,s)}}c([Ui(un.ofType(ln,8))],Xr.prototype,"sizes",void 0),c([Ui(un.ofType(ln,8))],Xr.prototype,"values",void 0);class Yr extends Qi{getSize(t,e){return Hn(er(t),e,t.multiply(this.unitValueToPixelsRatio))}}c([Ui(ln)],Yr.prototype,"unitValueToPixelsRatio",void 0);class qr extends mr{}c([Wi(3,dn)],qr.prototype,"color",void 0),c([Wi(4,fn)],qr.prototype,"offset",void 0),c([Wi(5,fn)],qr.prototype,"normal",void 0),c([Wi(6,ln)],qr.prototype,"halfWidth",void 0),c([Wi(7,ln)],qr.prototype,"referenceHalfWidth",void 0),c([Wi(8,fn)],qr.prototype,"zoomRange",void 0);class Kr extends gr{}class Zr extends Qi{}function Qr(t){return bi(new ln(Ee).multiply(zi(t,new ln(Ne))),new ln(1))}function Jr(t,e){const{halfWidth:s,normal:n}=t,i=Qr(s),r=vi(n).multiply(s);return pi(i.multiply(s.subtract(r)).divide(e.add(i).subtract(new ln(1))),new ln(0),new ln(1))}function to(t,e){const{id:s,halfWidth:n,referenceHalfWidth:i}=e;if(Fr(t)){const e=new ln(2).multiply(i),r=Or(t,s,e);return new ln(.5).multiply(n.divide(bi(i,new ln(He)))).multiply(r)}return n}function eo(t,e){const{id:s,offset:n,pos:i,normal:r,zoomRange:o}=e,{displayViewScreenMat3:c,displayViewMat3:a}=t.view,u=Tr(t,s,e.color),h=Ar(t,s),l=to(t,e),f=new ln(.5).multiply(t.antialiasingControls.antialiasing),p=bi(l.add(f),new ln(.45)).add(new ln(.1).multiply(f)),d=Qr(p).multiply(p).multiply(n),m=a.multiply(new pn(d,new ln(0))),w=c.multiply(new pn(i,new ln(1))).add(m),g=new ln(2).multiply(zi(l,new ln(0))).add(t.clip(s,o)),y=new dn(w.xy,g,1);return{color:u,opacity:h,halfWidth:p,normal:r,scaledOffset:d,scaledHalfWidth:l,glPosition:new dn(y.xy,g,1)}}function so(t,e){const{opacity:s,color:n}=t,i=Jr(t,e);return s.multiply(n).multiply(i)}c([Ui(ln)],Zr.prototype,"antialiasing",void 0),c([Ui(ln)],Zr.prototype,"blur",void 0);class no extends yr{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const s=eo(this,t);return{...s,...this.maybeRunHittest(t,e,s.halfWidth)}}fragment(t){const e=so(t,this.antialiasingControls.blur);return this.getFragmentOutput(e,t)}hittest(t,e,s){const{viewMat3:n,tileMat3:i}=this.view,r=n.multiply(i),o=r.multiply(new pn(t.pos,1)),c=r.multiply(new pn(e.nextPos1,1)),a=r.multiply(new pn(e.nextPos2,1)),{distance:u,smallSymbolDistance:h,smallSymbolSizeThreshold:l}=this.hittestRequest,f=zi(s,l.multiply(.5)).multiply(u.subtract(h)),p=this.hittestRequest.position;return xi(br(p,o.xy,c.xy),br(p,o.xy,a.xy)).subtract(s).add(f)}}c([Ui(Zr)],no.prototype,"antialiasingControls",void 0),c([ji(zr)],no.prototype,"visualVariableColor",void 0),c([ji(Cr)],no.prototype,"visualVariableOpacity",void 0),c([ji(jr)],no.prototype,"visualVariableSizeMinMaxValue",void 0),c([ji(Hr)],no.prototype,"visualVariableSizeScaleStops",void 0),c([ji(Xr)],no.prototype,"visualVariableSizeStops",void 0),c([ji(Yr)],no.prototype,"visualVariableSizeUnitValue",void 0),c([l(0,Ni(qr)),l(1,Ni(wr))],no.prototype,"vertex",null),c([l(0,Ni(Kr))],no.prototype,"fragment",null);class io extends mr{}c([Wi(3,fn)],io.prototype,"offset",void 0),c([Wi(4,dn)],io.prototype,"color",void 0),c([Wi(5,fn)],io.prototype,"normal",void 0),c([Wi(6,ln)],io.prototype,"halfWidth",void 0),c([Wi(7,ln)],io.prototype,"referenceHalfWidth",void 0),c([Wi(8,fn)],io.prototype,"zoomRange",void 0);class ro extends Kr{}function oo(t,e,s){const{id:n,bitset:i}=e,r=ir(i,Ke),o=ni(r,new ln(.5)),c=eo(t,e),a=Hn(o,c.halfWidth,new ln(0)),u=Ar(t,n),h=Tr(t,n,e.color),l=Hn(o,e.color,h.multiply(u)),f=t.view.displayViewScreenMat3.multiply(new pn(e.pos.xy,1)),p=t.clip(e.id),d=new dn(f.xy,p,1),m=Hn(o,c.glPosition,d),w=s&&t.maybeRunHittest(e,s,o);return{isOutline:r,color:l,opacity:new ln(1),halfWidth:a,normal:c.normal,glPosition:m,...w}}class co extends yr{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}c([Ui(Zr)],co.prototype,"antialiasingControls",void 0),c([ji(zr)],co.prototype,"visualVariableColor",void 0),c([ji(Cr)],co.prototype,"visualVariableOpacity",void 0),c([ji(jr)],co.prototype,"visualVariableSizeMinMaxValue",void 0),c([ji(Hr)],co.prototype,"visualVariableSizeScaleStops",void 0),c([ji(Xr)],co.prototype,"visualVariableSizeStops",void 0),c([ji(Yr)],co.prototype,"visualVariableSizeUnitValue",void 0);class ao extends co{vertex(t,e){return oo(this,t,e)}fragment(t){const{color:e,isOutline:s}=t,n=ni(s,new ln(.5)),i=so(t,this.antialiasingControls.blur),r=Hn(n,i,e),o=Hn(n,new ln(1/255),new ln(0));return this.getFragmentOutput(r,t,o)}hittest(t,e,s){return Hn(s,Pr(this.hittestRequest),_r(this,t,e))}}c([l(0,Ni(io)),l(1,Ni(wr))],ao.prototype,"vertex",null),c([l(0,Ni(ro))],ao.prototype,"fragment",null);class uo extends Ir{}c([Wi(5,dn)],uo.prototype,"tlbr",void 0),c([Wi(6,ln)],uo.prototype,"inverseRasterizationScale",void 0);class ho extends gr{}function lo(t){const e=new ln(1),s=new ln(0);return new zn(e.divide(t.x),s.divide(t.y),0,En(s.divide(t.x)),e.divide(t.y),0,0,0,1)}function fo(t,e){const s=e.tlbr.xy,n=e.tlbr.zw,i=n.x.subtract(s.x),r=s.y.subtract(n.y),o=new fn(i,r).multiply(e.inverseRasterizationScale),c=o.multiply(t.view.requiredZoomFactor),a=lo(c),u=t.localTileOffset.getPatternOffsetAtTileOrigin(o).divide(c),h=new pn(e.pos,1);return{tileTextureCoord:a.multiply(h).xy.subtract(u),tlbr:e.tlbr.divide(t.mosaicInfo.size.xyxy)}}function po(t,e){const s=Mi(t.tileTextureCoord,new ln(1)),n=ki(t.tlbr.xy,t.tlbr.zw,s),i=Ci(e.texture,n);return t.color.multiply(i)}class mo extends Vr{vertex(t,e){return{...super.vertex(t,e),...fo(this,t)}}fragment(t){const e=po(t,this.mosaicInfo);return this.getFragmentOutput(e,t,new ln(0))}}c([Ui(Lr)],mo.prototype,"mosaicInfo",void 0),c([Ui(Dr)],mo.prototype,"localTileOffset",void 0),c([l(0,Ni(uo)),l(1,Ni(wr))],mo.prototype,"vertex",null),c([l(0,Ni(ho))],mo.prototype,"fragment",null);class wo extends io{}c([Wi(9,dn)],wo.prototype,"tlbr",void 0),c([Wi(10,ln)],wo.prototype,"inverseRasterizationScale",void 0);class go extends ro{}class yo extends ao{vertex(t,e){return{...oo(this,t,e),...fo(this,t)}}fragment(t){const{isOutline:e}=t,s=ni(e,new ln(.5)),n=so(t,this.antialiasingControls.blur),i=po(t,this.mosaicInfo),r=Hn(s,n,i),o=Hn(s,new ln(1/255),new ln(0));return this.getFragmentOutput(r,t,o)}}c([Ui(Lr)],yo.prototype,"mosaicInfo",void 0),c([Ui(Dr)],yo.prototype,"localTileOffset",void 0),c([l(0,Ni(wo)),l(1,Ni(wr))],yo.prototype,"vertex",null),c([l(0,Ni(go))],yo.prototype,"fragment",null);const vo=16,bo=1/vo,xo=128;class ko extends mr{}c([Wi(3,dn)],ko.prototype,"color",void 0),c([Wi(4,dn)],ko.prototype,"tlbr",void 0),c([Wi(5,ln)],ko.prototype,"angle",void 0),c([Wi(6,ln)],ko.prototype,"aux1",void 0),c([Wi(7,ln)],ko.prototype,"aux2",void 0),c([Wi(8,fn)],ko.prototype,"aux3",void 0),c([Wi(9,fn)],ko.prototype,"aux4",void 0),c([Wi(10,fn)],ko.prototype,"zoomRange",void 0);class Mo extends go{}class $o extends co{vertex(t,e){const{aux1:s,aux2:n,aux3:i,aux4:r}=t,o={...t,width:s,height:n,offset:i,scale:r.multiply(bo)},c={...t,halfWidth:s.multiply(bo),referenceHalfWidth:n.multiply(bo),offset:i.multiply(bo),normal:r.subtract(xo).multiply(bo)},a=oo(this,c),u=Er(this,o),h=ni(a.isOutline,new ln(.5));return{...a,...u,...this.maybeRunHittest(t,e,h)}}fragment(t){const{isOutline:e}=t,s=ni(e,new ln(.5)),n=so(t,this.antialiasingControls.blur),i=Nr(this,t),r=Hn(s,n,i),o=Hn(s,new ln(1/255),new ln(0));return this.getFragmentOutput(r,t,o)}hittest(t,e,s){return Hn(s,Pr(this.hittestRequest),_r(this,t,e))}}c([Ui(Lr)],$o.prototype,"mosaicInfo",void 0),c([Ui(Dr)],$o.prototype,"localTileOffset",void 0),c([l(0,Ni(ko)),l(1,Ni(wr))],$o.prototype,"vertex",null),c([l(0,Ni(Mo))],$o.prototype,"fragment",null);const Po=us.attributes,_o=gs.attributes,So={createComputedParams:t=>t,attributes:{id:Po.id,pos:Po.pos,zoomRange:Po.zoomRange,tlbr:Po.tlbr,angle:Po.angle,color:Po.color,bitset:{type:rt.UNSIGNED_BYTE,count:1,pack:t=>os(t)},aux1:{count:1,type:rt.UNSIGNED_SHORT,pack:t=>cs(t)},aux2:{count:1,type:rt.UNSIGNED_SHORT,pack:t=>as(t)},aux3:{count:2,type:rt.SHORT,pack:({offsetX:t,offsetY:e})=>[r(t),r(e)]},aux4:{count:2,type:rt.UNSIGNED_BYTE,pack:({scaleX:t,scaleY:e})=>[t*vo,e*vo]}}},zo={createComputedParams:t=>t,attributes:{id:Po.id,pos:Po.pos,zoomRange:Po.zoomRange,tlbr:Po.tlbr,angle:Po.angle,color:_o.color,bitset:{type:rt.UNSIGNED_BYTE,count:1,pack:t=>Se([[Ke,!0]])},aux1:{count:1,type:rt.UNSIGNED_SHORT,pack:t=>r(.5*t.width)*vo},aux2:{count:1,type:rt.UNSIGNED_SHORT,pack:t=>r(.5*t.referenceWidth)*vo},aux3:{count:2,type:rt.SHORT,packTessellation:({extrusionOffsetX:t,extrusionOffsetY:e})=>[t*vo,e*vo]},aux4:{count:2,type:rt.UNSIGNED_BYTE,packTessellation:({normalX:t,normalY:e})=>[t*vo+xo,e*vo+xo]}}};class Co extends ys{constructor(){super(...arguments),this.vertexSpec=zo}}class Fo extends vs{constructor(){super(...arguments),this.vertexSpec=So}_createOutlineWriter(t,e,s,n){return new Co(t,e,s,n)}_write(t,e,s){const n=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(n);if(!i)return;const r=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,r),this._writeGeometry(t,e,i),this._lineMeshWriter.writeLineVertices(t,H.fromOptimizedCIM(i,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,s){super.ensurePacked(t,e,s),this._lineMeshWriter.ensurePacked(t,e,s)}enqueueRequest(t,e,s){super.enqueueRequest(t,e,s),this._lineMeshWriter.enqueueRequest(t,e,s)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const Oo={createComputedParams:t=>t,attributes:{...Ve.attributes,...ws.attributes}},To={createComputedParams:t=>t,attributes:{...Ve.attributes,...gs.attributes}};class Ao extends ys{constructor(){super(...arguments),this.vertexSpec=To}}class Ro extends vs{constructor(){super(...arguments),this.vertexSpec=Oo}_createOutlineWriter(t,e,s,n){return new Ao(t,e,s,n)}_write(t,e,s){const n=s?.asOptimized()??e.readGeometryForDisplay(),i=this._clip(n);if(!i)return;const r=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,r),this._writeGeometry(t,e,i),this._lineMeshWriter.writeLineVertices(t,H.fromOptimizedCIM(i,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,s){super.ensurePacked(t,e,s),this._lineMeshWriter.ensurePacked(t,e,s)}enqueueRequest(t,e,s){super.enqueueRequest(t,e,s),this._lineMeshWriter.enqueueRequest(t,e,s)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const Io={createComputedParams:t=>t,attributes:{pos:{type:rt.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:rt.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:rt.UNSIGNED_BYTE,count:1},offset:{type:rt.BYTE,count:2,packAlternating:{count:4,pack:()=>[[-1,-1],[1,-1],[-1,1],[1,1]]}}}};class Vo extends we{constructor(){super(...arguments),this.vertexSpec=Io}_write(t,e){t.recordStart(this.instanceId,this.attributeLayout);const s=e.getDisplayId();if("esriGeometryPoint"===e.geometryType){const n=e.readXForDisplay(),i=e.readYForDisplay();this._writeQuad(t,s,n,i)}else if("esriGeometryMultipoint"===e.geometryType){const n=e.readGeometryForDisplay();n?.forEachVertex(((e,n)=>{e>=0&&e<=512&&n>=0&&n<=512&&this._writeQuad(t,s,e,n)}))}t.recordEnd()}_writeQuad(t,e,s,n){const i=t.vertexCount();this._writeVertex(t,e,s,n),t.indexWrite(i+0),t.indexWrite(i+1),t.indexWrite(i+2),t.indexWrite(i+1),t.indexWrite(i+3),t.indexWrite(i+2)}}const Do=8388607,Lo=8388608,Go=t=>t&Do;function Bo(t,e){return((e?Lo:0)|t)>>>0}function Wo(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t}function Eo(t,e){return Math.sqrt(t*t+e*e)}function No(t){const e=Eo(t[0],t[1]);t[0]/=e,t[1]/=e}function Uo(t,e){return Eo(t[0]-e[0],t[1]-e[1])}function jo(t,e){return t[e+1]}function Ho(t){return t.length-1}function Xo(t){let e=0;for(let s=0;s<Ho(t);s++)e+=Yo(t,s);return e}function Yo(t,e,s=1){let[n,i]=jo(t,e);return[n,i]=[Math.round(n),Math.round(i)],Math.sqrt(n*n+i*i)*s}class qo{constructor(t,e,s,n,i){this._segments=t,this._index=e,this._distance=s,this._xStart=n,this._yStart=i,this._done=!1}static create(t){return new qo(t,0,0,t[0][0],t[0][1])}clone(){return new qo(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(0===this._distance||1===t._distance)||t._index===this._index+1&&(1===this._distance||0===t._distance)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let s=Math.acos(e);return t>0&&(s=2*Math.PI-s),s}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Ho(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const s=this.backwardLength;if(t<=s)return this._distance=(s-t)/this.length,this;let n=this.backwardLength;for(;this.prev();){if(n+this.length>t)return this._seekBackwards(t-n);n+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let s=this.remainingLength;for(;this.next();){if(s+this.length>t)return this.seek(t-s,e);s+=this.length}return this._distance=1,e?this:null}}function Ko(t,e,s,n=!0){const i=Xo(t),r=qo.create(t),o=i/2;if(!n)return r.seek(o),void(Math.abs(r.x)<mt&&Math.abs(r.y)<mt&&s(r.clone(),0,o+0*e,i));const c=Math.max((i-e)/2,0),a=Math.floor(c/e),u=o-a*e;r.seek(u);for(let t=-a;t<=a;t++)Math.abs(r.x)<mt&&Math.abs(r.y)<mt&&s(r.clone(),t,o+t*e,i),r.seek(e)}function Zo(t,e){const s=e;for(let e=0;e<t.length;e++){let n=t[e];Qo(n,s);const i=[];i.push(n[0]);for(let t=1;t<n.length;t++){const[e,s]=n[t-1],[r,o]=n[t],c=r-e,a=o-s;i.push([c,a])}t[e]=i,n=i}return t}function Qo(t,e){const s=1e-6;if(e<=0)return;const n=t.length;if(n<3)return;const i=[];let r=0;i.push(0);for(let e=1;e<n;e++)r+=Uo(t[e],t[e-1]),i.push(r);e=Math.min(e,.2*r);const o=[];o.push(t[0][0]),o.push(t[0][1]);const c=t[n-1][0],a=t[n-1][1],u=Wo([0,0],t[0],t[1]);No(u),t[0][0]+=e*u[0],t[0][1]+=e*u[1],Wo(u,t[n-1],t[n-2]),No(u),t[n-1][0]+=e*u[0],t[n-1][1]+=e*u[1];for(let t=1;t<n;t++)i[t]+=e;i[n-1]+=e;const h=.5*e;for(let r=1;r<n-1;r++){let c=0,a=0,u=0;for(let n=r-1;n>=0&&!(i[n+1]<i[r]-h);n--){const o=h+i[n+1]-i[r],l=i[n+1]-i[n],f=i[r]-i[n]<h?1:o/l;if(Math.abs(f)<s)break;const p=f*f,d=f*o-.5*p*l,m=f*l/e,w=t[n+1],g=t[n][0]-w[0],y=t[n][1]-w[1];c+=m/d*(w[0]*f*o+.5*p*(o*g-l*w[0])-p*f*l*g/3),a+=m/d*(w[1]*f*o+.5*p*(o*y-l*w[1])-p*f*l*y/3),u+=m}for(let o=r+1;o<n&&!(i[o-1]>i[r]+h);o++){const n=h-i[o-1]+i[r],l=i[o]-i[o-1],f=i[o]-i[r]<h?1:n/l;if(Math.abs(f)<s)break;const p=f*f,d=f*n-.5*p*l,m=f*l/e,w=t[o-1],g=t[o][0]-w[0],y=t[o][1]-w[1];c+=m/d*(w[0]*f*n+.5*p*(n*g-l*w[0])-p*f*l*g/3),a+=m/d*(w[1]*f*n+.5*p*(n*y-l*w[1])-p*f*l*y/3),u+=m}o.push(c/u),o.push(a/u)}o.push(c),o.push(a);for(let e=0,s=0;e<n;e++)t[e][0]=o[s++],t[e][1]=o[s++]}class Jo{static getPlacement(t,e,s,n,i,r){const o=X(s);if(!o)return null;-1===e&&t.invertY();return o.execute(t,s,n,i,r)}}const tc=96;class ec{constructor(t){const{offsetX:e,offsetY:s,postAngle:n,fontSize:i,scaleFactor:r,transforms:o}=t;if(this.offsetX=e,this.offsetY=s,this.postAngle=n,this.fontSize=Math.min(i,tc),this.transforms=o,o&&o.infos.length>1){const t=f(i,n,!1,e,s,o);this.fontSize=Math.min(t.size,tc),this.postAngle=t.rotation,this.offsetX=t.offsetX,this.offsetY=t.offsetY}r&&(this.fontSize*=r,this.offsetX*=r,this.offsetY*=r)}}const sc=28,nc=[4,4],ic=[16,4],rc={topLeft:ic,topRight:ic,bottomLeft:ic,bottomRight:ic},oc=[4,2],cc=[4,6],ac={topLeft:oc,topRight:oc,bottomLeft:cc,bottomRight:cc},uc={topLeft:oc,topRight:cc,bottomLeft:oc,bottomRight:cc},hc={topLeft:cc,topRight:cc,bottomLeft:nc,bottomRight:nc},lc={topLeft:nc,topRight:nc,bottomLeft:cc,bottomRight:cc},fc={topLeft:cc,topRight:nc,bottomLeft:cc,bottomRight:nc},pc={topLeft:nc,topRight:cc,bottomLeft:nc,bottomRight:cc},dc={createComputedParams:t=>t,attributes:{pos:{type:rt.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:rt.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:rt.UNSIGNED_BYTE,count:1,packTessellation:({isBackground:t,mapAligned:e})=>Se([[ss,t],[ns,!!e]])},zoomRange:{type:rt.UNSIGNED_SHORT,count:2,packPrecisionFactor:I,packTessellation:({minZoom:t,maxZoom:e})=>[t||0,e||sc]},offset:{type:rt.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:({offsets:t})=>{const{bottomLeft:e,bottomRight:s,topLeft:n,topRight:i}=t;return[n,i,e,s]}}},textureUV:{type:rt.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:({texcoords:t})=>{const{bottomLeft:e,bottomRight:s,topLeft:n,topRight:i}=t;return[n,i,e,s]}}},color:{type:rt.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:({color:t})=>t},fontSize:{type:rt.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:({fontSize:t})=>r(t)},referenceSize:{type:rt.UNSIGNED_BYTE,count:1,packPrecisionFactor:4,packTessellation:({fontSize:t},{referenceSize:e})=>r(e??t)},haloColor:{type:rt.UNSIGNED_BYTE,count:4,normalized:!0,pack:({haloColor:t})=>ze(t)},haloFontSize:{type:rt.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,pack:({haloFontSize:t})=>r(t)},clipAngle:{type:rt.UNSIGNED_BYTE,count:1,packTessellation:({clipAngle:t})=>wc(t||0)},referenceSymbol:{type:rt.BYTE,count:4,packPrecisionFactor:1,packTessellation:(t,e)=>{if(!t.referenceBounds)return[0,0,0,0];const s=q(e.horizontalAlignment),n=K(e.verticalAlignment),{offsetX:i,offsetY:o,size:c}=t.referenceBounds;return[r(i),-r(o),r(c),s+1<<2|n+1]}}}};class mc extends we{constructor(){super(...arguments),this.vertexSpec=dc,this._textMeshParamsPropsInitialized=!1}ensurePacked(t,e,s){super.ensurePacked(t,e,s),this._textMeshParamsPropsInitialized&&!this._evaluator.hasDynamicProperties||(this._textMeshTransformProps=new ec(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0)}_write(t,e,s){const n=this._getShaping();if(!n)return;const i=e.getDisplayId();if(null!=this.evaluatedMeshParams.placement)return this._writePlacedTextMarkers(t,e,n,s);if(s&&s.nextPath())return s.nextPoint(),this._writeGlyphs(t,i,s.x,s.y,n,0);if("esriGeometryPolygon"===e.geometryType){const s=e.readCentroidForDisplay();if(!s)return;const[r,o]=s.coords;return this._writeGlyphs(t,i,r,o,n,0)}if("esriGeometryMultipoint"===e.geometryType){const s=e.readGeometryForDisplay();return void s?.forEachVertex(((e,s)=>this._writeGlyphs(t,i,e,s,n,0)))}const r=e.readXForDisplay(),o=e.readYForDisplay();return this._writeGlyphs(t,i,r,o,n,0)}_writePlacedTextMarkers(t,e,s,n){const i=n??H.fromFeatureSetReaderCIM(e);if(!i)return;const o=-1,c=Jo.getPlacement(i,o,this.evaluatedMeshParams.placement,r(1),t.id,ue());if(!c)return;const a=e.getDisplayId();let u=c.next();for(;null!=u;){const e=u.tx,n=-u.ty,i=-u.getAngle();this._writeGlyphs(t,a,e,n,s,i),u=c.next()}}_getShaping(){const t=this._textMeshTransformProps,e=this.evaluatedMeshParams;if(!e.glyphs?.glyphs.length)return null;const s=Math.round(r(t.fontSize)),n=r(t.offsetX),i=r(t.offsetY),o=p(r(e.lineWidth),32,512),c=W*p(e.lineHeightRatio,.25,4);return Y(e.glyphs,{scale:s/B,angle:t.postAngle,xOffset:n,yOffset:i,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,maxLineWidth:o,lineHeight:c,decoration:e.decoration,borderLineSizePx:r(e.boxBorderLineSize),hasBackground:!!e.boxBackgroundColor,useCIMAngleBehavior:e.useCIMAngleBehavior})}_writeGlyphs(t,e,s,n,i,o,c,a){const u=this.evaluatedMeshParams,h=this._textMeshTransformProps,l=h.fontSize,f=r(h.offsetX),p=r(h.offsetY),[d,m]=Pe(u.scaleInfo,this.getTileInfo());0!==o&&i.setRotation(o);const w=i.bounds,g=s+w.x+f,y=n+w.y-p,v=2*(u.minPixelBuffer?u.minPixelBuffer/l:1),b=Math.max(w.width,w.height)*v;i.textBox&&(t.recordStart(this.instanceId,this.attributeLayout,i.glyphs[0].textureBinding),t.recordBounds(g,y,b,b),this._writeTextBox(t,e,s,n,i.textBox,c,a),t.recordEnd());for(const r of i.glyphs){t.recordStart(this.instanceId,this.attributeLayout,r.textureBinding),t.recordBounds(g,y,b,b);const{texcoords:i,offsets:o}=r;this._writeQuad(t,e,s,n,{texcoords:i,offsets:o,fontSize:l,color:ze(u.color),isBackground:!1,referenceBounds:c,minZoom:d,maxZoom:m,...a}),t.recordEnd()}0!==o&&i.setRotation(-o)}_writeTextBox(t,e,s,n,i,r,o){const c=this.evaluatedMeshParams,{fontSize:a}=this._textMeshTransformProps,{boxBackgroundColor:u,boxBorderLineColor:h}=c,l={isBackground:!0,fontSize:a,referenceBounds:r,...o};u&&(this._writeQuad(t,e,s,n,{texcoords:rc,offsets:i.main,color:ze(u),...l}),h||(this._writeQuad(t,e,s,n,{texcoords:hc,offsets:i.top,color:ze(u),...l}),this._writeQuad(t,e,s,n,{texcoords:lc,offsets:i.bot,color:ze(u),...l}),this._writeQuad(t,e,s,n,{texcoords:fc,offsets:i.left,color:ze(u),...l}),this._writeQuad(t,e,s,n,{texcoords:pc,offsets:i.right,color:ze(u),...l}))),h&&(this._writeQuad(t,e,s,n,{texcoords:ac,offsets:i.top,color:ze(h),...l}),this._writeQuad(t,e,s,n,{texcoords:ac,offsets:i.bot,color:ze(h),...l}),this._writeQuad(t,e,s,n,{texcoords:uc,offsets:i.left,color:ze(h),...l}),this._writeQuad(t,e,s,n,{texcoords:uc,offsets:i.right,color:ze(h),...l}))}_writeQuad(t,e,s,n,i){const r=t.vertexCount();this._writeVertex(t,e,s,n,i),t.indexWrite(r+0),t.indexWrite(r+1),t.indexWrite(r+2),t.indexWrite(r+1),t.indexWrite(r+3),t.indexWrite(r+2)}}const wc=t=>Math.round(t*(254/360));const gc=1,yc=0,vc=128,bc=w((t=>{let e=0;if(0===t)return 1/0;for(;!(t%2);)e++,t/=2;return e}));class xc extends mc{constructor(){super(...arguments),this._zoomLevel=0}_write(t,e,s,n){if(this._zoomLevel=n||0,null!=s)throw new Error("InternalError: EffectGeometry not support for LabelMeshWriter");switch(e.geometryType){case"esriGeometryPoint":{const s=e.readXForDisplay(),n=e.readYForDisplay();return this._writePoint(t,s,n,e)}case"esriGeometryEnvelope":case"esriGeometryPolygon":case"esriGeometryMultipoint":{const s=e.readCentroidForDisplay();if(!s)return;const[n,i]=s.coords;return this._writePoint(t,n,i,e)}case"esriGeometryPolyline":{const s=e.readLegacyGeometryForDisplay();this._writeLines(t,e,s)}}}_writePoint(t,e,s,n){const i=this._getShaping();if(!i)return;let r=this._getPointReferenceBounds();r||(r={offsetX:0,offsetY:0,size:0});const o=i.boundsT,c=Z(this.evaluatedMeshParams.horizontalAlignment),a=Q(this.evaluatedMeshParams.verticalAlignment),u=this.evaluatedMeshParams.scaleInfo?.maxScale??0,h=this.evaluatedMeshParams.scaleInfo?.minScale??0,l=Go(n.getDisplayId());t.metricStart(new it(l,e,s,c,a,u,h,r)),t.metricBoxWrite(o),this._writeGlyphs(t,n.getDisplayId(),e,s,i,0,r),t.metricEnd()}_getPointReferenceBounds(){if(!this._references)return null;for(const t of this._references){const e=t.getBoundsInfo();if(e)return e}return null}_writeLines(t,e,s){const{repeatLabel:n,scaleInfo:i}=this.evaluatedMeshParams,r=this.evaluatedMeshParams.repeatLabelDistance||128,o=this._getShaping();if(!o)return;this._current={out:t,id:e.getDisplayId(),shaping:o,zoomRange:Pe(i,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0}};const c=Zo(s.paths,o.bounds.width),a=this._placeSubdivGlyphs.bind(this),u=(o.bounds.width+r)/(1<<gc);for(const t of c)Ko(t,u,a,!!n)}_placeSubdivGlyphs(t,e,s,n){const{allowOverrun:i,labelPosition:r,repeatLabelDistance:o}=this.evaluatedMeshParams,c=this._current.zoomRange[0],a=bc(e),u=this._current.shaping.bounds.width/(1<<gc),h=Math.sqrt(o||vc)/(1<<gc),l=Math.min(s,n-s),f=this._current.shaping.isMultiline?sc:Math.log2(l/(h+u/2)),p=0===e?f:Math.min(a,f),d=Math.max(c,this._zoomLevel+gc-p),m=this._zoomLevel-d,w=this._current.shaping.bounds.width/2*2**m;this._current.shaping.isMultiline?0===e&&this._placeStraight(t,d):i&&m<0?this._placeStraightAlong(t,c):"parallel"===r?this._placeStraightAlong(t,d):"curved"===r&&this._placeCurved(t,d,w)}_placeStraight(t,e){const{out:s,id:n,shaping:i,referenceBounds:r}=this._current,{x:o,y:c}=t,a=Go(n),u=this.evaluatedMeshParams.scaleInfo?.maxScale??0,h=this.evaluatedMeshParams.scaleInfo?.minScale??0;s.metricStart(new it(a,t.x,t.y,0,0,u,h,null)),s.metricBoxWrite(i.boundsT);const l=t.angle*(180/Math.PI)%360,f=(t.angle*(180/Math.PI)+180)%360;this._writeGlyphs(s,n,o,c,i,0,r,{clipAngle:l,mapAligned:!0,isLineLabel:!0,minZoom:e}),this._writeGlyphs(s,n,o,c,i,0,r,{clipAngle:f,mapAligned:!0,isLineLabel:!0,minZoom:e}),s.metricEnd()}_placeCurved(t,e,s){const{out:n,id:i}=this._current,r=t.clone(),o=t.angle*(180/Math.PI)%360,c=(t.angle*(180/Math.PI)+180)%360,a=Go(i),u=this.evaluatedMeshParams.scaleInfo?.maxScale??0,h=this.evaluatedMeshParams.scaleInfo?.minScale??0;n.metricStart(new it(a,t.x,t.y,0,0,u,h,null)),this._placeFirst(r,e,1,o),this._placeBack(t,r,e,s,1,o),this._placeForward(t,r,e,s,1,o),this._placeFirst(r,e,0,c),this._placeBack(t,r,e,s,0,c),this._placeForward(t,r,e,s,0,c),n.metricEnd()}_placeStraightAlong(t,e){const{out:s,id:n,shaping:i,zoomRange:r,referenceBounds:o}=this._current,{boxBorderLineColor:c,boxBackgroundColor:a}=this.evaluatedMeshParams,u=t.clone(),h=t.angle*(180/Math.PI)%360,l=(t.angle*(180/Math.PI)+180)%360;if(i.glyphs.length>0&&(c||a)){const c=Math.max(e,r[0],0),a=Math.min(sc,r[1]),u=d(m(),-t.angle),[f,p]=i.shapeBackground(u),w={minZoom:c,maxZoom:a,clipAngle:h,mapAligned:!0,isLineLabel:!0};s.recordStart(this.instanceId,this.attributeLayout,i.glyphs[0].textureBinding),this._writeTextBox(s,n,t.x,t.y,p,o,w),s.recordEnd(),w.clipAngle=l,s.recordStart(this.instanceId,this.attributeLayout,i.glyphs[0].textureBinding),this._writeTextBox(s,n,t.x,t.y,p,o,w),s.recordEnd()}const f=Go(n),p=this.evaluatedMeshParams.scaleInfo?.maxScale??0,w=this.evaluatedMeshParams.scaleInfo?.minScale??0;s.metricStart(new it(f,t.x,t.y,0,0,p,w,null)),this._placeFirst(u,e,1,h,!0),this._placeFirst(u,e,0,l,!0),s.metricEnd()}_placeBack(t,e,s,n,i,r){const o=t.clone();let c=t.backwardLength+yc;for(;o.prev()&&!(c>=n);)this._placeOnSegment(o,e,c,s,-1,i,r),c+=o.length+yc}_placeForward(t,e,s,n,i,r){const o=t.clone();let c=t.remainingLength+yc;for(;o.next()&&!(c>=n);)this._placeOnSegment(o,e,c,s,1,i,r),c+=o.length+yc}_placeFirst(t,e,s,n,i=!1){const r=t,{out:o,id:c,shaping:a,zoomRange:u,referenceBounds:h}=this._current,l=a.glyphs;for(const f of l){const l=f.x>a.bounds.x?s:1-s,p=l*t.remainingLength+(1-l)*t.backwardLength,d=Math.abs(f.x+f.width/2-a.bounds.x),m=Math.max(0,this._zoomLevel+Math.log2(d/(p+yc))),w=Math.max(e,i?0:m);f.maxZoom=Math.min(u[1],sc),f.angle=t.angle+(1-s)*Math.PI,f.minZoom=Math.max(u[0],w),this._writeLineGlyph(o,c,r.x,r.y,a.bounds,f,n,h,!0),s&&this._isVisible(f.minZoom,f.maxZoom)&&o.metricBoxWrite(f.bounds)}}_placeOnSegment(t,e,s,n,i,r,o){const{out:c,id:a,shaping:u,referenceBounds:h}=this._current,l=u.glyphs,f=t.dx/t.length,p=t.dy/t.length,d={x:t.x+s*-i*f,y:t.y+s*-i*p};for(const f of l){const l=f.x>u.bounds.x?r:1-r;if(!(l&&1===i||!l&&-1===i))continue;const p=Math.abs(f.x+f.width/2-u.bounds.x),m=Math.max(0,this._zoomLevel+Math.log2(p/s)-.1),w=Math.max(n,this._zoomLevel+Math.log2(p/(s+t.length+yc)));if(0!==m&&(f.angle=t.angle+(1-r)*Math.PI,f.minZoom=w,f.maxZoom=m,this._writeLineGlyph(c,a,d.x,d.y,u.bounds,f,o,h,!0),r&&this._isVisible(f.minZoom,f.maxZoom))){const s=f.bounds,n=t.x-e.x,i=t.y-e.y,r=new dt(s.center[0]+n,s.center[1]+i,s.width,s.height);c.metricBoxWrite(r)}}}_writeLineGlyph(t,e,s,n,i,r,o,c,a){const u=s+i.x,h=n+i.y,l=2*(this.evaluatedMeshParams.minPixelBuffer?this.evaluatedMeshParams.minPixelBuffer/this._textMeshTransformProps.fontSize:1),f=Math.max(i.width,i.height)*l;t.recordStart(this.instanceId,this.attributeLayout,r.textureBinding),t.recordBounds(u,h,f,f);const{texcoords:p,offsets:d}=r,m=this._textMeshTransformProps.fontSize;this._writeQuad(t,e,s,n,{texcoords:p,offsets:d,fontSize:m,color:ze(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:c,minZoom:Math.max(this._current.zoomRange[0],r.minZoom),maxZoom:Math.min(this._current.zoomRange[1],r.maxZoom),clipAngle:o,mapAligned:a,isLineLabel:!0}),t.recordEnd()}_isVisible(t,e){const s=this._zoomLevel;return t<=s&&s<=e}}const kc={createComputedParams:t=>t,attributes:{...fs.attributes,bitset:{type:rt.UNSIGNED_BYTE,count:1,pack:({shouldSampleAlphaOnly:t,shouldScaleDash:e,isSDF:s})=>Se([[qe,t],[ts,e],[es,s]])},tlbr:{type:rt.UNSIGNED_SHORT,count:4,pack:({sprite:t})=>{const{rect:e,width:s,height:n}=t,i=e.x+V,r=e.y+V;return[i,r,i+s,r+n]}},accumulatedDistance:{type:rt.UNSIGNED_SHORT,count:1,packTessellation:({distance:t})=>t},segmentDirection:{type:rt.BYTE,count:2,packPrecisionFactor:16,packTessellation:({directionX:t,directionY:e})=>[t,e]}}};class Mc extends ms{constructor(t,e,s,n){super(t,e,s,n),this.vertexSpec=kc,this._tessellationOptions.textured=!0}_write(t,e,s){const n=s??H.fromFeatureSetReaderCIM(e);if(!n)return;const{sprite:i}=this.evaluatedMeshParams;this._writeGeometry(t,e,n,i?.textureBinding)}}class $c{static from(t){return"width"in t?this.fromSimpleMeshParams(t):this.fromComplexMeshParams(t)}static fromSimpleMeshParams(t){const e=new $c(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects),{type:s,width:n,height:i,angle:o,alignment:c,outlineSize:a,referenceSize:u,sprite:h,overrideOutlineColor:l}=t;e.rawWidth=r(n),e.rawHeight=r(i),e.angle=o,e.alignment=c,e.outlineSize=r(a),e.referenceSize=r(u),e.overrideOutlineColor=l,e.offsetX=r(t.offsetX),e.offsetY=r(t.offsetY),"simple"!==s||h.sdf||(e.rawWidth=h.width,e.rawHeight=h.height);const f=2;return e.sizeRatio=h.sdf?f:1,e._computeSize(t,!1),e}static fromComplexMeshParams(t){const e=new $c(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects);let{alignment:s,transforms:n,size:i,scaleX:o,anchorX:c,anchorY:a,angle:u,colorLocked:h,frameHeight:l,widthRatio:p,offsetX:d,offsetY:m,outlineSize:w,referenceSize:g,scaleFactor:y,sizeRatio:v,isAbsoluteAnchorPoint:b,rotateClockwise:x,scaleSymbolsProportionally:k,sprite:M}=t;if(n&&n.infos.length>0){const t=f(i,u,x,d,m,n);i=t.size,u=t.rotation,d=t.offsetX,m=t.offsetY,x=!1}y&&(i*=y,d*=y,m*=y);const $=o*(M.width/M.height);e.alignment=s,e.rawHeight=r(i),e.rawWidth=e.rawHeight*$,e.referenceSize=r(g),e.sizeRatio=v,e.angle=u,e.rotateClockwise=x,e.anchorX=c,e.anchorY=a,e.offsetX=r(d),e.offsetY=r(m),b&&i&&(M.sdf?e.anchorX=c/(i*p):e.anchorX=c/(i*$),e.anchorY=a/i);const P=k&&l?i/l:1;return e.outlineSize=0===w||isNaN(w)?0:r(w)*P,e.scaleSymbolsProportionally=k,e.colorLocked=h,e._computeSize(t,!0),e}constructor(t,e,s,n,i,r,o){this.sprite=t,this.color=e,this.outlineColor=s,this.minPixelBuffer=n,this.placement=i,this.scaleInfo=r,this.effects=o,this.rawWidth=0,this.rawHeight=0,this.angle=0,this.outlineSize=0,this.referenceSize=0,this.sizeRatio=1,this.alignment=ht.SCREEN,this.scaleSymbolsProportionally=!1,this.overrideOutlineColor=!1,this.colorLocked=!1,this.anchorX=0,this.anchorY=0,this.computedWidth=0,this.computedHeight=0,this.texXmin=0,this.texYmin=0,this.texXmax=0,this.texYmax=0,this.offsetX=0,this.offsetY=0,this.rotateClockwise=!0}get boundsInfo(){return{size:Math.max(this.computedHeight,this.computedWidth),offsetX:this.offsetX,offsetY:this.offsetY}}_computeSize(t,e){const{sprite:s,hasSizeVV:n}=t,i=!!s.sdf,{rawWidth:r,rawHeight:o,sizeRatio:c,outlineSize:a}=this,u=r*c,h=o*c;if(i&&!n){const t=e&&r>o?u:r,s=o,n=a+2*1;this.computedWidth=Math.min(t+n,u),this.computedHeight=Math.min(s+n,h)}else this.computedWidth=u,this.computedHeight=h;const l=i?E/Math.max(u,h):1,f=.5*(u-this.computedWidth)*l,p=.5*(h-this.computedHeight)*l,d=s.rect.x+V+f,m=s.rect.y+V+p,w=d+s.width-2*f,g=m+s.height-2*p;this.texXmin=Math.floor(d),this.texYmin=Math.floor(m),this.texXmax=Math.ceil(w),this.texYmax=Math.ceil(g),this.computedWidth*=(this.texXmax-this.texXmin)/(w-d),this.computedHeight*=(this.texYmax-this.texYmin)/(g-m),this.anchorX*=u/this.computedWidth,this.anchorY*=h/this.computedHeight}}const Pc={bitset:{isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4}};const _c=3.14159265359/180,Sc=128/Math.PI;function zc(t,e){return t%=e,Math.abs(t>=0?t:t+e)}function Cc(t){return zc(t*Sc,256)}function Fc(t,e,s,n,i=!1){const r=m(),o=i?1:-1;return t?d(r,o*_c*t):g(r),(e||s)&&y(r,r,[e,-s]),n&&v(r,r,o*_c*-n),r}const Oc={createComputedParams:t=>$c.from(t),attributes:{pos:{type:rt.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:rt.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:rt.UNSIGNED_BYTE,count:1,pack:({sprite:t,alignment:e,scaleSymbolsProportionally:s,overrideOutlineColor:n,colorLocked:i})=>{let r=0;return t.sdf&&(r|=_e(Pc.bitset.isSDF)),e===ht.MAP&&(r|=_e(Pc.bitset.isMapAligned)),s&&(r|=_e(Pc.bitset.scaleSymbolsProportionally)),n&&(r|=_e(Pc.bitset.overrideOutlineColor)),i&&(r|=_e(Pc.bitset.colorLocked)),r}},zoomRange:{type:rt.SHORT,count:2,packPrecisionFactor:I,pack:({scaleInfo:t},{tileInfo:e})=>Pe(t,e)},offset:{type:rt.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({angle:t,computedWidth:e,computedHeight:s,anchorX:n,anchorY:i,offsetX:r,offsetY:o,rotateClockwise:c})=>{const a=Fc(0,r,o,-t,c),u=-(.5+n)*e,h=-(.5-i)*s,l=[u,h],f=[u+e,h],p=[u,h+s],d=[u+e,h+s];return b(l,l,a),b(f,f,a),b(p,p,a),b(d,d,a),[l,f,p,d]}}},textureUV:{type:rt.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({texXmax:t,texXmin:e,texYmax:s,texYmin:n})=>[[e,n],[t,n],[e,s],[t,s]]}},color:{type:rt.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>ze(t)},outlineColor:{type:rt.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:t})=>ze(t)},sizing:{type:rt.UNSIGNED_BYTE,count:4,pack:({rawWidth:t,rawHeight:e,outlineSize:s,referenceSize:n})=>{const i=Math.max(t,e);return[Oe(i,128),Oe(s,128),Oe(n,128),0]}},placementAngle:{type:rt.UNSIGNED_BYTE,count:1,packTessellation:({placementAngle:t})=>Cc(t)},sizeRatio:{type:rt.UNSIGNED_SHORT,count:1,packPrecisionFactor:64,pack:({sizeRatio:t})=>t}}};class Tc extends we{constructor(){super(...arguments),this.vertexSpec=Oc}getBoundsInfo(){return this.evaluatedMeshParams.boundsInfo}_write(t,e,s){const n=this.evaluatedMeshParams.sprite?.textureBinding,i=e.getDisplayId();t.recordStart(this.instanceId,this.attributeLayout,n);const r=this.evaluatedMeshParams.minPixelBuffer,o=Math.max(this.evaluatedMeshParams.computedWidth,r),c=Math.max(this.evaluatedMeshParams.computedHeight,r),a=this.evaluatedMeshParams.offsetX,u=-this.evaluatedMeshParams.offsetY;if(null!=this.evaluatedMeshParams.placement)this._writePlacedMarkers(t,e,s,o,c);else if(s&&s.nextPath()){s.nextPoint();const e=s.x,n=s.y;t.recordBounds(e+a,n+u,o,c),this._writeQuad(t,i,e,n)}else if("esriGeometryPolygon"===e.geometryType){const s=e.readCentroidForDisplay();if(!s)return;const[n,r]=s.coords;t.recordBounds(n+a,r+u,o,c),this._writeQuad(t,i,n,r)}else if("esriGeometryPoint"===e.geometryType){const s=e.readXForDisplay(),n=e.readYForDisplay();t.recordBounds(s+a,n+u,o,c),this._writeQuad(t,i,s,n)}else{const s=e.readGeometryForDisplay();s?.forEachVertex(((e,s)=>{t.recordBounds(e+a,s+u,o,c),Math.abs(e)>mt||Math.abs(s)>mt||this._writeQuad(t,i,e,s)}))}t.recordEnd()}_writePlacedMarkers(t,e,s,n,i){const o=s??H.fromFeatureSetReaderCIM(e)?.clone();if(!o)return;const c=-1,a=Jo.getPlacement(o,c,this.evaluatedMeshParams.placement,r(1),t.id,ue());if(!a)return;const u=e.getDisplayId();let h=a.next();const l=this.evaluatedMeshParams.offsetX,f=-this.evaluatedMeshParams.offsetY;for(;null!=h;){const e=h.tx,s=-h.ty;if(Math.abs(e)>mt||Math.abs(s)>mt){h=a.next();continue}const r=-h.getAngle();t.recordBounds(e+l,s+f,n,i),this._writeQuad(t,u,e,s,r),h=a.next()}}_writeQuad(t,e,s,n,i){const r=t.vertexCount(),o=null==i?null:{placementAngle:i};this._writeVertex(t,e,s,n,o),t.indexWrite(r+0),t.indexWrite(r+1),t.indexWrite(r+2),t.indexWrite(r+1),t.indexWrite(r+3),t.indexWrite(r+2)}}const Ac={createComputedParams:t=>t,attributes:{pos:{type:rt.SHORT,count:2,packPrecisionFactor:10,pack:"position"},id:{type:rt.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:rt.UNSIGNED_BYTE,count:1,pack:t=>0},offset:{type:rt.SHORT,count:2,packPrecisionFactor:16,packAlternating:{count:4,pack:({size:t})=>{const e=r(t),s=-e/2,n=-e/2;return[[s,n],[s+e,n],[s,n+e],[s+e,n+e]]}}},texCoords:{type:rt.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:()=>[[0,1],[1,1],[0,0],[1,0]]}},size:{type:rt.UNSIGNED_BYTE,count:2,pack:({size:t})=>[t,t]},referenceSize:{type:rt.UNSIGNED_BYTE,count:1,pack:({size:t})=>r(t)},zoomRange:{type:rt.UNSIGNED_BYTE,count:2,pack:({scaleInfo:t},{tileInfo:e})=>Pe(t,e)}}};class Rc extends we{constructor(){super(...arguments),this.vertexSpec=Ac}_write(t,e){const s=e.getDisplayId(),n=this.evaluatedMeshParams.minPixelBuffer,i=Math.max(r(this.evaluatedMeshParams.size),n);let o,c;if("esriGeometryPoint"===e.geometryType)o=e.readXForDisplay(),c=e.readYForDisplay();else{const t=e.readCentroidForDisplay();if(!t)return;o=t?.coords[0],c=t?.coords[1]}t.recordStart(this.instanceId,this.attributeLayout),t.recordBounds(o,c,i,i);const a=t.vertexCount();this._writeVertex(t,s,o,c),t.indexWrite(a+0),t.indexWrite(a+1),t.indexWrite(a+2),t.indexWrite(a+1),t.indexWrite(a+3),t.indexWrite(a+2),t.recordEnd()}}const Ic=Vc({FillMeshWriter:Ie,DotDensityMeshWriter:xe,ComplexFillMeshWriter:hs,PatternFillMeshWriter:De,OutlineFillMeshWriter:vs,PatternOutlineFillMeshWriter:Ro,ComplexOutlineFillMeshWriter:Fo,MarkerMeshWriter:Tc,PieChartMeshWriter:Rc,TextMeshWriter:mc,LineMeshWriter:ms,TexturedLineMeshWriter:Mc,HeatmapMeshWriter:Vo,LabelMeshWriter:xc});function Vc(t){const e={};for(const s in t){const n={name:s,constructor:t[s]};e[s]=n}return e}let Dc=class extends M{constructor(t){super(t),this.debugName="",this._updatingHandles=new $,this._idToUpdatingState=new P}get updating(){const t=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some((t=>t));if(e("esri-2d-log-updating")){const e=Array.from(this._idToUpdatingState.entries()).map((([t,e])=>`-> ${t}: ${e}`)).join("\n");console.log(`${this.debugName}: Updating: ${t}\n-> Handles: ${this._updatingHandles.updating}\n${e}`)}return t}addUpdateTracking(t,e){const s=_((()=>e.updating),(e=>this._idToUpdatingState.set(t,e)),{sync:!0});this.addHandles(s)}addPromise(t){return this._updatingHandles.addPromise(t)}};c([x({constructOnly:!0})],Dc.prototype,"debugName",void 0),c([x({readOnly:!0})],Dc.prototype,"updating",null),Dc=c([k("esri.view.2d.layers.support.UpdateTracking2D")],Dc);export{Ue as $,mo as A,bi as B,fn as C,yo as D,Ur as E,gr as F,pn as G,dn as H,Ki as I,Hn as J,er as K,ti as L,Le as M,Ge as N,di as O,Qi as P,ji as Q,Sr as R,hn as S,qi as T,un as U,xi as V,_i as W,ui as X,gi as Y,ir as Z,Ui as _,Wi as a,Or as a0,Rr as a1,je as a2,$r as a3,$n as a4,Qn as a5,Jn as a6,vn as a7,zr as a8,Cr as a9,mi as aA,kr as aB,En as aC,xr as aD,Pc as aE,Li as aF,Do as aG,Bo as aH,Go as aI,Ye as aJ,gt as aK,jr as aa,Hr as ab,Xr as ac,Yr as ad,Lr as ae,ss as af,ns as ag,no as ah,qr as ai,yi as aj,ki as ak,ur as al,pi as am,ni as an,eo as ao,Jr as ap,wr as aq,ts as ar,es as as,qe as at,rr as au,Ar as av,Tr as aw,Be as ax,ei as ay,We as az,Yi as b,Ji as c,Dc as d,zi as e,Si as f,Ni as g,dr as h,Zi as i,ln as j,vi as k,ce as l,mr as m,wt as n,yr as o,Cn as p,wi as q,hr as r,Ci as s,zn as t,Pr as u,Vr as v,Ic as w,Hi as x,$o as y,ao as z};
//# sourceMappingURL=p-ffa11fc1.js.map