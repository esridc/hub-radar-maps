import{m as n}from"./p-1cf43261.js";import{a as e,t,l as r,B as o,N as i,b as s,r as a,G as l,d as f,ar as u,X as c,S as m,y as w,U as p,H as d,a0 as E,Q as y,I as h,h as N,D as b,as as $,at as D,a5 as A,T as I,au as x,av as L}from"./p-2b5b515f.js";import{e as g,j as T,q as j,f as F,c as M,a as S,b as O,d as k,g as C,k as H,F as z,A as R,B as G,h as U,i as W,L as v,I as _}from"./p-722e0867.js";import{t as B}from"./p-7db7fa08.js";import{l as P}from"./p-f47e14f9.js";import{u as J,D as K}from"./p-dcd5924c.js";import{cL as V,hC as Z,eH as q,hD as Q}from"./p-3013819f.js";import{x as X}from"./p-a20ea8a0.js";import"./p-4953a39e.js";import"./p-ec95a4fb.js";import"./p-1f0b604e.js";import"./p-347800d3.js";import"./p-94b15954.js";import"./p-701ca298.js";import"./p-3b51db5e.js";import"./p-c2c5c63d.js";import"./p-8b19323a.js";import"./p-71d25f62.js";import"./p-a71453e3.js";import"./p-ad726e47.js";import"./p-72299f2e.js";import"./p-1d19bd96.js";import"./p-d9641be7.js";import"./p-bc6b9750.js";function Y(n,e,t,r){if(1===r.length){if(p(r[0]))return L(n,r[0],-1);if(y(r[0]))return L(n,r[0].toArray(),-1)}return L(n,r,-1)}async function nn(n,e,t){const r=n.getVariables();if(r.length>0){const o=[];for(let n=0;n<r.length;n++){const i={name:r[n]};o.push(await e.evaluateIdentifier(t,i))}const i={};for(let n=0;n<r.length;n++)i[r[n]]=o[n];return n.parameters=i,n}return n}function en(n,e,t=null){for(const t in n)if(t.toLowerCase()===e.toLowerCase())return n[t];return t}function tn(n){if(null===n)return null;const e={type:en(n,"type",""),name:en(n,"name","")};if("range"===e.type)e.range=en(n,"range",[]);else{e.codedValues=[];for(const t of en(n,"codedValues",[]))e.codedValues.push({name:en(t,"name",""),code:en(t,"code",null)})}return e}function rn(n){if(null===n)return null;const e={},t=en(n,"wkt",null);null!==t&&(e.wkt=t);const r=en(n,"wkid",null);return null!==r&&(e.wkid=r),e}function on(n){if(null===n)return null;const e={hasZ:en(n,"hasz",!1),hasM:en(n,"hasm",!1)},t=en(n,"spatialreference",null);t&&(e.spatialReference=rn(t));const r=en(n,"x",null);if(null!==r)return e.x=r,e.y=en(n,"y",null),e.hasZ&&(e.z=en(n,"z",null)),e.hasM&&(e.m=en(n,"m",null)),e;const o=en(n,"rings",null);if(null!==o)return e.rings=o,e;const i=en(n,"paths",null);if(null!==i)return e.paths=i,e;const s=en(n,"points",null);if(null!==s)return e.points=s,e;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=en(n,t,null);null!==r&&(e[t]=r)}return e}function sn(n,e){for(const t of e)if(t===n)return!0;return!1}function an(n){return!!n.layerDefinition&&(!!n.featureSet&&(!1!==sn(n.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(!1!==p(n.layerDefinition.fields)&&!1!==p(n.featureSet.features))))}function ln(n){return"utc"===n?.toLowerCase()?"UTC":"unknown"===n?.toLowerCase()?"Unknown":n}function fn(L){"async"===L.mode&&(L.functions.timezone=function(c,m){return L.standardFunctionAsync(c,m,(async(w,p,d)=>{if(e(d,1,2,c,m),t(d[0]))return"Unknown";if(r(d[0]))return"Unknown";if(o(d[0])){if(await d[0].load(),1===d.length||null===d[1])return d[0].datesInUnknownTimezone?ln("unknown"):ln(d[0].dateFieldsTimeZone);if(!(d[1]instanceof i)||!1===d[1].hasField("type"))throw new s(c,a.InvalidParameter,m);const n=d[1].field("type");if(!1===l(n))throw new s(c,a.InvalidParameter,m);switch(f(n).toLowerCase()){case"preferredtimezone":return ln(d[0].preferredTimeZone);case"editfieldsinfo":return ln(d[0].editFieldsInfo?.timeZone??null);case"timeinfo":return ln(d[0].timeInfo?.timeZone??null);case"field":if(d[1].hasField("fieldname")&&l(d[1].field("fieldname")))return ln(d[0].fieldTimeZone(f(d[1].field("fieldname"))))}throw new s(c,a.InvalidParameter,m)}const E=u(d[0],I(c));if(null===E)return null;const y=E.timeZone;return"system"===y?n.systemTimeZoneCanonicalName:"utc"===y.toLowerCase()?"UTC":"unknown"===y.toLowerCase()?"Unknown":y}))},L.functions.sqltimestamp=function(n,t){return L.standardFunctionAsync(n,t,(async(i,l,u)=>{e(u,1,3,n,t);const m=u[0];if(c(m)){if(1===u.length)return m.toSQLWithKeyword();if(2===u.length)return m.changeTimeZone(f(u[1])).toSQLWithKeyword();throw new s(n,a.InvalidParameter,t)}if(r(m))return m.toSQLWithKeyword();if(o(m)){if(3!==u.length)throw new s(n,a.InvalidParameter,t);await m.load();const e=f(u[1]);if(r(u[2]))return u[2].toSQLWithKeyword();if(!1===c(u[2]))throw new s(n,a.InvalidParameter,t);const o=m.fieldTimeZone(e);return null===o?u[2].toSQLWithKeyword():u[2].changeTimeZone(o).toSQLWithKeyword()}throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"sqltimestamp",min:2,max:4}),L.functions.featuresetbyid=function(n,t){return L.standardFunctionAsync(n,t,((r,o,i)=>{if(e(i,2,4,n,t),i[0]instanceof g){const e=f(i[1]);let r=w(i[2],null);const o=m(w(i[3],!0));if(null===r&&(r=["*"]),!1===p(r))throw new s(n,a.InvalidParameter,t);return i[0].featureSetById(e,o,r)}throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"featuresetbyid",min:2,max:4}),L.functions.getfeatureset=function(n,t){return L.standardFunctionAsync(n,t,((r,o,i)=>{if(e(i,1,2,n,t),d(i[0])){let e=w(i[1],"datasource");return null===e&&(e="datasource"),e=f(e).toLowerCase(),T(i[0].fullSchema(),e,n.lrucache,n.interceptor,n.spatialReference)}throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"getfeatureset",min:1,max:2}),L.functions.featuresetbyportalitem=function(n,t){return L.standardFunctionAsync(n,t,((r,o,i)=>{if(e(i,2,5,n,t),null===i[0])throw new s(n,a.PortalRequired,t);if(i[0]instanceof E){const e=f(i[1]),r=f(i[2]);let o=w(i[3],null);const l=m(w(i[4],!0));if(null===o&&(o=["*"]),!1===p(o))throw new s(n,a.InvalidParameter,t);let u=null;return u=n.services?.portal?n.services.portal:V.getDefault(),u=P(i[0],u),j(e,r,n.spatialReference,o,l,u,n.lrucache,n.interceptor)}if(!1===l(i[0]))throw new s(n,a.PortalRequired,t);const u=f(i[0]),c=f(i[1]);let d=w(i[2],null);const y=m(w(i[3],!0));if(null===d&&(d=["*"]),!1===p(d))throw new s(n,a.InvalidParameter,t);return j(u,c,n.spatialReference,d,y,n.services?.portal??V.getDefault(),n.lrucache,n.interceptor)}))},L.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),L.functions.featuresetbyname=function(n,t){return L.standardFunctionAsync(n,t,((r,o,i)=>{if(e(i,2,4,n,t),i[0]instanceof g){const e=f(i[1]);let r=w(i[2],null);const o=m(w(i[3],!0));if(null===r&&(r=["*"]),!1===p(r))throw new s(n,a.InvalidParameter,t);return i[0].featureSetByName(e,o,r)}throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"featuresetbyname",min:2,max:4}),L.functions.featureset=function(n,t){return L.standardFunction(n,t,((r,o,f)=>{e(f,1,1,n,t);let u=f[0];const c={layerDefinition:{geometryType:"",objectIdField:"",hasM:!1,hasZ:!1,globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(l(u))u=JSON.parse(u),void 0!==u.layerDefinition?(c.layerDefinition=u.layerDefinition,c.featureSet=u.featureSet,u.layerDefinition.spatialReference&&(c.layerDefinition.spatialReference=u.layerDefinition.spatialReference)):(c.featureSet.features=u.features,c.featureSet.geometryType=u.geometryType,c.layerDefinition.geometryType=c.featureSet.geometryType,c.layerDefinition.objectIdField=u.objectIdFieldName??"",c.layerDefinition.typeIdField=u.typeIdFieldName,c.layerDefinition.globalIdField=u.globalIdFieldName,c.layerDefinition.fields=u.fields,u.spatialReference&&(c.layerDefinition.spatialReference=u.spatialReference));else{if(!(f[0]instanceof i))throw new s(n,a.InvalidParameter,t);{u=JSON.parse(f[0].castToText(!0));const n=en(u,"layerdefinition");if(null!==n){c.layerDefinition.geometryType=en(n,"geometrytype",""),c.featureSet.geometryType=c.layerDefinition.geometryType,c.layerDefinition.globalIdField=en(n,"globalidfield",""),c.layerDefinition.objectIdField=en(n,"objectidfield",""),c.layerDefinition.typeIdField=en(n,"typeidfield",""),c.layerDefinition.hasZ=!0===en(n,"hasz",!1),c.layerDefinition.hasM=!0===en(n,"hasm",!1);const e=en(n,"spatialreference",null);e&&(c.layerDefinition.spatialReference=rn(e));for(const e of en(n,"fields",[])){const n={name:en(e,"name",""),alias:en(e,"alias",""),type:en(e,"type",""),nullable:en(e,"nullable",!0),editable:en(e,"editable",!0),length:en(e,"length",null),domain:tn(en(e,"domain"))};c.layerDefinition.fields.push(n)}const t=en(u,"featureset",null);if(t){const n={};for(const e of c.layerDefinition.fields)n[e.name.toLowerCase()]=e.name;for(const e of en(t,"features",[])){const t={},r=en(e,"attributes",{});for(const e in r)t[n[e.toLowerCase()]]=r[e];c.featureSet.features.push({attributes:t,geometry:on(en(e,"geometry",null))})}}}else{c.layerDefinition.hasZ=!0===en(u,"hasz",!1),c.layerDefinition.hasM=!0===en(u,"hasm",!1),c.layerDefinition.geometryType=en(u,"geometrytype",""),c.featureSet.geometryType=c.layerDefinition.geometryType,c.layerDefinition.objectIdField=en(u,"objectidfieldname",""),c.layerDefinition.typeIdField=en(u,"typeidfieldname","");const n=en(u,"spatialreference",null);n&&(c.layerDefinition.spatialReference=rn(n));let e=en(u,"fields",null);if(p(e))for(const n of e){const e={name:en(n,"name",""),alias:en(n,"alias",""),type:en(n,"type",""),nullable:en(n,"nullable",!0),editable:en(n,"editable",!0),length:en(n,"length",null),domain:tn(en(n,"domain"))};c.layerDefinition.fields.push(e)}else e=null,c.layerDefinition.fields=e;const t={};for(const n of c.layerDefinition.fields)t[n.name.toLowerCase()]=n.name;let r=en(u,"features",null);if(p(r))for(const n of r){const e={},r=en(n,"attributes",{});for(const n in r)e[t[n.toLowerCase()]]=r[n];c.featureSet.features.push({attributes:e,geometry:on(en(n,"geometry",null))})}else r=null,c.featureSet.features=r}}}if(!1===an(c))throw new s(n,a.InvalidParameter,t);return c.layerDefinition.geometryType||(c.layerDefinition.geometryType="esriGeometryNull"),F.create(c,n.spatialReference)}))},L.signatures.push({name:"featureset",min:1,max:1}),L.functions.filter=function(n,t){return L.standardFunctionAsync(n,t,(async(r,i,l)=>{if(e(l,2,2,n,t),p(l[0])||y(l[0])){const e=[];let r=l[0];r instanceof B&&(r=r.toArray());let o=null;if(!h(l[1]))throw new s(n,a.InvalidParameter,t);o=l[1].createFunction(n);for(const n of r){const t=o(n);Z(t)?!0===await t&&e.push(n):!0===t&&e.push(n)}return e}if(o(l[0])){const e=await l[0].load(),t=X.create(l[1],e.getFieldsIndex(),e.dateFieldsTimeZoneDefaultUTC),r=t.getVariables();if(r.length>0){const e=[];for(let t=0;t<r.length;t++){const o={name:r[t]};e.push(await L.evaluateIdentifier(n,o))}const o={};for(let n=0;n<r.length;n++)o[r[n]]=e[n];return t.parameters=o,new M({parentfeatureset:l[0],whereclause:t})}return new M({parentfeatureset:l[0],whereclause:t})}throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"filter",min:2,max:2}),L.functions.orderby=function(n,t){return L.standardFunctionAsync(n,t,(async(r,i,l)=>{if(e(l,2,2,n,t),o(l[0])){const n=new S(l[1]);return new O({parentfeatureset:l[0],orderbyclause:n})}throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"orderby",min:2,max:2}),L.functions.top=function(n,t){return L.standardFunctionAsync(n,t,(async(r,i,l)=>{if(e(l,2,2,n,t),o(l[0]))return new k({parentfeatureset:l[0],topnum:l[1]});if(p(l[0]))return N(l[1])>=l[0].length?l[0].slice(0):l[0].slice(0,N(l[1]));if(y(l[0]))return N(l[1])>=l[0].length()?l[0].slice(0):l[0].slice(0,N(l[1]));throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"top",min:2,max:2}),L.functions.first=function(n,t){return L.standardFunctionAsync(n,t,(async(r,i,s)=>{if(e(s,1,1,n,t),o(s[0])){const e=await s[0].first(r.abortSignal);if(null!==e){const t=b.createFromGraphicLikeObject(e.geometry,e.attributes,s[0],n.timeZone);return t._underlyingGraphic=e,t}return e}return p(s[0])?0===s[0].length?null:s[0][0]:y(s[0])?0===s[0].length()?null:s[0].get(0):null}))},L.signatures.push({name:"first",min:1,max:1}),L.functions.attachments=function(n,t){return L.standardFunctionAsync(n,t,(async(r,l,f)=>{e(f,1,2,n,t);const u={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(f.length>1)if(f[1]instanceof i){if(f[1].hasField("minsize")&&(u.minsize=N(f[1].field("minsize"))),f[1].hasField("metadata")&&(u.returnMetadata=m(f[1].field("metadata"))),f[1].hasField("maxsize")&&(u.maxsize=N(f[1].field("maxsize"))),f[1].hasField("types")){const n=$(f[1].field("types"),!1);n.length>0&&(u.types=n)}}else if(null!==f[1])throw new s(n,a.InvalidParameter,t);if(d(f[0])){let e=f[0]._layer;return e instanceof q&&(e=C(e,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===e?[]:!1===o(e)?[]:(await e.load(),e.queryAttachments(f[0].field(e.objectIdField),u.minsize,u.maxsize,u.types,u.returnMetadata))}if(null===f[0])return[];throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"attachments",min:1,max:2}),L.functions.featuresetbyrelationshipname=function(n,t){return L.standardFunctionAsync(n,t,(async(r,i,l)=>{e(l,2,4,n,t);const u=l[0],c=f(l[1]);let E=w(l[2],null);const y=m(w(l[3],!0));if(null===E&&(E=["*"]),!1===p(E))throw new s(n,a.InvalidParameter,t);if(null===l[0])return null;if(!d(l[0]))throw new s(n,a.InvalidParameter,t);let h=u._layer;if(h instanceof q&&(h=C(h,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===h)return null;if(!1===o(h))return null;h=await h.load();const N=h.relationshipMetaData().filter((n=>n.name===c));if(0===N.length)return null;if(void 0!==N[0].relationshipTableId&&null!==N[0].relationshipTableId&&N[0].relationshipTableId>-1)return H(h,N[0],u.field(h.objectIdField),h.spatialReference,E,y,n.lrucache,n.interceptor);let b=h.serviceUrl();if(!b)return null;b="/"===b.charAt(b.length-1)?b+N[0].relatedTableId.toString():b+"/"+N[0].relatedTableId.toString();const $=await z(b,h.spatialReference,E,y,n.lrucache,n.interceptor);await $.load();let D=$.relationshipMetaData();if(D=D.filter((n=>n.id===N[0].id)),!1===u.hasField(N[0].keyField)||null===u.field(N[0].keyField)){const n=await h.getFeatureByObjectId(u.field(h.objectIdField),[N[0].keyField]);if(n){const e=X.create(D[0].keyField+"= @id",$.getFieldsIndex(),$.dateFieldsTimeZoneDefaultUTC);return e.parameters={id:n.attributes[N[0].keyField]},$.filter(e)}return new J({parentfeatureset:$})}const A=X.create(D[0].keyField+"= @id",$.getFieldsIndex(),$.dateFieldsTimeZoneDefaultUTC);return A.parameters={id:u.field(N[0].keyField)},$.filter(A)}))},L.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),L.functions.featuresetbyassociation=function(n,t){return L.standardFunctionAsync(n,t,(async(r,i,u)=>{e(u,2,3,n,t);const c=u[0],m=f(w(u[1],"")).toLowerCase(),p=l(u[2])?f(u[2]):null;if(null===u[0])return null;if(!d(u[0]))throw new s(n,a.InvalidParameter,t);let E=c._layer;if(E instanceof q&&(E=C(E,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===E)return null;if(!1===o(E))return null;await E.load();const y=E.serviceUrl(),h=await R(y,n.spatialReference);let N=null,b=null,$=!1;if(null!==p&&""!==p&&void 0!==p){for(const n of h.terminals)n.terminalName===p&&(b=n.terminalId);null===b&&($=!0)}const I=h.associations.getFieldsIndex(),x=I.get("TOGLOBALID").name,L=I.get("FROMGLOBALID").name,g=I.get("TOTERMINALID").name,T=I.get("FROMTERMINALID").name,j=I.get("FROMNETWORKSOURCEID").name,F=I.get("TONETWORKSOURCEID").name,M=I.get("ASSOCIATIONTYPE").name,S=I.get("ISCONTENTVISIBLE").name,O=I.get("OBJECTID").name;for(const n of E.fields)if("global-id"===n.type){N=c.field(n.name);break}let k=null,H=new G(new Q({name:"percentalong",alias:"percentalong",type:"double"}),X.create("0",h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC)),z=new G(new Q({name:"side",alias:"side",type:"string"}),X.create("''",h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC));const B="globalid",P="globalId",J={};for(const n in h.lkp)J[n]=h.lkp[n].sourceId;const K=new U(new Q({name:"classname",alias:"classname",type:"string"}),null,J);let V="";switch(m){case"midspan":{V=`((${x}='${N}') OR ( ${L}='${N}')) AND (${M} IN (5))`,K.codefield=X.create(`CASE WHEN (${x}='${N}') THEN ${j} ELSE ${F} END`,h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC);const n=A(v.findField(h.associations.fields,L));n.name=B,n.alias=B,k=new G(n,X.create(`CASE WHEN (${L}='${N}') THEN ${x} ELSE ${L} END`,h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC)),H=h.unVersion>=4?new _(v.findField(h.associations.fields,I.get("PERCENTALONG").name)):new G(new Q({name:"percentalong",alias:"percentalong",type:"double"}),X.create("0",h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC));break}case"junctionedge":{V=`((${x}='${N}') OR ( ${L}='${N}')) AND (${M} IN (4,6))`,K.codefield=X.create(`CASE WHEN (${x}='${N}') THEN ${j} ELSE ${F} END`,h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC);const n=A(v.findField(h.associations.fields,L));n.name=B,n.alias=B,k=new G(n,X.create(`CASE WHEN (${L}='${N}') THEN ${x} ELSE ${L} END`,h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC)),z=new G(new Q({name:"side",alias:"side",type:"string"}),X.create(`CASE WHEN (${M}=4) THEN 'from' ELSE 'to' END`,h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC));break}case"connected":{let n=`${x}='@T'`,e=`${L}='@T'`;null!==b&&(n+=` AND ${g}=@A`,e+=` AND ${T}=@A`),V="(("+n+") OR ("+e+"))",V=D(V,"@T",N??""),n=D(n,"@T",N??""),null!==b&&(n=D(n,"@A",b.toString()),V=D(V,"@A",b.toString())),K.codefield=X.create("CASE WHEN "+n+` THEN ${j} ELSE ${F} END`,h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC);const t=A(v.findField(h.associations.fields,L));t.name=B,t.alias=B,k=new G(t,X.create("CASE WHEN "+n+` THEN ${L} ELSE ${x} END`,h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC));break}case"container":V=`${x}='${N}' AND ${M} = 2`,null!==b&&(V+=` AND ${g} = `+b.toString()),K.codefield=j,V="( "+V+" )",k=new W(v.findField(h.associations.fields,L),B,B);break;case"content":V=`(${L}='${N}' AND ${M} = 2)`,null!==b&&(V+=` AND ${T} = `+b.toString()),K.codefield=F,V="( "+V+" )",k=new W(v.findField(h.associations.fields,x),B,B);break;case"structure":V=`(${x}='${N}' AND ${M} = 3)`,null!==b&&(V+=` AND ${g} = `+b.toString()),K.codefield=j,V="( "+V+" )",k=new W(v.findField(h.associations.fields,L),B,P);break;case"attached":V=`(${L}='${N}' AND ${M} = 3)`,null!==b&&(V+=` AND ${T} = `+b.toString()),K.codefield=F,V="( "+V+" )",k=new W(v.findField(h.associations.fields,x),B,P);break;default:throw new s(n,a.InvalidParameter,t)}$&&(V="1 <> 1");return new v({parentfeatureset:h.associations,adaptedFields:[new _(v.findField(h.associations.fields,O)),new _(v.findField(h.associations.fields,S)),k,z,K,H],extraFilter:V?X.create(V,h.associations.getFieldsIndex(),h.associations.dateFieldsTimeZoneDefaultUTC):null})}))},L.signatures.push({name:"featuresetbyassociation",min:2,max:6}),L.functions.groupby=function(n,t){return L.standardFunctionAsync(n,t,(async(r,u,c)=>{if(e(c,3,3,n,t),!o(c[0]))throw new s(n,a.InvalidParameter,t);const m=await c[0].load(),w=[],d=[];let E=!1,h=[];if(l(c[1]))h.push(c[1]);else if(c[1]instanceof i)h.push(c[1]);else if(p(c[1]))h=c[1];else{if(!y(c[1]))throw new s(n,a.InvalidParameter,t);h=c[1].toArray()}for(const e of h)if(l(e)){const n=X.create(f(e),m.getFieldsIndex(),m.dateFieldsTimeZoneDefaultUTC),t=!0===K(n)?f(e):"%%%%FIELDNAME";w.push({name:t,expression:n}),"%%%%FIELDNAME"===t&&(E=!0)}else{if(!(e instanceof i))throw new s(n,a.InvalidParameter,t);{const r=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",o=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===r&&(E=!0),!r)throw new s(n,a.InvalidParameter,t);w.push({name:r,expression:X.create(o||r,m.getFieldsIndex(),m.dateFieldsTimeZoneDefaultUTC)})}}if(h=[],l(c[2]))h.push(c[2]);else if(p(c[2]))h=c[2];else if(y(c[2]))h=c[2].toArray();else{if(!(c[2]instanceof i))throw new s(n,a.InvalidParameter,t);h.push(c[2])}for(const e of h){if(!(e instanceof i))throw new s(n,a.InvalidParameter,t);{const r=e.hasField("name")?e.field("name"):"",o=e.hasField("statistic")?e.field("statistic"):"",i=e.hasField("expression")?e.field("expression"):"";if(!r||!o||!i)throw new s(n,a.InvalidParameter,t);d.push({name:r,statistic:o.toLowerCase(),expression:X.create(i,m.getFieldsIndex(),m.dateFieldsTimeZoneDefaultUTC)})}}if(E){const n={};for(const e of m.fields)n[e.name.toLowerCase()]=1;for(const e of w)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);for(const e of d)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);let e=0;for(const t of w)if("%%%%FIELDNAME"===t.name){for(;1===n["field_"+e.toString()];)e++;n["field_"+e.toString()]=1,t.name="FIELD_"+e.toString()}}for(const e of w)await nn(e.expression,L,n);for(const e of d)await nn(e.expression,L,n);return c[0].groupby(w,d)}))},L.signatures.push({name:"groupby",min:3,max:3}),L.functions.distinct=function(n,t){return L.standardFunctionAsync(n,t,(async(r,u,c)=>{if(o(c[0])){e(c,2,2,n,t);const r=await c[0].load(),o=[];let u=[];if(l(c[1]))u.push(c[1]);else if(c[1]instanceof i)u.push(c[1]);else if(p(c[1]))u=c[1];else{if(!y(c[1]))throw new s(n,a.InvalidParameter,t);u=c[1].toArray()}let m=!1;for(const e of u)if(l(e)){const n=X.create(f(e),r.getFieldsIndex(),r.dateFieldsTimeZoneDefaultUTC),t=!0===K(n)?f(e):"%%%%FIELDNAME";o.push({name:t,expression:n}),"%%%%FIELDNAME"===t&&(m=!0)}else{if(!(e instanceof i))throw new s(n,a.InvalidParameter,t);{const i=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",l=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===i&&(m=!0),!i)throw new s(n,a.InvalidParameter,t);o.push({name:i,expression:X.create(l||i,r.getFieldsIndex(),r.dateFieldsTimeZoneDefaultUTC)})}}if(m){const n={};for(const e of r.fields)n[e.name.toLowerCase()]=1;for(const e of o)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);let e=0;for(const t of o)if("%%%%FIELDNAME"===t.name){for(;1===n["field_"+e.toString()];)e++;n["field_"+e.toString()]=1,t.name="FIELD_"+e.toString()}}for(const e of o)await nn(e.expression,L,n);return c[0].groupby(o,[])}return Y("distinct",r,u,c)}))}),L.functions.getfeaturesetinfo=function(n,t){return L.standardFunctionAsync(n,t,(async(r,s,a)=>{if(e(a,1,1,n,t),!o(a[0]))return null;const l=await a[0].getFeatureSetInfo();return l?i.convertObjectToArcadeDictionary({layerId:l.layerId,layerName:l.layerName,itemId:l.itemId,serviceLayerUrl:l.serviceLayerUrl,webMapLayerId:l.webMapLayerId??null,webMapLayerTitle:l.webMapLayerTitle??null,className:null,objectClassId:null},I(n),!1,!1):null}))},L.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),L.functions.filterbysubtypecode=function(n,t){return L.standardFunctionAsync(n,t,(async(r,i,l)=>{if(e(l,2,2,n,t),o(l[0])){const e=await l[0].load(),r=l[1];if(!x(r))throw new s(n,a.InvalidParameter,t);if(e.subtypeField){const n=X.create(`${e.subtypeField}= ${l[1]}`,e.getFieldsIndex(),e.dateFieldsTimeZoneDefaultUTC);return new M({parentfeatureset:l[0],whereclause:n})}if(null===e.typeIdField||""===e.typeIdField)throw new s(n,a.FeatureSetDoesNotHaveSubtypes,t);const o=X.create(`${e.typeIdField}= ${l[1]}`,e.getFieldsIndex(),e.dateFieldsTimeZoneDefaultUTC);return new M({parentfeatureset:l[0],whereclause:o})}throw new s(n,a.InvalidParameter,t)}))},L.signatures.push({name:"filterbysubtypecode",min:2,max:2})}export{fn as registerFunctions};
//# sourceMappingURL=p-52afa38d.js.map